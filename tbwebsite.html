<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TangailBuzz - Online Shopping</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS custom theme configuration
        tailwind.config = {
            // ENABLE DARK MODE VIA CLASS TOGGLE
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3a86ff',
                        secondary: '#ff006e',
                        accent: '#8338ec',
                        light: '#f8f9fa',
                        dark: '#212529',
                        success: '#28a745',
                        'theme-purple': '#6a0dad',
                        'theme-pink': '#e5367a',
                        'theme-blue': '#4a7bed',
                        'theme-light': '#f5f7fa',
                        'price-black': '#000000',
                    },
                    fontFamily: {
                        sans: ['Poppins', 'Noto Sans Bengali', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 1s ease-in-out',
                        'slide-in-up': 'slideInUp 0.8s ease-out',
                        'spin': 'spin 1s linear infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: 0 },
                            '100%': { opacity: 1 },
                        },
                        slideInUp: {
                            '0%': { transform: 'translateY(20px)', opacity: 0 },
                            '100%': { transform: 'translateY(0)', opacity: 1 },
                        },
                          spin: {
                            '0%': { transform: 'rotate(0deg)' },
                            '100%': { transform: 'rotate(360deg)' },
                        }
                    },
                }
            }
        }
    </script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF for invoice generation (Placeholder - implementation pending) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

    <style>
        /* Custom styles for toast notifications and other minor tweaks */
        #toast-notification {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }
        /* Global responsive media and overflow fixes for mobile */
        html, body {
            overflow-x: hidden;
        }
        img, video {
            max-width: 100%;
            height: auto;
        }
        .variant-btn-active {
            border-color: #3a86ff !important;
            background-color: #e0eaff !important;
            color: #3a86ff !important;
            font-weight: 600 !important;
        }
        .color-variant-active {
            box-shadow: 0 0 0 2px #fff, 0 0 0 4px #3a86ff; /* Custom ring effect */
        }
        /* Simple loader */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        .loader-small {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        .active-lang {
            text-decoration: underline;
            text-underline-offset: 4px;
            color: #f8f9fa;
        }
        /* Drawer & Modal Styles */
        .drawer-overlay, .modal-overlay {
            transition: opacity 0.3s ease-in-out;
        }
        .drawer {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        .drawer.left {
             transform: translateX(-100%);
        }
        .drawer.active {
            transform: translateX(0);
        }
        /* CSS variables used by JS for image zoom */
        #product-image-container:hover #product-image {
            transform-origin: var(--x-pos) var(--y-pos);
            transform: scale(2);
        }

        /* Dark mode text contrast fixes */
        .text-dark { color: #111827; }
        .text-price-black { color: #111827; }
        html.dark .text-dark { color: #e5e7eb !important; }
        html.dark .text-price-black { color: #f3f4f6 !important; }
        html.dark .text-black { color: #f3f4f6 !important; }
        html.dark .text-gray-900 { color: #f3f4f6 !important; }
        html.dark .text-gray-800 { color: #e5e7eb !important; }

        /* Custom CSS for Progress Tracker (Final Fix for Image Alignment) */
        /* Core Flex Container */
        .tracker-step-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0 10px; /* Small padding inside the card to push start/end points slightly from edge */
        }
        /* Style for the space between nodes (which holds the line) */
        .tracker-connector {
            flex-grow: 1; /* Takes all remaining space */
            display: flex;
            align-items: center;
            justify-content: center; /* Center the line element */
            height: 32px; /* Maintain vertical space */
            margin-top: 12px; /* Align with circle top margin */
        }
        .tracker-connector-line {
            height: 4px;
            width: 100%; /* Line fills connector space */
            background-color: #d1d5db; /* Grey line */
        }
        .tracker-connector.active .tracker-connector-line {
            background-color: #34d399; /* Green line */
        }
        
        /* Style for the nodes (circles and text) */
        .tracker-node {
            position: relative;
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
            text-align: center;
            /* Use a fixed, small width for each step to control spacing */
            width: 70px; 
            /* Push the text label slightly left/right for first/last node labels to align them under the circle */
        }
        .tracker-circle {
            width: 32px;
            height: 32px;
            margin-top: 12px;
        }
        .rating-star:hover, .rating-star.selected {
            color: #fca311; /* Amber/Yellow for selection/hover */
        }
        /* Mobile-friendly vertical tracker layout */
        @media (max-width: 640px) {
            .tracker-step-container {
                flex-direction: column;
                align-items: stretch;
                padding: 0 6px;
            }
            .tracker-node {
                width: auto;
                flex-direction: row;
                align-items: center;
                gap: 8px;
                text-align: left;
            }
            .tracker-circle {
                width: 28px;
                height: 28px;
                margin-top: 4px;
            }
            .tracker-node p {
                margin: 0;
                font-size: 11px;
            }
            .tracker-connector {
                width: 4px;
                height: 32px;
                margin: 4px 0 4px 14px; /* align under the circle */
                justify-content: flex-start;
            }
            .tracker-connector-line {
                width: 4px;
                height: 100%;
            }
        }
        
    </style>
</head>
<body class="bg-theme-light text-dark font-sans leading-relaxed transition-colors duration-300 dark:bg-gray-900 dark:text-gray-100">
    
    <!-- Blocked User Banner -->
    <div id="blocked-account-banner" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white text-center p-3 z-[9999] font-semibold"></div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed top-20 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl z-[200] transform translate-x-[150%] opacity-0">
        <p id="toast-message">Item added to cart!</p>
    </div>

    <!-- Variant Selection Modal (for product cards) -->
    <div id="variant-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-[115] hidden items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-theme-purple" data-lang="select-variants">Select Options</h3>
                <button onclick="closeVariantModal()" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <div id="variant-modal-product" class="flex items-center gap-3 mb-4">
                <img id="vm-product-image" class="w-14 h-14 rounded-xl object-cover" src="" alt="" onerror="this.onerror=null;this.src='https://placehold.co/80x80/ccc/000?text=Image';">
                <div class="min-w-0">
                    <div id="vm-product-name" class="text-sm font-semibold text-theme-purple truncate"></div>
                    <div id="vm-product-price" class="text-xs text-gray-500"></div>
                </div>
            </div>
            <div id="variant-modal-options" class="space-y-4">
                <div id="vm-size-options" class="hidden">
                    <label class="block text-sm font-semibold mb-2" data-lang="size">Size:</label>
                    <div class="flex flex-wrap gap-2" id="vm-size-variants-container"></div>
                </div>
                <div id="vm-storage-options" class="hidden">
                    <label class="block text-sm font-semibold mb-2" data-lang="storage">Storage:</label>
                    <div class="flex flex-wrap gap-2" id="vm-storage-variants-container"></div>
                </div>
                <div id="vm-color-options" class="hidden">
                    <label class="block text-sm font-semibold mb-2" data-lang="color">Color:</label>
                    <div class="flex flex-wrap gap-2" id="vm-color-variants-container"></div>
                </div>
            </div>
            <div class="mt-6 grid grid-cols-2 gap-2">
                <button id="vm-add-btn" class="w-full bg-theme-blue text-white py-2 rounded-full font-bold hover:bg-theme-purple transition-colors" data-lang="add-to-cart">Add to Cart</button>
                <button id="vm-buy-btn" class="w-full bg-white border border-theme-blue text-theme-blue py-2 rounded-full font-bold hover:bg-gray-100 transition-colors" data-lang="buy-now">Buy Now</button>
            </div>
        </div>
    </div>


    <!-- Header Section -->
    <header class="bg-gradient-to-r from-theme-blue to-theme-purple text-white py-4 sticky top-0 z-40 shadow-2xl">
        <div class="container mx-auto px-4 flex items-center justify-between">
            <!-- Left side: Hamburger (mobile) and Logo -->
            <div class="flex items-center space-x-4">
                 <!-- Hamburger Menu for Mobile -->
                <button id="hamburger-btn" class="md:hidden text-2xl">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="flex items-center text-3xl font-bold transform hover:scale-105 transition-transform cursor-pointer" onclick="renderAllProducts()">
                    <img src="https://raw.githubusercontent.com/tangailbuzzbd-svg/TangailBuzz-Picture-/main/MD%20EOUSUF%20ALI%20BACK-1_upscaled.png" alt="TangailBuzz Logo" class="h-12 w-auto mr-2">
                    <span class="hidden sm:inline">TangailBuzz</span>
                </div>
            </div>

            <!-- Center: Navigation (Desktop) -->
            <nav class="hidden md:flex">
                <ul class="flex items-center space-x-6">
                    <li><a href="javascript:void(0);" onclick="renderAllProducts()" class="text-white hover:text-theme-pink font-semibold transition-colors" data-lang="home">‡¶π‡ßã‡¶Æ</a></li>
                    <li><a href="#products" onclick="showPage('home-page'); scrollToElement('products')" class="text-white hover:text-theme-pink font-semibold transition-colors" data-lang="products">‡¶™‡¶£‡ßç‡¶Ø</a></li>
                    <li><a href="#categories" onclick="showPage('home-page'); scrollToElement('categories')" class="text-white hover:text-theme-pink font-semibold transition-colors" data-lang="categories">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</a></li>
                    <li><a href="javascript:void(0);" onclick="showOffers()" class="text-white hover:text-theme-pink font-semibold transition-colors" data-lang="offers">‡¶Ö‡¶´‡¶æ‡¶∞</a></li>
                </ul>
            </nav>

            <!-- Right side: Actions -->
            <div class="flex items-center space-x-2 sm:space-x-4">
                <!-- Search -->
                <div class="hidden md:block relative flex-grow md:flex-grow-0">
                    <div class="flex items-stretch rounded-full overflow-hidden shadow-md bg-white dark:bg-gray-900">
                        <input type="text" id="search-input" placeholder="‡¶™‡¶£‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="flex-1 min-w-0 px-4 py-2 outline-none focus:ring-2 focus:ring-theme-pink bg-transparent text-sm text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-400">
                        <button id="search-button" class="px-4 bg-theme-pink text-white hover:bg-theme-purple transition-colors shrink-0">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <!-- Live search results (desktop) -->
                    <div id="search-results-desktop" class="absolute top-full left-0 w-full bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 shadow-lg rounded-b-lg z-50 overflow-hidden hidden max-h-80 overflow-y-auto"></div>
                </div>

                <!-- Language Selector (Professional Dropdown) -->
                <div class="relative" id="lang-selector">
                    <button id="lang-button" class="flex items-center gap-2 px-3 py-1.5 rounded-full border border-white/40 bg-white/10 hover:bg-white/20 text-white text-sm font-semibold backdrop-blur transition-colors" aria-haspopup="true" aria-expanded="false" title="Language" aria-label="Language" data-lang-title="language" data-lang-aria-label="language">
                        <i class="fas fa-globe"></i>
                        <span id="lang-current" class="text-white dark:text-white">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</span>
                        <i class="fas fa-chevron-down text-xs opacity-80"></i>
                    </button>
                    <div id="lang-menu" class="hidden absolute right-0 mt-2 w-44 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl overflow-hidden z-50 text-gray-800 dark:text-gray-200">
                        <button class="lang-option w-full text-left px-3 py-2 text-sm flex items-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200" data-lang-value="bn">
                            <span>üáßüá©</span><span>‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ</span>
                        </button>
                        <button class="lang-option w-full text-left px-3 py-2 text-sm flex items-center gap-2 hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-800 dark:text-gray-200" data-lang-value="en">
                            <span>üá¨üáß</span><span>English</span>
                        </button>
                    </div>
                </div>
                
                <!-- Dark Mode Toggle -->
                <button id="dark-mode-toggle" class="text-white text-xl p-2 rounded-full hover:bg-white hover:text-theme-blue transition-colors flex flex-col items-center" aria-label="Toggle Dark Mode" title="Dark Mode" data-lang-title="dark-mode" data-lang-aria-label="dark-mode">
                    <i class="fas fa-sun" id="dark-mode-icon"></i>
                    <span class="hidden md:block text-[10px] leading-3 mt-1 text-white/90" data-lang="dark-mode">Dark Mode</span>
                </button>
                
                <!-- Support (Header) -->
                <div id="emergency-contact-header" class="relative transform hover:scale-110 transition-transform cursor-pointer flex flex-col items-center" title="Support" aria-label="Support" data-lang-title="emergency-contact" data-lang-aria-label="emergency-contact">
                    <i class="fas fa-headset text-white text-2xl"></i>
                    <span class="hidden md:block text-[10px] leading-3 mt-1 text-white/90" data-lang="emergency-contact">Support</span>
                </div>
                
                <div id="profile-icon" class="relative transform hover:scale-110 transition-transform cursor-pointer flex flex-col items-center" onclick="openDrawer('profile-drawer')" title="Profile" aria-label="Profile" data-lang-title="profile" data-lang-aria-label="profile">
                    <i class="fas fa-user-circle text-white text-2xl"></i>
                    <span class="hidden md:block text-[10px] leading-3 mt-1 text-white/90" data-lang="profile">Profile</span>
                </div>
                <div class="relative transform hover:scale-110 transition-transform cursor-pointer flex flex-col items-center" onclick="showPage('wishlist-page')" title="Wishlist" aria-label="Wishlist" data-lang-title="wishlist" data-lang-aria-label="wishlist">
                    <i class="fas fa-heart text-white text-2xl"></i>
                    <span id="wishlist-count-badge" class="absolute -top-2 -right-2 bg-theme-pink text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center hidden">0</span>
                    <span class="hidden md:block text-[10px] leading-3 mt-1 text-white/90" data-lang="wishlist">Wishlist</span>
                </div>
                <div class="relative transform hover:scale-110 transition-transform cursor-pointer flex flex-col items-center" onclick="showPage('cart-page')" title="Cart" aria-label="Cart" data-lang-title="cart-short" data-lang-aria-label="cart-short">
                    <i class="fas fa-shopping-cart text-white text-2xl"></i>
                    <span id="cart-count" class="absolute -top-2 -right-2 bg-theme-pink text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center">0</span>
                    <span class="hidden md:block text-[10px] leading-3 mt-1 text-white/90" data-lang="cart-short">Cart</span>
                </div>
            </div>
        </div>
        <!-- Search bar for mobile -->
        <div class="md:hidden mt-4 px-4">
            <div class="relative w-full">
                <div class="flex items-stretch rounded-full overflow-hidden shadow-md bg-white dark:bg-gray-900">
                    <input type="text" id="search-input-mobile" placeholder="‡¶™‡¶£‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." class="flex-1 min-w-0 px-4 py-2 outline-none focus:ring-2 focus:ring-theme-pink bg-transparent text-sm text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-400">
                    <button id="search-button-mobile" class="px-4 bg-theme-pink text-white hover:bg-theme-purple transition-colors shrink-0">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <!-- Live search results (mobile) -->
                <div id="search-results-mobile" class="absolute top-full left-0 w-full bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-200 shadow-lg rounded-b-lg z-50 overflow-hidden hidden max-h-80 overflow-y-auto"></div>
            </div>
        </div>
    </header>

    <!-- Global Breadcrumb (shown on details page) -->
    <div id="global-breadcrumb" class="hidden border-b border-gray-200 dark:border-gray-800 bg-gray-50/60 dark:bg-gray-900/60">
        <div class="container mx-auto px-4 py-2">
            <nav id="global-breadcrumb-path" class="text-sm flex flex-wrap items-center text-gray-600 dark:text-gray-300 gap-1"></nav>
        </div>
    </div>

    <!-- Drawer Overlay -->
    <div id="drawer-overlay" class="drawer-overlay fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="closeDrawer()"></div>
    
    <!-- Payment Modal -->
    <div id="payment-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-[100] hidden items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-theme-purple" data-lang="payment-method">Select Payment Method</h3>
                <button onclick="closePaymentModal()" class="text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
            </div>
            <!-- Shipping Address Selection -->
            <div id="shipping-address-section" class="mb-6 p-4 border rounded-xl bg-gray-50 dark:bg-gray-900/40">
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-1">Shipping Address</h4>
                        <p id="selected-address-display" class="text-sm text-gray-600 dark:text-gray-300">No address selected</p>
                    </div>
                    <button id="change-address-btn" class="px-3 py-1.5 rounded-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-sm hover:bg-gray-100">Change</button>
                </div>
                <div id="address-select-panel" class="hidden mt-3">
                    <div id="address-select-list" class="space-y-2 max-h-48 overflow-auto"></div>
                    <div class="mt-3 flex gap-2">
                        <button id="use-selected-address-btn" class="w-full px-3 py-2 rounded-full bg-theme-blue text-white font-semibold hover:bg-theme-purple">Use Selected</button>
                        <button id="manage-addresses-shortcut" class="w-full px-3 py-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 font-semibold hover:bg-gray-300">Manage</button>
                    </div>
                </div>
            </div>
            <div id="payment-options" class="space-y-4">
                <!-- Main Payment Options -->
                 <label class="flex items-center p-4 border rounded-lg cursor-pointer has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900 has-[:checked]:border-theme-blue">
                    <input type="radio" name="main-payment" value="Mobile Banking" class="w-5 h-5 accent-theme-blue">
                    <span class="ml-4 font-semibold" data-lang="mobile-banking">Mobile Banking</span>
                </label>
                 <label class="flex items-center p-4 border rounded-lg cursor-pointer has-[:checked]:bg-blue-50 dark:has-[:checked]:bg-blue-900 has-[:checked]:border-theme-blue">
                    <input type="radio" name="main-payment" value="Cash on Delivery" class="w-5 h-5 accent-theme-blue" checked>
                    <span class="ml-4 font-semibold" data-lang="cod">Cash on Delivery</span>
                </label>

                <!-- Sub Payment Options for Mobile Banking (hidden by default) -->
                <div id="mobile-banking-options" class="hidden pl-8 space-y-3 pt-3">
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="sub-payment" value="Bkash" class="w-5 h-5 accent-theme-pink">
                        <span class="ml-3 font-medium">Bkash</span>
                    </label>
                    <label class="flex items-center cursor-pointer">
                        <input type="radio" name="sub-payment" value="Nagad" class="w-5 h-5 accent-theme-pink">
                        <span class="ml-3 font-medium">Nagad</span>
                    </label>
                </div>
            </div>
            <div class="mt-8">
                <button id="confirm-order-btn" class="w-full bg-theme-pink text-white py-3 rounded-full font-bold hover:bg-theme-purple transition-colors shadow-lg" data-lang="confirm-order">Confirm Order</button>
            </div>
        </div>
    </div>
    
    <!-- Order Success Modal -->
    <div id="order-success-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-[110] hidden items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl text-center">
             <div class="w-20 h-20 mx-auto bg-green-100 rounded-full flex items-center justify-center">
                <i class="fas fa-check text-4xl text-green-500"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mt-6" data-lang="order-placed-success">Your order has been placed successfully!</h3>
            <p id="payment-instruction" class="mt-4 text-gray-600"></p>
            <div class="mt-8">
                <button id="close-success-modal" class="w-full bg-theme-blue text-white py-3 rounded-full font-bold hover:bg-theme-purple transition-colors shadow-lg">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Custom Confirmation Modal (Replaces window.confirm) -->
    <div id="confirmation-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 z-[120] hidden items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 max-w-sm w-full mx-4 shadow-2xl text-center">
            <h3 id="confirm-title" class="text-2xl font-bold text-red-600 mb-4">Confirm Action</h3>
            <p id="confirm-message" class="text-gray-600">Are you sure you want to proceed?</p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-full font-semibold hover:bg-gray-400 transition-colors">Cancel</button>
                <button id="confirm-ok-btn" class="px-6 py-2 bg-red-600 text-white rounded-full font-semibold hover:bg-red-700 transition-colors">Confirm</button>
            </div>
        </div>
    </div>


    <!-- Mobile Navigation Drawer (Left) -->
    <div id="nav-drawer" class="drawer left fixed top-0 left-0 h-full w-64 bg-white dark:bg-gray-800 shadow-lg z-50 p-6">
        <button onclick="closeDrawer()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        <h3 class="text-2xl font-bold text-theme-purple mb-8">Menu</h3>
        <nav>
            <ul class="space-y-4">
                <li><a href="javascript:void(0);" onclick="renderAllProducts(); closeDrawer();" class="text-lg font-semibold text-gray-700 hover:text-theme-blue" data-lang="home">‡¶π‡ßã‡¶Æ</a></li>
                <li><a href="#products" onclick="showPage('home-page'); scrollToElement('products')" class="text-lg font-semibold text-gray-700 hover:text-theme-blue" data-lang="products">‡¶™‡¶£‡ßç‡¶Ø</a></li>
                <li><a href="#categories" onclick="showPage('home-page'); scrollToElement('categories')" class="text-lg font-semibold text-gray-700 hover:text-theme-blue" data-lang="categories">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</a></li>
                <li><a href="javascript:void(0);" onclick="showOffers(); closeDrawer();" class="text-lg font-semibold text-gray-700 hover:text-theme-blue" data-lang="offers">‡¶Ö‡¶´‡¶æ‡¶∞</a></li>
            </ul>
        </nav>
    </div>

    <!-- Cart Drawer (Right) -->
    <div id="cart-drawer" class="drawer fixed top-0 right-0 h-full w-full max-w-sm bg-white dark:bg-gray-800 shadow-lg z-50 flex flex-col">
        <div class="p-6 border-b flex justify-between items-center">
            <h3 class="text-2xl font-bold text-theme-purple" data-lang="cart">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü</h3>
            <button onclick="closeDrawer()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button>
        </div>
        <div id="cart-items" class="p-6 space-y-6 flex-grow overflow-y-auto">
            <!-- Cart items will be dynamically inserted here -->
        </div>
        <div id="cart-summary" class="p-6 border-t space-y-2">
            
            <!-- Available Coupons section removed as requested -->
            
            <!-- Summary -->
             <div class="flex justify-between items-center text-md font-medium">
                <span data-lang="subtotal">Subtotal:</span>
                <span id="cart-subtotal" class="text-dark">‡ß≥0.00</span>
            </div>
             <div class="flex justify-between items-center text-md font-medium">
                <span data-lang="delivery-charge">Delivery Charge:</span>
                <span id="delivery-charge" class="text-dark">‡ß≥0.00</span>
            </div>
            <div id="discount-row" class="hidden flex justify-between items-center text-md font-medium text-green-600">
                <span data-lang="discount">Discount:</span>
                <span id="cart-discount"></span>
            </div>
            <div class="flex justify-between items-center text-xl font-semibold border-t pt-2 mt-2">
                <span data-lang="total-inclusive-vat">Total (Inclusive of VAT)</span>
                <span id="cart-total" class="text-theme-blue">‡ß≥0.00</span>
            </div>
             <!-- Coupon Form -->
            <div class="mt-4">
                <form id="coupon-form" class="w-full">
                    <div class="flex w-full overflow-hidden rounded-md border border-gray-300 bg-white dark:bg-gray-800">
                        <input type="text" id="coupon-input" placeholder="Coupon Code" class="flex-grow px-3 py-2 text-sm sm:text-base bg-transparent border-0 focus:outline-none focus:ring-0 text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-400" data-lang-placeholder="coupon-placeholder">
                        <button type="submit" id="apply-coupon-btn" class="bg-theme-blue text-white px-4 py-2 text-sm sm:text-base font-semibold hover:bg-theme-purple transition-colors" data-lang="apply-coupon">Apply</button>
                    </div>
                </form>
            </div>
            <button id="checkout-btn" class="w-full bg-theme-blue text-white py-4 rounded-md font-bold hover:bg-theme-purple transition-colors shadow-lg mt-4" data-lang="checkout">‡¶ö‡ßá‡¶ï‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>
    
    <!-- Profile Drawer (Right) -->
    <div id="profile-drawer" class="drawer fixed top-0 right-0 h-full w-full max-w-sm bg-white dark:bg-gray-800 shadow-lg z-50 overflow-y-auto">
        <div class="p-6 text-center relative">
            <button onclick="closeDrawer()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            <h3 id="profile-drawer-title" class="text-3xl font-bold text-theme-purple mb-8" data-lang="your-account">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</h3>
            
            <div class="space-y-4">
                <!-- Logged OUT state -->
                <div id="auth-options">
                    <!-- Login Form -->
                    <form id="login-form" class="space-y-4 text-left">
                        <input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                        <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                        <button type="submit" class="w-full py-3 bg-theme-blue text-white rounded-full font-bold hover:bg-theme-purple transition-colors">Login</button>
                        <div class="flex justify-between text-sm">
                            <a href="#" id="show-reset-form" class="text-theme-blue hover:underline">Forgot password?</a>
                            <span></span>
                        </div>
                        <p class="text-center text-sm">Don't have an account? <a href="#" id="show-register-form" class="text-theme-blue hover:underline">Register</a></p>
                    </form>

                    <!-- Reset Password Form (hidden by default) -->
                    <form id="reset-form" class="hidden space-y-4 text-left">
                        <p class="text-sm text-gray-600">Enter your account email. We'll send a link to reset your password.</p>
                        <input type="email" id="reset-email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                        <button type="submit" class="w-full py-3 bg-theme-blue text-white rounded-full font-bold hover:bg-theme-purple transition-colors">Send reset link</button>
                        <p class="text-center text-sm">Remembered it? <a href="#" id="show-login-from-reset" class="text-theme-blue hover:underline">Back to login</a></p>
                    </form>

                    <!-- Register Form (hidden by default) -->
                    <form id="register-form" class="hidden space-y-4 text-left">
                        <input type="text" id="register-name" placeholder="Full Name" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                        <input type="tel" id="register-mobile" placeholder="Mobile Number" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                        <input type="text" id="register-location" placeholder="Location" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                        <input type="email" id="register-email" placeholder="Email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                        <input type="password" id="register-password" placeholder="Password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                        <button type="submit" class="w-full py-3 bg-theme-blue text-white rounded-full font-bold hover:bg-theme-purple transition-colors">Register</button>
                        <p class="text-center text-sm">Already have an account? <a href="#" id="show-login-form" class="text-theme-blue hover:underline">Login</a></p>
                    </form>
                    
                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-gray-400 text-sm">OR</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>
                    
                    <button id="login-google-btn" class="w-full py-3 px-6 bg-white border border-gray-300 text-gray-700 rounded-full font-bold hover:bg-gray-100 transition-colors shadow-lg flex items-center justify-center">
                        <i class="fab fa-google mr-2 text-xl"></i>
                        <span data-lang="signin-google">Sign in with Google</span>
                    </button>
                    <button id="login-facebook-btn" class="mt-3 w-full py-3 px-6 bg-[#1877F2] text-white rounded-full font-bold hover:bg-[#165FDB] transition-colors shadow-lg flex items-center justify-center">
                        <i class="fab fa-facebook mr-2 text-xl"></i>
                        <span>Continue with Facebook</span>
                    </button>
                     <p id="auth-error" class="text-red-500 text-sm mt-2 h-4"></p>
                </div>

                <!-- Logged IN state -->
                <div id="user-profile-view" class="hidden">
                    <!-- User Info Section -->
                    <div class="space-y-2 mb-8">
                        <img id="user-photo" src="" alt="User Photo" class="w-24 h-24 rounded-full mx-auto shadow-xl object-cover border-4 border-theme-purple/30">
                        <p id="user-name" class="mt-4 text-xl font-bold text-theme-purple"></p>
                        <p id="user-email" class="text-sm text-gray-500"></p>
                        <div class="flex items-center justify-center space-x-1 text-sm mt-2">
                             <p id="user-mobile" class="text-sm text-gray-600"></p>
                        </div>
                        <div class="flex items-center justify-center space-x-1 text-sm">
                            <p id="user-location" class="text-sm text-gray-600"></p>
                        </div>
                    </div>

                    <!-- Button Actions Group -->
                    <div class="space-y-4">
                        
                        <!-- My Orders (Theme Blue) -->
                        <button id="my-orders-btn-profile" class="w-full py-3 bg-theme-blue text-white rounded-xl font-semibold hover:bg-theme-purple transition-colors shadow-md flex items-center justify-between px-4" data-lang="my-orders">
                            <span><i class="fas fa-box-open mr-3"></i> My Orders</span>
                            <i class="fas fa-chevron-right text-sm"></i>
                        </button>

                        <!-- Emergency Contact moved to header -->
                        
                        <!-- Edit Profile (Grey/Secondary) -->
                        <button id="edit-profile-btn" class="w-full py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl font-semibold hover:bg-gray-300 transition-colors shadow-md flex items-center justify-between px-4">
                            <span><i class="fas fa-user-edit mr-3"></i> Edit Profile</span>
                            <i class="fas fa-chevron-right text-sm"></i>
                        </button>
                        <!-- Manage Addresses -->
                        <button id="manage-addresses-btn" class="w-full py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-xl font-semibold hover:bg-gray-300 transition-colors shadow-md flex items-center justify-between px-4">
                            <span><i class="fas fa-location-dot mr-3"></i> Manage Addresses</span>
                            <i class="fas fa-chevron-right text-sm"></i>
                        </button>
                        
                        <!-- Logout (Prominent) -->
                         <button id="logout-btn" class="w-full py-3 bg-theme-pink text-white rounded-xl font-semibold hover:bg-theme-purple transition-colors shadow-lg mt-8 flex items-center justify-between px-4" data-lang="logout">
                            <span><i class="fas fa-sign-out-alt mr-3"></i> ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</span>
                            <i class="fas fa-chevron-right text-sm"></i>
                        </button>

                        <!-- Delete Account (Danger, Separate) -->
                        <button id="delete-account-btn" class="w-full py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600 transition-colors shadow-md flex items-center justify-center mt-4">
                             <i class="fas fa-trash-alt mr-2"></i> Delete Account
                        </button>

                    </div>
                </div>
                 <!-- Edit Profile Form -->
                <form id="edit-profile-form" class="hidden text-left space-y-4">
                    <div class="text-center">
                         <img id="edit-photo-preview" src="" alt="Profile Photo Preview" class="w-24 h-24 rounded-full mx-auto shadow-lg object-cover mb-2">
                         <input type="file" id="edit-photo-input" accept="image/*" class="text-sm w-full">
                         <button type="button" id="remove-photo-btn" class="mt-2 px-4 py-2 text-sm rounded-full border border-red-400 text-red-600 hover:bg-red-50 transition-colors">Remove Photo</button>
                    </div>
                    <div>
                        <label for="edit-name-input" class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="edit-name-input" class="w-full mt-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                    </div>
                    <div>
                        <label for="edit-mobile-input" class="block text-sm font-medium text-gray-700">Mobile Number</label>
                        <input type="text" id="edit-mobile-input" placeholder="e.g., 01xxxxxxxxx" class="w-full mt-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                    </div>
                     <div>
                        <label for="edit-location-input" class="block text-sm font-medium text-gray-700">Location</label>
                        <input type="text" id="edit-location-input" placeholder="e.g., Dhaka, Bangladesh" class="w-full mt-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700">
                    </div>
                    <div class="flex gap-4 pt-4">
                        <button type="button" id="cancel-edit-btn" class="w-full py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-full font-bold hover:bg-gray-300 transition-colors">Cancel</button>
                        <button type="submit" id="save-profile-btn" class="w-full py-2 bg-theme-blue text-white rounded-full font-bold hover:bg-theme-purple transition-colors flex items-center justify-center">
                            <span class="btn-text">Save Changes</span>
                            <div class="loader-small hidden"></div>
                        </button>
                    </div>
                </form>

                <!-- Addresses Management Section -->
                <div id="addresses-section" class="hidden text-left space-y-4 mt-6">
                    <h4 class="text-xl font-bold text-theme-purple">Shipping Addresses</h4>
                    <div id="addresses-list" class="space-y-3">
                        <!-- Address cards injected here -->
                    </div>
                    <div class="p-4 border rounded-xl bg-gray-50 dark:bg-gray-800/50">
                        <h5 id="address-form-title" class="font-semibold mb-3">Add New Address</h5>
                        <form id="address-form" class="grid grid-cols-1 gap-3">
                            <input type="hidden" id="address-id-hidden" />
                            <div>
                                <label class="block text-sm font-medium">Full Name</label>
                                <input id="addr-name" type="text" class="w-full mt-1 px-3 py-2 border rounded-lg bg-white dark:bg-gray-700" required />
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Mobile</label>
                                <input id="addr-mobile" type="text" class="w-full mt-1 px-3 py-2 border rounded-lg bg-white dark:bg-gray-700" required />
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Address Line 1</label>
                                <input id="addr-line1" type="text" class="w-full mt-1 px-3 py-2 border rounded-lg bg-white dark:bg-gray-700" required />
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Address Line 2 (Optional)</label>
                                <input id="addr-line2" type="text" class="w-full mt-1 px-3 py-2 border rounded-lg bg-white dark:bg-gray-700" />
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium">City</label>
                                    <input id="addr-city" type="text" class="w-full mt-1 px-3 py-2 border rounded-lg bg-white dark:bg-gray-700" required />
                                </div>
                                <div>
                                    <label class="block text-sm font-medium">Area/District</label>
                                    <input id="addr-area" type="text" class="w-full mt-1 px-3 py-2 border rounded-lg bg-white dark:bg-gray-700" />
                                </div>
                            </div>
                            <label class="inline-flex items-center gap-2 mt-1">
                                <input id="addr-default" type="checkbox" class="w-4 h-4" />
                                <span>Set as default</span>
                            </label>
                            <div class="flex gap-3 pt-2">
                                <button id="save-address-btn" type="submit" class="w-full py-2 bg-theme-blue text-white rounded-full font-bold hover:bg-theme-purple transition-colors">Save Address</button>
                                <button id="cancel-address-btn" type="button" class="w-full py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-full font-bold hover:bg-gray-300 transition-colors">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Page: Cart -->
    <section id="cart-page" class="page hidden max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl sm:text-3xl font-bold text-theme-purple" data-lang="cart">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü</h2>
            <button onclick="showPage('home-page')" class="text-theme-blue hover:text-theme-pink transition-colors text-sm sm:text-base" data-lang="back-to-products">Back to All Products</button>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Items -->
            <div class="lg:col-span-2 space-y-4" id="cart-page-items">
                <!-- Will mirror cart items rendering -->
            </div>
            <!-- Summary -->
            <aside class="lg:col-span-1">
                <div class="p-5 rounded-2xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 shadow-sm space-y-4">
                    <h3 class="text-xl font-bold text-theme-purple" data-lang="order-summary">Order Summary</h3>
                    <!-- Coupon Apply under Order Summary heading -->
                    <form id="cart-page-coupon-form" class="w-full">
                        <div class="flex w-full overflow-hidden rounded-md border border-gray-300 bg-white dark:bg-gray-800">
                            <input type="text" id="cart-page-coupon-input" class="flex-grow px-3 py-2 text-sm sm:text-base bg-transparent border-0 focus:outline-none focus:ring-0 text-gray-800 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-400" data-lang-placeholder="coupon-placeholder" placeholder="Coupon Code">
                            <button type="submit" class="bg-theme-blue text-white px-4 py-2 text-sm sm:text-base font-semibold hover:bg-theme-purple transition-colors" data-lang="apply-coupon">Apply</button>
                        </div>
                    </form>
                    <p id="cart-page-coupon-applied" class="hidden text-xs text-green-600"></p>
                    <!-- Available Coupons section removed on cart page as requested -->
                    <div class="flex justify-between text-sm">
                        <span data-lang="subtotal">Subtotal:</span>
                        <span id="cart-page-subtotal" class="text-dark">‡ß≥0.00</span>
                    </div>
                    <div class="flex justify-between text-sm">
                        <span data-lang="delivery-charge">Delivery Charge:</span>
                        <span id="cart-page-delivery" class="text-dark">‡ß≥0.00</span>
                    </div>
                    <div id="cart-page-discount-row" class="hidden flex justify-between text-sm text-green-600">
                        <span data-lang="discount">Discount:</span>
                        <span id="cart-page-discount">- ‡ß≥0.00</span>
                    </div>
                    <div class="flex justify-between text-lg font-semibold border-t pt-2 mt-2">
                        <span data-lang="total-inclusive-vat">Total (Inclusive of VAT)</span>
                        <span id="cart-page-total" class="text-theme-blue">‡ß≥0.00</span>
                    </div>
                    <button id="cart-page-checkout-btn" class="w-full bg-theme-blue text-white py-3 rounded-md font-bold hover:bg-theme-purple transition-colors shadow-lg" data-lang="checkout">‡¶ö‡ßá‡¶ï‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>
            </aside>
        </div>
    </section>


    <!-- Main Content Container -->
    <main id="main-content-container">

        <!-- Home Page -->
        <div id="home-page" class="page">
            <!-- Top Category Strip (Under Header, Above Banner) -->
            <section id="top-category-strip" class="container mx-auto px-4 pt-4">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-md border border-gray-100 dark:border-gray-700">
                    <div id="top-category-strip-list" class="flex gap-2 sm:gap-3 px-4 py-3 overflow-x-auto items-center">
                        <!-- Dynamic category chips and inline dropdown will render here -->
                    </div>
                </div>
            </section>
            <!-- Hero/Banner Composite (2-part layout) -->
            <section class="container mx-auto px-4 py-4">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <!-- Left: Main Banner Slider -->
                    <div class="lg:col-span-2">
                        <div id="banner-slider" class="relative overflow-hidden w-full rounded-2xl shadow-xl h-[220px] sm:h-[260px]">
                            <!-- Slides Container -->
                            <div id="slides-container" class="flex transition-transform duration-500 ease-in-out h-full">
                                <!-- Banners will be loaded from Firebase here -->
                            </div>

                            <!-- Slider Navigation Buttons -->
                            <button id="prev-btn" class="absolute left-4 top-1/2 -translate-y-1/2 bg-white bg-opacity-50 text-dark p-2 rounded-full hover:bg-opacity-80 transition-colors">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button id="next-btn" class="absolute right-4 top-1/2 -translate-y-1/2 bg-white bg-opacity-50 text-dark p-2 rounded-full hover:bg-opacity-80 transition-colors">
                                <i class="fas fa-chevron-right"></i>
                            </button>

                            <!-- Slider Indicators -->
                            <div id="slider-indicators" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2">
                                <!-- Indicators are dynamically generated -->
                            </div>
                        </div>
                    </div>

                    <!-- Right: Promo Tile (tall) -->
                    <aside class="lg:col-span-1">
                        <a id="right-promo-link" href="javascript:void(0)" onclick="scrollToElement('categories')" class="group block relative overflow-hidden rounded-2xl shadow-xl h-[220px] sm:h-[260px]">
                            <img id="right-promo-img" src="https://images.unsplash.com/photo-1524594081293-190a2fe0baae?q=80&w=1200&auto=format&fit=crop" alt="Promo: Smart prices on accessories" class="w-full h-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/ddd/000?text=Promo';">
                            <div class="absolute inset-0 bg-black/20 group-hover:bg-black/30 transition-colors"></div>
                            <div class="absolute bottom-4 left-4 right-4 text-white drop-shadow">
                                <h3 id="right-promo-title" class="text-xl sm:text-2xl font-extrabold hidden"></h3>
                                <p id="right-promo-subtitle" class="text-sm sm:text-base font-semibold hidden"></p>
                            </div>
                        </a>
                    </aside>
                </div>
            </section>
            
            <!-- Hero Section removed: merged into composite above to match design -->
        
            <!-- Featured Products Section -->
            <section id="products" class="container mx-auto px-4 py-16">
                <!-- NEW: Breadcrumb and Sub-Category Header -->
                <div id="category-header" class="hidden mb-8 p-4 bg-white dark:bg-gray-800 rounded-xl shadow-md border dark:border-gray-700">
                    <div id="breadcrumb" class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                        <a href="javascript:void(0);" onclick="renderAllProducts()" class="text-theme-blue hover:underline" data-lang="all-products">‡¶∏‡¶ï‡¶≤ ‡¶™‡¶£‡ßç‡¶Ø</a>
                        <span id="category-path"></span>
                    </div>
                    <h2 id="current-category-title" class="text-3xl md:text-4xl font-bold mb-4 text-theme-purple text-center" data-lang="featured-products">‡¶¨‡ßà‡¶∂‡¶ø‡¶∑‡ßç‡¶ü‡ßç‡¶Ø‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶™‡¶£‡ßç‡¶Ø</h2>
                    <div id="subcategory-buttons" class="flex flex-wrap gap-3 justify-center">
                        <!-- Sub-category buttons will appear here -->
                    </div>
                </div>
                <!-- END NEW: Breadcrumb and Sub-Category Header -->

                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-8 min-h-[300px]">
                    <div class="loader"></div>
                </div>
            </section>

            <!-- Categories Section -->
            <section id="categories" class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full" data-lang="shop-by-category">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-8">
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('electronics')">
                        <div class="text-5xl text-theme-blue mb-4"><i class="fas fa-mobile-alt"></i></div>
                        <h3 class="text-xl font-semibold" data-lang="cat-electronics">‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï‡ßç‡¶∏</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('fashion')">
                        <div class="text-5xl text-theme-blue mb-4"><i class="fas fa-tshirt"></i></div>
                        <h3 class="text-xl font-semibold" data-lang="cat-fashion">‡¶´‡ßç‡¶Ø‡¶æ‡¶∂‡¶®</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('home-garden')">
                        <div class="text-5xl text-theme-blue mb-4"><i class="fas fa-home"></i></div>
                        <h3 class="text-xl font-semibold" data-lang="cat-home-garden">‡¶π‡ßã‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶ó‡¶æ‡¶∞‡ßç‡¶°‡ßá‡¶®</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('health-beauty')">
                        <div class="text-5xl text-theme-blue mb-4"><i class="fas fa-heartbeat"></i></div>
                        <h3 class="text-xl font-semibold" data-lang="cat-health-beauty">‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø ‡¶ì ‡¶∏‡ßå‡¶®‡ßç‡¶¶‡¶∞‡ßç‡¶Ø</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('sports')">
                        <div class="text-5xl text-theme-blue mb-4"><i class="fas fa-dumbbell"></i></div>
                        <h3 class="text-xl font-semibold" data-lang="cat-sports">‡¶ñ‡ßá‡¶≤‡¶æ‡¶ß‡ßÅ‡¶≤‡¶æ ‡¶ì ‡¶Ü‡¶â‡¶ü‡¶°‡ßã‡¶∞</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('books')">
                        <div class="text-5xl text-theme-blue mb-4"><i class="fas fa-book-open"></i></div>
                        <h3 class="text-xl font-semibold" data-lang="cat-books">‡¶¨‡¶á ‡¶ì ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('kids')">
                        <div class="text-5xl text-theme-blue mb-4"><i class="fas fa-baby"></i></div>
                        <h3 class="text-xl font-semibold" data-lang="cat-kids">‡¶¨‡¶æ‡¶ö‡ßç‡¶ö‡¶æ ‡¶ì ‡¶ñ‡ßá‡¶≤‡¶®‡¶æ</h3>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl text-center transition-transform hover:-translate-y-2 hover:shadow-2xl cursor-pointer" onclick="filterProducts('cars')">
                        <div class="text-5xl text-theme-blue mb-4"><i class="fas fa-car-side"></i></div>
                        <h3 class="text-xl font-semibold" data-lang="cat-cars">‡¶ó‡¶æ‡¶°‡¶º‡¶ø ‡¶ì ‡¶¨‡¶æ‡¶á‡¶ï</h3>
                    </div>
                </div>
            </section>

            <!-- Features Section -->
            <section class="bg-gray-200 dark:bg-gray-800 py-16">
                <div class="container mx-auto px-4">
                    <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full" data-lang="why-choose-us">‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞‡¶ï‡ßá ‡¶ï‡ßá‡¶® ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶¨‡ßá‡¶®</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-8">
                        <div class="p-6 text-center animate-slide-in-up">
                            <div class="text-5xl text-theme-pink mb-4"><i class="fas fa-truck"></i></div>
                            <h3 class="text-xl font-semibold mb-2" data-lang="feature-delivery-title">‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø</h3>
                            <p class="text-gray-600" data-lang="feature-delivery-desc">‡¶Ü‡¶Æ‡¶∞‡¶æ ‡ß®-‡ß© ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶¶‡¶ø‡¶¨‡¶∏‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßã‡¶∞‡¶ó‡ßã‡¶°‡¶º‡¶æ‡¶Ø‡¶º ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡ßå‡¶Å‡¶õ‡ßá ‡¶¶‡¶ø‡¶á‡•§</p>
                        </div>
                        <div class="p-6 text-center animate-slide-in-up">
                            <div class="text-5xl text-theme-pink mb-4"><i class="fas fa-shield-alt"></i></div>
                            <h3 class="text-xl font-semibold mb-2" data-lang="feature-payment-title">‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü</h3>
                            <p class="text-gray-600" data-lang="feature-payment-desc">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶ì ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º‡¶§‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶è‡¶®‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü‡ßá‡¶°‡•§</p>
                        </div>
                        <div class="p-6 text-center animate-slide-in-up">
                            <div class="text-5xl text-theme-pink mb-4"><i class="fas fa-undo"></i></div>
                            <h3 class="text-xl font-semibold mb-2" data-lang="feature-return-title">‡¶∏‡¶π‡¶ú ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®</h3>
                            <p class="text-gray-600" data-lang="feature-return-desc">‡¶™‡¶õ‡¶®‡ßç‡¶¶ ‡¶®‡¶æ ‡¶π‡¶≤‡ßá ‡ß©‡ß¶ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶™‡¶£‡ßç‡¶Ø ‡¶´‡ßá‡¶∞‡¶§ ‡¶¶‡¶ø‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø ‡¶´‡ßá‡¶∞‡¶§ ‡¶™‡¶æ‡¶®‡•§</p>
                        </div>
                        <div class="p-6 text-center animate-slide-in-up">
                            <div class="text-5xl text-theme-pink mb-4"><i class="fas fa-headset"></i></div>
                            <h3 class="text-xl font-semibold mb-2" data-lang="feature-support-title">‡ß®‡ß™/‡ß≠ ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü</h3>
                            <p class="text-gray-600" data-lang="feature-support-desc">‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ ‡¶¶‡¶≤ ‡¶¶‡¶ø‡¶®‡¶∞‡¶æ‡¶§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß‡•§</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- About Us Page -->
        <div id="about-us-page" class="hidden page">
             <section id="about-us" class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full">‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-8">
                    <p class="text-lg leading-relaxed text-gray-700 dark:text-gray-300">
                        TangailBuzz ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶∏‡ßç‡¶§ ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶∂‡¶™‡¶ø‡¶Ç ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ü‡¶´‡¶∞‡ßç‡¶Æ ‡¶Ø‡¶æ ‡¶∏‡¶æ‡¶∂‡ßç‡¶∞‡¶Ø‡¶º‡ßÄ ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá ‡¶Æ‡¶æ‡¶®‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§ ‡¶™‡¶£‡ßç‡¶Ø ‡¶∏‡¶∞‡¶¨‡¶∞‡¶æ‡¶π ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∂‡ßç‡¶∞‡ßÅ‡¶§‡¶ø‡¶¨‡¶¶‡ßç‡¶ß‡•§ ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï‡¶¶‡ßá‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶π‡¶ú ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶®‡¶®‡ßç‡¶¶‡¶¶‡¶æ‡¶Ø‡¶º‡¶ï ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ‡¶∞ ‡¶Ö‡¶≠‡¶ø‡¶ú‡ßç‡¶û‡¶§‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶¨‡¶¶‡ßç‡¶ß‡¶™‡¶∞‡¶ø‡¶ï‡¶∞‡•§ ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶π‡¶≤ ‡¶∏‡¶ï‡¶≤‡ßá‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶∏‡ßá‡¶∞‡¶æ ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡ßå‡¶Å‡¶õ‡ßá ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ, ‡¶Ø‡¶æ‡¶§‡ßá ‡¶§‡¶æ‡¶∞‡¶æ ‡¶ò‡¶∞‡ßá ‡¶¨‡¶∏‡ßá‡¶á ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶™‡¶õ‡¶®‡ßç‡¶¶‡ßá‡¶∞ ‡¶ú‡¶ø‡¶®‡¶ø‡¶∏ ‡¶ï‡¶ø‡¶®‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡¶®‡•§
                    </p>
                    <div class="flex flex-col md:flex-row items-center md:items-start gap-8 md:gap-12 p-6 bg-gray-100 dark:bg-gray-700 rounded-2xl shadow-inner">
                        <img src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/WhatsApp%20Image%202025-07-30%20at%2019.29.33_9f8c7d06.jpg?raw=true" alt="Md Eousuf Ali" class="w-32 h-32 rounded-full object-cover shadow-lg">
                        <div>
                            <h3 class="text-2xl font-bold text-theme-purple mb-2">‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶§‡¶æ: MD EOUSUF ALI</h3>
                            <p class="text-gray-600 dark:text-gray-300 leading-relaxed">
                                Md Eousuf Ali, TangailBuzz-‡¶è‡¶∞ ‡¶∏‡ßç‡¶¨‡¶™‡ßç‡¶®‡¶¶‡ßç‡¶∞‡¶∑‡ßç‡¶ü‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∑‡ßç‡¶†‡¶æ‡¶§‡¶æ‡•§ ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶™‡ßç‡¶≤‡ßç‡¶Ø‡¶æ‡¶ü‡¶´‡¶∞‡ßç‡¶Æ‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ‡ßá ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶®‡ßÅ‡¶∑‡ßá‡¶∞ ‡¶ï‡¶æ‡¶õ‡ßá ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶Æ‡¶æ‡¶®‡ßá‡¶∞ ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡ßå‡¶Å‡¶õ‡ßá ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶≤‡¶ï‡ßç‡¶∑‡ßç‡¶Ø ‡¶®‡¶ø‡¶Ø‡¶º‡ßá ‡¶§‡¶ø‡¶®‡¶ø ‡¶è‡¶á ‡¶Ø‡¶æ‡¶§‡ßç‡¶∞‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßá‡¶®‡•§ ‡¶§‡¶æ‡¶Å‡¶∞ ‡¶¶‡ßÇ‡¶∞‡¶¶‡¶∞‡ßç‡¶∂‡¶ø‡¶§‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶ï‡¶†‡ßã‡¶∞ ‡¶™‡¶∞‡¶ø‡¶∂‡ßç‡¶∞‡¶Æ TangailBuzz-‡¶ï‡ßá ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®‡ßá ‡¶è‡¶®‡ßá‡¶õ‡ßá‡•§
                            </p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
        
        <!-- Product Details Page -->
        <div id="product-details-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl">
                    <button onclick="renderAllProducts()" class="mb-6 px-4 py-2 bg-gray-200 dark:bg-gray-700 dark:text-gray-200 rounded-full hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i> <span data-lang="back-to-products">‡¶∏‡¶ï‡¶≤ ‡¶™‡¶£‡ßç‡¶Ø‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</span>
                    </button>
                    <div class="flex flex-col lg:flex-row gap-8 items-center lg:items-start">
                        <!-- Main Product Image & Thumbnails -->
                        <div class="w-full lg:w-1/2 flex flex-col items-center space-y-4">
                             <div id="product-image-container" class="relative w-full rounded-2xl shadow-lg overflow-hidden">
                                 <!-- Mouse events for handleImageZoom use 'var(--x-pos)' and 'var(--y-pos)' set in JS/CSS -->
                                <img id="product-image" class="w-full h-auto object-contain transition-transform duration-200 ease-out" src="" alt="Product Image">
                            </div>
                            <!-- Thumbnail Images -->
                            <div id="thumbnail-container" class="flex space-x-2 overflow-x-auto w-full justify-center">
                                <!-- Thumbnails will be added here dynamically -->
                            </div>
                        </div>
                        <div class="w-full lg:w-1/2 space-y-4">
                            <h2 id="product-title-details" class="text-3xl md:text-4xl font-bold text-theme-purple"></h2>
                            <p id="product-brand-details" class="text-sm text-gray-500"></p>
                            <!-- NEW: Product Model ID Display -->
                            <p id="product-model-details" class="text-sm text-gray-600 font-medium flex items-center">
                                <i class="fas fa-tag mr-2"></i> 
                                <span id="model-text"></span>
                            </p>
                            <!-- END NEW: Product Model ID Display -->
                            <!-- NEW: Warranty Display below Brand/Model -->
                            <p id="product-warranty-details" class="text-sm text-green-600 font-semibold flex items-center">
                                <!-- Icon and Text updated via JS -->
                                <i class="fas fa-shield-alt mr-2"></i> 
                                <span id="warranty-text"></span>
                            </p>
                            <!-- END NEW: Warranty Display -->
                            <div class="flex items-center text-sm my-1">
                                <div id="product-rating-details" class="text-sm mr-1"></div>
                                <div id="product-stars-details" class="flex items-center"></div>
                                <div id="product-rating-count-details" class="text-xs text-gray-500 ml-2"></div>
                            </div>
                            <div id="product-price-details" class="flex items-center space-x-2"></div>
                            <!-- Stock indicator -->
                            <p id="product-stock-details" class="text-sm font-medium"></p>
                            
                            <!-- Variants: Size, Storage, Color -->
                            <div id="product-options" class="space-y-4">
                                <div id="size-options" class="hidden">
                                    <label class="block text-sm font-semibold mb-2" data-lang="size">‡¶∏‡¶æ‡¶á‡¶ú:</label>
                                    <div class="flex flex-wrap gap-2" id="size-variants-container"></div>
                                </div>
                                <div id="storage-options" class="hidden">
                                    <label class="block text-sm font-semibold mb-2" data-lang="storage">‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú:</label>
                                    <div class="flex flex-wrap gap-2" id="storage-variants-container"></div>
                                </div>
                                <div id="color-options" class="hidden">
                                    <label class="block text-sm font-semibold mb-2" data-lang="color">‡¶∞‡¶ô:</label>
                                    <div class="flex flex-wrap gap-2" id="color-variants-container"></div>
                                </div>
                            </div>
                            
                            <!-- Return policy and secure payments -->
                            <div id="product-info-details" class="space-y-2 text-gray-600">
                                <!-- Details will be rendered here dynamically -->
                            </div>

                            <div class="mt-6 space-y-2">
                                <div class="grid grid-cols-2 gap-2">
                                    <button id="add-to-cart-details" class="add-to-cart w-full bg-theme-blue text-white text-xs md:text-sm py-1.5 px-3 md:py-2 md:px-4 rounded-full hover:bg-theme-purple transition-colors shadow" data-lang="add-to-cart">‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                                    <button class="buy-now w-full bg-white border border-theme-blue text-theme-blue text-xs md:text-sm py-1.5 px-3 md:py-2 md:px-4 rounded-full hover:bg-gray-100 transition-colors shadow" data-lang="buy-now">‡¶è‡¶ñ‡¶®‡¶á ‡¶ï‡¶ø‡¶®‡ßÅ‡¶®</button>
                                </div>
                                <button id="wishlist-details" class="wishlist text-gray-400 hover:text-theme-pink text-3xl transition-colors self-start"><i class="far fa-heart"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-16">
                        <h3 class="text-2xl md:text-3xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block" data-lang="product-description">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£</h3>
                        <p id="product-full-description" class="text-gray-700 dark:text-gray-300 leading-relaxed mt-4"></p>
                    </div>
                    
                    <div class="mt-16">
                        <h3 class="text-2xl md:text-3xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block" data-lang="product-specifications">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶∏‡ßç‡¶™‡ßá‡¶∏‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®</h3>
                        <div id="product-specifications" class="bg-gray-100 dark:bg-gray-700 p-6 rounded-xl mt-4"></div>
                    </div>

                    <div class="mt-16">
                        <h3 class="text-2xl md:text-3xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block" data-lang="product-reviews">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â</h3>
                        <div id="product-reviews" class="space-y-4 mt-4"></div>
                        
                        <!-- NEW: Review Submission Form -->
                        <div class="mt-8 p-6 bg-gray-100 dark:bg-gray-700 rounded-xl shadow-inner">
                            <h4 class="text-xl font-bold text-theme-blue mb-4" data-lang="write-a-review">‡¶è‡¶ï‡¶ü‡¶ø ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶¶‡¶ø‡¶®</h4>
                            <form id="review-form">
                                <input type="hidden" id="review-product-id" name="productId">
                                <div id="review-login-prompt" class="text-center p-4 border border-red-300 bg-red-50 text-red-700 rounded-lg hidden">
                                    <p data-lang="review-login-prompt">‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø‡•§</p>
                                </div>
                                <div id="review-controls">
                                    <div class="mb-4">
                                        <label class="block text-sm font-semibold mb-2" data-lang="your-rating">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ü‡¶ø‡¶Ç:</label>
                                        <div id="rating-stars" class="flex text-2xl space-x-1">
                                            <i class="far fa-star text-gray-400 cursor-pointer rating-star" data-rating="1"></i>
                                            <i class="far fa-star text-gray-400 cursor-pointer rating-star" data-rating="2"></i>
                                            <i class="far fa-star text-gray-400 cursor-pointer rating-star" data-rating="3"></i>
                                            <i class="far fa-star text-gray-400 cursor-pointer rating-star" data-rating="4"></i>
                                            <i class="far fa-star text-gray-400 cursor-pointer rating-star" data-rating="5"></i>
                                            <input type="hidden" id="review-rating" name="rating" required value="0">
                                        </div>
                                    </div>
                                    <div class="mb-4">
                                        <label for="review-comment" class="block text-sm font-semibold mb-2" data-lang="your-comment">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø:</label>
                                        <textarea id="review-comment" name="comment" rows="3" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-800" required></textarea>
                                    </div>
                                    <button type="submit" id="submit-review-btn" class="bg-theme-pink text-white py-2 px-6 rounded-full font-bold hover:bg-theme-purple transition-colors" data-lang="submit-review">‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®</button>
                                </div>
                            </form>
                        </div>
                        <!-- END NEW: Review Submission Form -->
                    </div>

                    <!-- Related Products Section -->
                    <div id="related-products-section" class="mt-16 hidden">
                        <h3 class="text-2xl md:text-3xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block">Related Products</h3>
                        <div id="related-product-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Wishlist Page -->
        <div id="wishlist-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full" data-lang="your-wishlist">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶á‡¶∂‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h2>
                <div id="wishlist-items" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-8">
                    <!-- Wishlist items will be dynamically inserted here -->
                </div>
            </section>
        </div>
        
        <!-- My Orders Page -->
        <div id="my-orders-page" class="hidden page">
             <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full" data-lang="my-orders">My Orders</h2>
                <div id="orders-list" class="space-y-8">
                    <!-- Orders will be dynamically inserted here -->
                </div>
             </section>
        </div>
        
        <!-- Emergency Chat Page -->
        <div id="emergency-chat-page" class="hidden page">
            <section class="container mx-auto px-4 py-4 md:py-16">
                <div class="bg-white dark:bg-gray-800 p-6 pb-[env(safe-area-inset-bottom)] rounded-3xl shadow-xl max-w-2xl mx-auto flex flex-col min-h-0 h-[80dvh] md:h-[70vh]">
                    <div class="flex justify-between items-center mb-4 border-b pb-4">
                        <h2 class="text-2xl font-bold text-theme-purple">‡¶ú‡¶∞‡ßÅ‡¶∞‡ßÄ ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó</h2>
                        <button onclick="showPage('home-page')" class="text-theme-blue hover:text-theme-pink transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <!-- Chat Messages Container -->
                    <div id="chat-messages" class="min-h-0 flex-grow overflow-y-auto space-y-4 p-4 mb-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                        <p class="text-center text-gray-500">Loading chat...</p>
                    </div>
                    
                    <!-- Chat Input Form -->
                    <form id="chat-form" class="flex space-x-3">
                        <input type="text" id="chat-input" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." class="flex-grow px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-theme-blue bg-white dark:bg-gray-700" required>
                        <button type="submit" id="send-chat-btn" class="bg-theme-blue text-white w-12 h-12 rounded-full hover:bg-theme-purple transition-colors shadow-lg">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    <p id="chat-error" class="text-red-500 text-xs mt-2"></p>
                </div>
            </section>
        </div>


        <!-- FAQ Page -->
        <div id="faq-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full">‡¶∏‡¶ö‡¶∞‡¶æ‡¶ö‡¶∞ ‡¶ú‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶∏‡¶ø‡¶§ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶æ‡¶¨‡¶≤‡ßÄ (FAQ)</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-6">
                    <div class="border-b pb-4">
                        <h3 class="text-xl font-semibold text-theme-blue mb-2">‡¶Ü‡¶Æ‡¶ø ‡¶ï‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶¨?</h3>
                        <p class="text-gray-700 dark:text-gray-300">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶õ‡¶®‡ßç‡¶¶‡ßá‡¶∞ ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®, '‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®' ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡ßá‡¶ï‡¶Ü‡¶â‡¶ü ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶∞‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                    </div>
                    <div class="border-b pb-4">
                        <h3 class="text-xl font-semibold text-theme-blue mb-2">‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶π‡¶§‡ßá ‡¶ï‡¶§ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶≤‡¶æ‡¶ó‡ßá?</h3>
                        <p class="text-gray-700 dark:text-gray-300">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£‡¶§ ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡ß®-‡ß© ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶¶‡¶ø‡¶¨‡¶∏‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶ï‡¶∞‡¶ø‡•§ ‡¶§‡¶¨‡ßá, ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ‡¶ü‡¶æ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶¨‡ßá‡¶∂‡¶ø‡¶ì ‡¶≤‡¶æ‡¶ó‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§</p>
                    </div>
                    <div class="border-b pb-4">
                        <h3 class="text-xl font-semibold text-theme-blue mb-2">‡¶Ü‡¶Æ‡¶ø ‡¶ï‡¶ø ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ö‡¶® ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø (COD) ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨?</h3>
                        <p class="text-gray-700 dark:text-gray-300">‡¶π‡ßç‡¶Ø‡¶æ‡¶Å, ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ö‡¶® ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø (COD) ‡¶è‡¶¨‡¶Ç ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶â‡¶≠‡¶Ø‡¶º‡¶á ‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶ï‡¶∞‡¶ø‡•§</p>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-theme-blue mb-2">‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶â‡¶™‡¶æ‡¶Ø‡¶º ‡¶ï‡ßÄ?</h3>
                        <p class="text-gray-700 dark:text-gray-300">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶π‡¶≤‡ßá, ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶ø‡¶Ç ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶∏‡¶π ‡¶è‡¶ï‡¶ü‡¶ø ‡¶á‡¶Æ‡ßá‡¶≤ ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ì‡¶Ø‡¶º‡ßá‡¶¨‡¶∏‡¶æ‡¶á‡¶ü‡ßá ‡¶∏‡ßá‡¶á ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶ø‡¶Ç ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§</p>
                    </div>
                </div>
            </section>
        </div>

        <!-- Return Policy Page -->
        <div id="return-policy-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full">‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶®‡ßÄ‡¶§‡¶ø</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-6">
                    <p class="text-lg leading-relaxed text-gray-700 dark:text-gray-300">
                        ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßá‡¶®‡¶æ ‡¶™‡¶£‡ßç‡¶Ø‡ßá ‡¶Ö‡¶∏‡¶®‡ßç‡¶§‡ßÅ‡¶∑‡ßç‡¶ü ‡¶π‡¶®, ‡¶§‡¶¨‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø‡¶∞ ‡ß©‡ß¶ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶ü‡¶ø ‡¶´‡ßá‡¶∞‡¶§ ‡¶¶‡¶ø‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®‡•§ ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶Ö‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§ ‡¶è‡¶¨‡¶Ç ‡¶è‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡ßá‡¶ú‡¶ø‡¶Ç‡¶Ø‡¶º‡ßá ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§
                    </p>
                    <h3 class="text-xl font-bold text-theme-purple">‡¶´‡ßá‡¶∞‡¶§‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ:</h3>
                    <ol class="list-decimal list-inside text-gray-700 dark:text-gray-300 space-y-2">
                        <li>‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡ßá‡¶¨‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶´‡ßá‡¶∞‡¶§‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶ú‡¶æ‡¶®‡¶æ‡¶®‡•§</li>
                        <li>‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶¶‡¶≤ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶≤‡ßã‡¶ö‡¶®‡¶æ ‡¶ï‡¶∞‡¶¨‡ßá ‡¶è‡¶¨‡¶Ç ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶™‡ßç‡¶∞‡¶¶‡¶æ‡¶® ‡¶ï‡¶∞‡¶¨‡ßá‡•§</li>
                        <li>‡¶®‡¶ø‡¶∞‡ßç‡¶ß‡¶æ‡¶∞‡¶ø‡¶§ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ‡¶Ø‡¶º ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßç‡¶Ø‡¶æ‡¶ï‡¶ø‡¶Ç ‡¶ï‡¶∞‡ßá ‡¶´‡ßá‡¶∞‡¶§ ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡•§</li>
                        <li>‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶π‡¶æ‡¶§‡ßá ‡¶™‡ßå‡¶Å‡¶õ‡¶æ‡¶®‡ßã‡¶∞ ‡¶™‡¶∞, ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶´‡ßá‡¶∞‡¶§ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶¨‡•§</li>
                    </ol>
                </div>
            </section>
        </div>

        <!-- Shipping Info Page -->
        <div id="shipping-info-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full">‡¶∂‡¶ø‡¶™‡¶ø‡¶Ç ‡¶§‡¶•‡ßç‡¶Ø</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-6">
                    <h3 class="text-xl font-bold text-theme-purple">‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶∏‡¶Æ‡¶Ø‡¶º:</h3>
                    <p class="text-gray-700 dark:text-gray-300">
                        ‡¶∂‡¶π‡¶∞‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá: ‡ß®-‡ß© ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶¶‡¶ø‡¶¨‡¶∏ <br>
                        ‡¶∂‡¶π‡¶∞‡ßá‡¶∞ ‡¶¨‡¶æ‡¶á‡¶∞‡ßá: ‡ß´-‡ß≠ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶¶‡¶ø‡¶¨‡¶∏
                    </p>
                    <h3 class="text-xl font-bold text-theme-purple">‡¶∂‡¶ø‡¶™‡¶ø‡¶Ç ‡¶ñ‡¶∞‡¶ö:</h3>
                    <p class="text-gray-700 dark:text-gray-300">
                        ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶ñ‡¶∞‡¶ö ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶è‡¶≤‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶â‡¶™‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶≠‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶≠‡¶ø‡¶®‡ßç‡¶® ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá‡•§ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶ö‡ßá‡¶ï‡¶Ü‡¶â‡¶ü ‡¶™‡ßá‡¶ú‡ßá ‡¶∏‡¶†‡¶ø‡¶ï ‡¶ñ‡¶∞‡¶ö ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡¶™‡¶æ‡¶¨‡ßá‡¶®‡•§
                    </p>
                </div>
            </section>
        </div>

        <!-- Privacy Policy Page -->
        <div id="privacy-policy-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full">‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º‡¶§‡¶æ ‡¶®‡ßÄ‡¶§‡¶ø</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-6">
                    <p class="text-lg leading-relaxed text-gray-700 dark:text-gray-300">
                        TangailBuzz ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡¶•‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º‡¶§‡¶æ ‡¶∞‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶∂‡ßç‡¶∞‡ßÅ‡¶§‡¶ø‡¶¨‡¶¶‡ßç‡¶ß‡•§ ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶ï‡ßç‡¶§‡¶ø‡¶ó‡¶§ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶∑‡ßá‡¶¨‡¶æ ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶ø‡•§
                    </p>
                    <h3 class="text-xl font-bold text-theme-purple">‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π:</h3>
                    <p class="text-gray-700 dark:text-gray-300">
                        ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ, ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ, ‡¶á‡¶Æ‡ßá‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡¶ø ‡¶Ø‡¶ñ‡¶® ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá‡¶® ‡¶¨‡¶æ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶¶‡ßá‡¶®‡•§
                    </p>
                </div>
            </section>
        </div>

        <!-- Terms and Conditions Page -->
        <div id="terms-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <h2 class="text-3xl md:text-4xl font-bold text-center mb-10 relative after:content-[''] after:absolute after:bottom-[-10px] after:left-1/2 after:-translate-x-1/2 after:w-20 after:h-1 after:bg-theme-pink after:rounded-full">‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ</h2>
                <div class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-3xl shadow-xl space-y-6">
                    <p class="text-lg leading-relaxed text-gray-700 dark:text-gray-300">
                        TangailBuzz ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá, ‡¶Ü‡¶™‡¶®‡¶ø ‡¶®‡¶ø‡¶Æ‡ßç‡¶®‡¶≤‡¶ø‡¶ñ‡¶ø‡¶§ ‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ‡¶§‡ßá ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§ ‡¶π‡¶®‡•§
                    </p>
                    <h3 class="text-xl font-bold text-theme-purple">‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞:</h3>
                    <p class="text-gray-700 dark:text-gray-300">
                        ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º‡¶§‡¶æ ‡¶∞‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶∞‡ßÇ‡¶™‡ßá ‡¶¶‡¶æ‡¶Ø‡¶º‡ßÄ‡•§
                    </p>
                    <h3 class="text-xl font-bold text-theme-purple">‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£:</h3>
                    <p class="text-gray-700 dark:text-gray-300">
                        ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶ì‡¶Ø‡¶º‡ßá‡¶¨‡¶∏‡¶æ‡¶á‡¶ü‡ßá ‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£ ‡¶∏‡¶∞‡¶¨‡¶∞‡¶æ‡¶π ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶ø‡•§ ‡¶§‡¶¨‡ßá, ‡¶ï‡ßã‡¶®‡ßã ‡¶≠‡ßÅ‡¶≤ ‡¶¨‡¶æ ‡¶Ö‡¶Æ‡¶ø‡¶≤ ‡¶π‡¶≤‡ßá ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶§‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¶‡¶æ‡¶Ø‡¶º‡ßÄ ‡¶•‡¶æ‡¶ï‡¶¨ ‡¶®‡¶æ‡•§
                    </p>
                </div>
            </section>
        </div>

        <!-- Support Page -->
        <div id="support-page" class="hidden page">
            <section class="container mx-auto px-4 py-16">
                <div class="max-w-3xl mx-auto text-center mb-12">
                    <h2 class="text-3xl sm:text-4xl font-bold text-theme-purple" data-lang="support-title">Get Support</h2>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Live Chat Card -->
                    <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-xl p-6 border dark:border-gray-700 flex flex-col">
                        <div class="w-12 h-12 rounded-2xl bg-theme-blue text-white flex items-center justify-center mb-4">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-1" data-lang="support-live-chat">Live Chat</h3>
                        <p class="text-gray-600 dark:text-gray-300" data-lang="support-live-chat-desc">‡¶§‡¶æ‡ßé‡¶ï‡ßç‡¶∑‡¶£‡¶ø‡¶ï ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2" data-lang="support-live-chat-hours">‡¶∏‡¶Æ‡ßü: ‡¶∏‡¶ï‡¶æ‡¶≤ ‡ßß‡ß¶‡¶ü‡¶æ - ‡¶∞‡¶æ‡¶§ ‡ßÆ‡¶ü‡¶æ</p>
                        <button onclick="showPage('emergency-chat-page')" class="mt-4 inline-flex items-center justify-center gap-2 bg-theme-pink text-white px-4 py-2 rounded-full hover:bg-theme-purple transition-colors">
                            <span data-lang="support-start-chat">Start Chat</span>
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>

                    <!-- Email Card -->
                    <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-xl p-6 border dark:border-gray-700 flex flex-col">
                        <div class="w-12 h-12 rounded-2xl bg-theme-purple text-white flex items-center justify-center mb-4">
                            <i class="fas fa-envelope-open-text"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-1" data-lang="support-email">Email Support</h3>
                        <p class="text-gray-600 dark:text-gray-300" data-lang="support-email-desc">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶¨‡¶æ ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2" data-lang="support-email-sla">‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á‡ßü‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü: ‡ß®‡ß™ ‡¶ò‡¶£‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá</p>
                        <a href="mailto:tangailbuzz.bd@gmail.com" class="mt-4 inline-flex items-center justify-center gap-2 bg-theme-blue text-white px-4 py-2 rounded-full hover:bg-theme-purple transition-colors">
                            <span data-lang="support-send-email">Send Email</span>
                            <i class="fas fa-paper-plane"></i>
                        </a>
                    </div>

                    <!-- Phone Call Card -->
                    <div class="bg-white dark:bg-gray-800 rounded-3xl shadow-xl p-6 border dark:border-gray-700 flex flex-col">
                        <div class="w-12 h-12 rounded-2xl bg-theme-pink text-white flex items-center justify-center mb-4">
                            <i class="fas fa-phone-volume"></i>
                        </div>
                        <h3 class="text-xl font-semibold mb-1" data-lang="support-phone">Phone Call</h3>
                        <p class="text-gray-600 dark:text-gray-300" data-lang="support-phone-desc">‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡¶æ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶§ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø</p>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-2" data-lang="support-phone-hours">‡¶∏‡¶Æ‡ßü: ‡¶∏‡¶ï‡¶æ‡¶≤ ‡ßß‡ß¶‡¶ü‡¶æ - ‡¶∏‡¶®‡ßç‡¶ß‡ßç‡¶Ø‡¶æ ‡ß¨‡¶ü‡¶æ</p>
                        <a href="tel:+8801863205976" class="mt-4 inline-flex items-center justify-center gap-2 bg-theme-blue text-white px-4 py-2 rounded-full hover:bg-theme-purple transition-colors">
                            <span data-lang="support-call-now">Call Now</span>
                            <i class="fas fa-phone"></i>
                        </a>
                    </div>
                </div>
            </section>
        </div>


    </main> <!-- End Main Content Container -->

    <!-- Footer -->
    <footer class="bg-dark text-white py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-8">
                <!-- Column 1 -->
                <div>
                    <h3 class="text-xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block">TangailBuzz</h3>
                    <p class="text-gray-400 text-sm">‡¶∏‡¶æ‡¶∂‡ßç‡¶∞‡¶Ø‡¶º‡ßÄ ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø‡ßá ‡¶Æ‡¶æ‡¶®‡¶∏‡¶Æ‡ßç‡¶Æ‡¶§ ‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶∏‡ßç‡¶§ ‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ‡¶∞ ‡¶ó‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø‡•§</p>
                    <div class="flex gap-4 mt-4">
                        <a href="#" class="w-10 h-10 flex items-center justify-center bg-gray-700 rounded-full text-white hover:bg-theme-pink transition-colors"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="w-10 h-10 flex items-center justify-center bg-gray-700 rounded-full text-white hover:bg-theme-pink transition-colors"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="w-10 h-10 flex items-center justify-center bg-gray-700 rounded-full text-white hover:bg-theme-pink transition-colors"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="w-10 h-10 flex items-center justify-center bg-gray-700 rounded-full text-white hover:bg-theme-pink transition-colors"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>

                <!-- Column 2 -->
                <div>
                    <h3 class="text-xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block">‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï</h3>
                    <ul class="list-none text-gray-400 text-sm space-y-2">
                        <li><a href="javascript:void(0);" onclick="renderAllProducts()" class="hover:text-theme-pink transition-colors">‡¶π‡ßã‡¶Æ</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('home-page'); scrollToElement('products')" class="hover:text-theme-pink transition-colors" data-lang="footer-nav-products">Products</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('home-page'); scrollToElement('categories')" class="hover:text-theme-pink transition-colors" data-lang="footer-nav-categories">Categories</a></li>
                        <li><a href="javascript:void(0);" onclick="showOffers()" class="hover:text-theme-pink transition-colors" data-lang="footer-nav-offers">Offers</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('about-us-page')" class="hover:text-theme-pink transition-colors" data-lang="footer-nav-about">About Us</a></li>
                    </ul>
                </div>

                <!-- Column 3 -->
                <div>
                    <h3 class="text-xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block" data-lang="footer-col-customer-service">Customer Service</h3>
                    <ul class="list-none text-gray-400 text-sm space-y-2">
                        <li><a href="javascript:void(0);" onclick="showPage('faq-page')" class="hover:text-theme-pink transition-colors" data-lang="footer-faq">FAQ</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('return-policy-page')" class="hover:text-theme-pink transition-colors" data-lang="footer-return-policy">Return Policy</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('shipping-info-page')" class="hover:text-theme-pink transition-colors" data-lang="footer-shipping-info">Shipping Info</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('privacy-policy-page')" class="hover:text-theme-pink transition-colors" data-lang="footer-privacy-policy">Privacy Policy</a></li>
                        <li><a href="javascript:void(0);" onclick="showPage('terms-page')" class="hover:text-theme-pink transition-colors" data-lang="footer-terms">Terms & Conditions</a></li>
                    </ul>
                </div>

                <!-- Column 4 -->
                <div>
                    <h3 class="text-xl font-bold mb-4 border-b-2 border-theme-pink pb-2 inline-block" data-lang="footer-col-contact">Contact Us</h3>
                    <ul class="list-none text-gray-400 text-sm space-y-2">
                         <li class="flex items-center">
                            <i class="fas fa-map-marker-alt mr-2 text-theme-pink"></i>
                            <a href="https://www.google.com/maps/search/?api=1&query=Tangail+Sadar" target="_blank" rel="noopener noreferrer" class="hover:text-theme-pink transition-colors">tangail sadar, tangail</a>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-phone mr-2 text-theme-pink"></i>
                            <a href="tel:+8801863205976" class="hover:text-theme-pink transition-colors">+8801863205976</a>
                        </li>
                        <li class="flex items-center">
                            <i class="fas fa-envelope mr-2 text-theme-pink"></i>
                            <a href="mailto:tangailbuzz.bd@gmail.com" class="hover:text-theme-pink transition-colors">tangailbuzz.bd@gmail.com</a>
                        </li>
                    </ul>
                </div>
            </div>

             <div class="mt-8 pt-8 border-t border-gray-700">
                <h3 class="text-xl font-bold mb-4 text-center" data-lang="footer-we-accept">We Accept</h3>
                <div class="flex flex-wrap justify-center items-center gap-4">
                    <img src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/unnamed.webp?raw=true" alt="bKash" class="h-8 object-contain">
                    <img src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/nagad.jpg?raw=true" alt="Nagad" class="h-8 object-contain">
                    <img src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/rocket.png?raw=true" alt="Rocket" class="h-8 object-contain">
                    <img src="https://github.com/tangailbuzzbd-svg/TangailBuzz-Picture-/blob/main/surecash.png?raw=true" alt="SureCash" class="h-8 object-contain">
                </div>
            </div>

             <div class="text-center pt-8 border-t border-gray-700 mt-8">
                <p class="text-gray-400 text-xs" data-lang="footer-copyright">¬© 2024 TangailBuzz. All rights reserved.</p>
             </div>
        </div>
    </footer>

    <!-- Firebase SDK Scripts (Modular v9+) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, FacebookAuthProvider, signInWithPopup, signOut, createUserWithEmailAndPassword, signInWithEmailAndPassword, updateProfile, deleteUser, signInWithCustomToken, signInAnonymously, sendPasswordResetEmail, reauthenticateWithCredential, EmailAuthProvider, reauthenticateWithPopup, fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, deleteDoc, onSnapshot, updateDoc, increment, deleteField, collection, addDoc, serverTimestamp, getDocs, writeBatch, runTransaction, query, where, arrayUnion, orderBy, limit, FieldPath } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
    // Firebase initialization
        const firebaseConfig = {
            apiKey: "AIzaSyBIRNr3X-_xOHQ6ITW3pXgqgcjhP2xEEEA",
            authDomain: "tangailbuzz47.firebaseapp.com",
            projectId: "tangailbuzz47",
            storageBucket: "tangailbuzz47.firebasestorage.app",
            messagingSenderId: "1017968115713",
            appId: "1:1017968115713:web:967a0e13107d8816b44000",
            measurementId: "G-7HYDCZTN2H"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

    let currentUser = null;
        let currentUserData = null; // To hold Firestore data for the user
        let userOrders = [];
        let userDocUnsubscribe = () => {};
        let currentLanguage = 'bn';
        let localCartCache = new Map();
        let localWishlistCache = new Set();
    let productsData = []; // Will be populated from Firestore
    let renderContext = null; // Controls render behavior for specific pages (e.g., 'wishlist')
        let currentDisplayedProducts = [];
        let selectedVariants = {};
        let discountAmount = 0;
        let appliedCouponCode = null;
    let confirmResolver = null; // Used for the custom confirmation modal
        let chatUnsubscribe = () => {}; // For real-time chat updates
        let allCoupons = []; // Stores all active coupon data
        // Addresses & shipping selection
        let selectedShippingAddressId = null;
        let selectedShippingAddress = null;
    // Sorting & Filtering State
    let currentSortOption = 'popularity'; // 'price-asc' | 'price-desc' | 'popularity' | 'rating' | 'newest'
    let activeFilters = { brands: new Set(), priceMin: null, priceMax: null, sizes: new Set(), colors: new Set() };
    let lastBaseProducts = [];
        // --- Pagination State ---
        let currentPage = 1;           // current page index (1-based)
        const PAGE_SIZE = 30;          // items per page
        let lastRenderKey = '';        // to reset page when base set changes
        // --- End Pagination State ---
        
        // --- Category Tracking State ---
        let currentCategory = null; // Tracks current main category filter
        let currentSubCategory = null; // Tracks current sub category filter
        // --- End Category Tracking State ---
        
        // --- User Blocking Logic ---
        let isCurrentUserBlocked = false;
        let unsubscribeUserStatus = () => {};

        const translations = {
            en: {
                'deliver-to': 'Deliver to', 'home': 'Home', 'products': 'Products', 'categories': 'Categories', 'offers': 'Offers', 'search-placeholder': 'Search for products...', 'featured-products': 'Featured Products', 'shop-by-category': 'Shop by Category', 'cat-electronics': 'Electronics', 'cat-fashion': 'Fashion', 'cat-home-garden': 'Home & Garden', 'cat-health-beauty': 'Health & Beauty', 'cat-sports': 'Sports & Outdoors', 'cat-books': 'Books & Stationery', 'cat-kids': 'Kids & Toys', 'cat-cars': 'Cars & Bikes', 'why-choose-us': 'Why Choose Us', 'feature-delivery-title': 'Fast Delivery', 'feature-delivery-desc': 'We deliver to your doorstep within 2-3 business days.', 'feature-payment-title': 'Secure Payment', 'feature-payment-desc': 'All transactions are encrypted for your security and privacy.', 'feature-return-title': 'Easy Returns', 'feature-return-desc': 'Return products within 30 days for a full refund if you\'re not satisfied.', 'feature-support-title': '24/7 Support', 'feature-support-desc': 'Our customer support team is available for you day and night.', 'add-to-cart': 'Add to Cart', 'added-to-cart': 'Added!', 'no-products': 'No products found matching your criteria.', 'back-to-products': 'Back to All Products', 'returnable': '30-Day Returnable', 'not-returnable': 'Not Returnable', 'secure-payments': 'Secure Payments', 'size': 'Size:', 'storage': 'Storage:', 'color': 'Color:', 'product-description': 'Product Description', 'product-specifications': 'Product Specifications', 'specifications': 'Specification', 'value': 'Value', 'no-specs': 'No specifications available for this product.', 'product-reviews': 'Product Reviews', 'no-reviews': 'There are no reviews for this product yet.', 'cart': 'Your Cart', 'cart-empty': 'Your cart is empty.', 'total': 'Total:', 'checkout': 'Checkout', 'your-wishlist': 'Your Wishlist', 'wishlist-empty': 'Your wishlist is empty. Add some products!', 'your-account': 'Your Account', 'signin-google': 'Sign in with Google', 'logout': 'Logout', 'toast-cart-added': 'Product added to cart!', 'toast-wishlist-added': 'Product added to wishlist!', 'toast-wishlist-removed': 'Product removed from wishlist!', 'toast-login-success': 'Successfully logged in!', 'toast-logout-success': 'Successfully logged out!',
                'toast-register-success': 'Account created successfully!', 'login': 'Login', 'register': 'Register Account', 'toast-select-variant': 'Please select all required options!', 'payment-method': 'Select Payment Method', 'cod': 'Cash on Delivery', 'online-payment': 'Online Payment', 'confirm-order': 'Confirm Order', 'order-placed-success': 'Your order has been placed successfully!', 'order-placed-fail': 'Failed to place order. Please try again.', 'cart-is-empty': 'Your cart is empty. Cannot checkout.', 'mobile-banking': 'Mobile Banking', 'payment-instruction-bkash': 'Please send {amount} Taka to this Bkash number: +8801863205976 from your app.', 'payment-instruction-nagad': 'Please send {amount} Taka to this Nagad number: +8801863205976 from your app.', 'payment-instruction-cod': 'Our delivery person will collect the payment upon delivery.', 'profile-updated': 'Profile updated successfully!', 'profile-update-fail': 'Failed to update profile.', 'toast-storage-permission-error': 'Storage permission denied. Check Firebase rules.', 'toast-update-profile': 'Please update your location and mobile number in your profile before ordering.', 'emergency-contact': 'Support', 'message-sent': 'Message sent successfully!', 'out-of-stock': 'Out of Stock', 'toast-out-of-stock': 'Sorry, this product is currently out of stock.', 'subtotal': 'Subtotal', 'delivery-charge': 'Delivery Charge', 'my-orders': 'My Orders',
                'delete-account-confirm': 'Are you sure you want to delete your account? This action cannot be undone. All data will be lost.',
                'account-deleted': 'Your account has been successfully deleted.',
                'delete-account-failed': 'Failed to delete account. Please try again.',
                'confirm-delete-title': '‚ö†Ô∏è Permanently Delete Account',
                'chat-unauthorized': 'Please log in to start a conversation with the admin.',
                'chat-send': 'Send',
                'chat-placeholder': 'Type your message...',
                'toast-abusive-language': 'Abusive language is not allowed.',
                'account-blocked': 'Your account is blocked. You cannot place orders or send messages.',
                'account-blocked-banner': 'Your account has been blocked by an administrator. Please contact support.',
                'toast-account-blocked-action': 'Action failed: Your account is blocked.',
                'coupon-placeholder': 'Coupon Code', 'apply-coupon': 'Apply', 'discount': 'Discount', 'order-summary': 'Order Summary', 'total-inclusive-vat': 'Total (Inclusive of VAT)',
                'toast-coupon-applied': 'Coupon applied successfully!', 'toast-coupon-invalid': 'Invalid or expired coupon code.',
                'toast-coupon-used': 'You have already used this coupon.', 'toast-coupon-min-purchase': 'Minimum purchase of ‡ß≥{amount} required.',
                'warranty': '{text} Warranty', // Updated key for text string
                'no-warranty': 'No Warranty', // Updated key
                'model-id': 'Product ID: {id}', // FIX: Changed 'Model:' to 'Product ID:'
                'available-coupons': 'Available Coupons', 'min-spend': 'Min Spend', 'discount-value': 'Discount', 'tap-to-copy': 'Tap to Copy', 'copied': 'Copied!',
                'all-products': 'All Products',
                'current-category-title': '{category}',
                'sub-category-filter': 'Filter by Sub-Category:',
                'write-a-review': 'Write a Review',
                'your-rating': 'Your Rating:',
                'your-comment': 'Your Comment:',
                'submit-review': 'Submit Review',
                'review-login-prompt': 'Please log in to submit a review.',
                'review-success': 'Review submitted successfully! Thank you.',
                'review-failed': 'Failed to submit review. Please try again.',
                // Category helpers
                'all-in-category': 'All in',
                // Footer
                'footer-nav-home': 'Home',
                'footer-nav-products': 'Products',
                'footer-nav-categories': 'Categories',
                'footer-nav-offers': 'Offers',
                'footer-nav-about': 'About Us',
                'footer-col-customer-service': 'Customer Service',
                'footer-faq': 'FAQ',
                'footer-return-policy': 'Return Policy',
                'footer-shipping-info': 'Shipping Info',
                'footer-privacy-policy': 'Privacy Policy',
                'footer-terms': 'Terms & Conditions',
                'footer-col-contact': 'Contact Us',
                'footer-we-accept': 'We Accept',
                'footer-copyright': '¬© 2024 TangailBuzz. All rights reserved.',
                // Header short labels
                'dark-mode': 'Dark Mode',
                'profile': 'Profile',
                'wishlist': 'Wishlist',
                'cart-short': 'Cart',
                'remove': 'Remove',
                // Hero
                'hero-title': 'Find your style. Shop the buzz.',
                'hero-subtitle': 'Exclusive deals, fast delivery, and trusted products across electronics, fashion, and more.',
                'hero-cta-shop': 'Shop Now',
                'hero-cta-browse': 'Browse Categories',
                'hero-badge': 'Fresh arrivals daily',
                // Support page
                'support-title': 'Get Support',
                'support-live-chat': 'Live Chat',
                'support-live-chat-desc': 'For instant support',
                'support-live-chat-hours': 'Hours: 10:00 AM - 8:00 PM',
                'support-start-chat': 'Start Chat',
                'support-email': 'Email Support',
                'support-email-desc': 'For detailed issues or complaints',
                'support-email-sla': 'Response time: within 24 hours',
                'support-send-email': 'Send Email',
                'support-phone': 'Phone Call',
                'support-phone-desc': 'For urgent payment or order issues only',
                'support-phone-hours': 'Hours: 10:00 AM - 6:00 PM',
                'support-call-now': 'Call Now',
            },
            bn: {
                'deliver-to': '‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶®', 'home': '‡¶π‡ßã‡¶Æ', 'products': '‡¶™‡¶£‡ßç‡¶Ø', 'categories': '‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø', 'offers': '‡¶Ö‡¶´‡¶æ‡¶∞', 'search-placeholder': '‡¶™‡¶£‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...', 'featured-products': '‡¶¨‡ßà‡¶∂‡¶ø‡¶∑‡ßç‡¶ü‡ßç‡¶Ø‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶™‡¶£‡ßç‡¶Ø', 'shop-by-category': '‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶æ‡¶∞‡ßá ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®', 'cat-electronics': '‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï‡ßç‡¶∏', 'cat-fashion': '‡¶´‡ßç‡¶Ø‡¶æ‡¶∂‡¶®', 'cat-home-garden': '‡¶π‡ßã‡¶Æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶° ‡¶ó‡¶æ‡¶∞‡ßç‡¶°‡ßá‡¶®', 'cat-health-beauty': '‡¶∏‡ßç‡¶¨‡¶æ‡¶∏‡ßç‡¶•‡ßç‡¶Ø ‡¶ì ‡¶∏‡ßå‡¶®‡ßç‡¶¶‡¶∞‡ßç‡¶Ø', 'cat-sports': '‡¶ñ‡ßá‡¶≤‡¶æ‡¶ß‡ßÅ‡¶≤‡¶æ ‡¶ì ‡¶Ü‡¶â‡¶ü‡¶°‡ßã‡¶∞', 'cat-books': '‡¶¨‡¶á ‡¶ì ‡¶∏‡ßç‡¶ü‡ßá‡¶∂‡¶®‡¶æ‡¶∞‡¶ø', 'cat-kids': '‡¶¨‡¶æ‡¶ö‡ßç‡¶ö‡¶æ ‡¶ì ‡¶ñ‡ßá‡¶≤‡¶®‡¶æ', 'cat-cars': '‡¶ó‡¶æ‡¶°‡¶º‡¶ø ‡¶ì ‡¶¨‡¶æ‡¶á‡¶ï', 'why-choose-us': '‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞‡¶ï‡ßá ‡¶ï‡ßá‡¶® ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶¨‡ßá‡¶®', 'feature-delivery-title': '‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø', 'feature-delivery-desc': '‡¶Ü‡¶Æ‡¶∞‡¶æ ‡ß®-‡ß© ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶¶‡¶ø‡¶¨‡¶∏‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡ßã‡¶∞‡¶ó‡ßã‡¶°‡¶º‡¶æ‡¶Ø‡¶º ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡ßå‡¶Å‡¶õ‡ßá ‡¶¶‡¶ø‡¶á‡•§', 'feature-payment-title': '‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü', 'feature-payment-desc': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶ì ‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º‡¶§‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶ï‡¶≤ ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶è‡¶®‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü‡ßá‡¶°‡•§', 'feature-return-title': '‡¶∏‡¶π‡¶ú ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶®', 'feature-return-desc': '‡¶™‡¶õ‡¶®‡ßç‡¶¶ ‡¶®‡¶æ ‡¶π‡¶≤‡ßá ‡ß©‡ß¶ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶™‡¶£‡ßç‡¶Ø ‡¶´‡ßá‡¶∞‡¶§ ‡¶¶‡¶ø‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø ‡¶´‡ßá‡¶∞‡¶§ ‡¶™‡¶æ‡¶®‡•§', 'feature-support-title': '‡ß®‡ß™/‡ß≠ ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü', 'feature-support-desc': '‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡¶π‡¶æ‡¶Ø‡¶º‡¶§‡¶æ ‡¶¶‡¶≤ ‡¶¶‡¶ø‡¶®‡¶∞‡¶æ‡¶§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß‡•§', 'add-to-cart': '‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®', 'added-to-cart': '‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'no-products': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∏‡¶®‡ßç‡¶ß‡¶æ‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Æ‡ßá‡¶≤‡ßá ‡¶è‡¶Æ‡¶® ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§', 'back-to-products': '‡¶∏‡¶ï‡¶≤ ‡¶™‡¶£‡ßç‡¶Ø‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®', 'returnable': '‡ß©‡ß¶-‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶´‡ßá‡¶∞‡¶§‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø', 'not-returnable': '‡¶´‡ßá‡¶∞‡¶§‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶®‡¶Ø‡¶º', 'secure-payments': '‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü', 'size': '‡¶∏‡¶æ‡¶á‡¶ú:', 'storage': '‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú:', 'color': '‡¶∞‡¶ô:', 'product-description': '‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶¨‡¶ø‡¶¨‡¶∞‡¶£', 'product-specifications': '‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶∏‡ßç‡¶™‡ßá‡¶∏‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®', 'specifications': '‡¶∏‡ßç‡¶™‡ßá‡¶∏‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®', 'value': '‡¶Æ‡¶æ‡¶®', 'no-specs': '‡¶è‡¶á ‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡ßã‡¶® ‡¶∏‡ßç‡¶™‡ßá‡¶∏‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶®‡ßá‡¶á‡•§', 'product-reviews': '‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â', 'no-reviews': '‡¶è‡¶á ‡¶™‡¶£‡ßç‡¶Ø‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶®‡ßá‡¶á‡•§', 'cart': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü', 'cart-empty': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø‡•§', 'total': '‡¶Æ‡ßã‡¶ü ‡¶Æ‡ßÇ‡¶≤‡ßç‡¶Ø:', 'checkout': '‡¶ö‡ßá‡¶ï‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®', 'your-wishlist': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶á‡¶∂‡¶≤‡¶ø‡¶∏‡ßç‡¶ü', 'wishlist-empty': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶á‡¶∂‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø‡•§ ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶™‡¶£‡ßç‡¶Ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®!', 'your-account': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü', 'signin-google': 'Google ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∏‡¶æ‡¶á‡¶® ‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', 'logout': '‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü', 'toast-cart-added': '‡¶™‡¶£‡ßç‡¶Ø ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'toast-wishlist-added': '‡¶™‡¶£‡ßç‡¶Ø ‡¶â‡¶á‡¶∂‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'toast-wishlist-removed': '‡¶™‡¶£‡ßç‡¶Ø ‡¶â‡¶á‡¶∂‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶∞‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'toast-login-success': '‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'toast-logout-success': '‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!',
                'toast-register-success': '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'login': '‡¶≤‡¶ó‡¶á‡¶®', 'register': '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡¶æ‡¶∞', 'toast-select-variant': '‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡¶¨ ‡¶Ö‡¶™‡¶∂‡¶® ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!', 'payment-method': '‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶™‡¶¶‡ßç‡¶ß‡¶§‡¶ø ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®', 'cod': '‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶Ö‡¶® ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø', 'online-payment': '‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü', 'confirm-order': '‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®', 'order-placed-success': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞‡¶ü‡¶ø ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'order-placed-fail': '‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'cart-is-empty': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶ü ‡¶ñ‡¶æ‡¶≤‡¶ø‡•§ ‡¶ö‡ßá‡¶ï‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶®‡¶Ø‡¶º‡•§', 'mobile-banking': '‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï‡¶ø‡¶Ç', 'payment-instruction-bkash': '‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶•‡ßá‡¶ï‡ßá ‡¶è‡¶á ‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡ßá ‡ß≥{amount} ‡¶™‡¶æ‡¶†‡¶æ‡¶®: +8801863205976‡•§', 'payment-instruction-nagad': '‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶•‡ßá‡¶ï‡ßá ‡¶è‡¶á ‡¶®‡¶ó‡¶¶ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞‡ßá ‡ß≥{amount} ‡¶™‡¶æ‡¶†‡¶æ‡¶®: +8801863205976‡•§', 'payment-instruction-cod': '‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶®‡¶ø‡¶ß‡¶ø ‡¶™‡¶£‡ßç‡¶Ø ‡¶™‡ßå‡¶Å‡¶õ‡¶æ‡¶®‡ßã‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡¶¨‡ßá‡•§', 'profile-updated': '‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'profile-update-fail': '‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§', 'toast-storage-permission-error': '‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡ßá‡¶ú ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá Firebase ‡¶∞‡ßÅ‡¶≤‡¶∏ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'toast-update-profile': '‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡ßá ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶ì ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®‡•§', 'emergency-contact': '‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü', 'message-sent': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'out-of-stock': '‡¶∏‡ßç‡¶ü‡¶ï ‡¶∂‡ßá‡¶∑', 'toast-out-of-stock': '‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶è‡¶á ‡¶™‡¶£‡ßç‡¶Ø‡¶ü‡¶ø ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶®‡ßá ‡¶∏‡ßç‡¶ü‡¶ï ‡¶Ü‡¶â‡¶ü‡•§', 'subtotal': '‡¶Æ‡ßã‡¶ü', 'delivery-charge': '‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶ö‡¶æ‡¶∞‡ßç‡¶ú', 'my-orders': '‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞',
                'delete-account-confirm': '‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡¶ü‡¶ø ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶á ‡¶ï‡¶æ‡¶ú‡¶ü‡¶ø ‡¶´‡¶ø‡¶∞‡¶ø‡¶Ø‡¶º‡ßá ‡¶Ü‡¶®‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶°‡ßá‡¶ü‡¶æ ‡¶π‡¶æ‡¶∞‡¶æ‡¶®‡ßã ‡¶π‡¶¨‡ßá‡•§',
                'account-deleted': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§',
                'delete-account-failed': '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§',
                'confirm-delete-title': '‚ö†Ô∏è ‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º‡ßÄ‡¶≠‡¶æ‡¶¨‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®',
                'chat-unauthorized': '‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶ï‡¶•‡¶æ ‡¶¨‡¶≤‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§',
                'chat-send': '‡¶™‡¶æ‡¶†‡¶æ‡¶®',
                'chat-placeholder': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®...',
                'toast-abusive-language': '‡¶Ü‡¶™‡¶§‡ßç‡¶§‡¶ø‡¶ï‡¶∞ ‡¶≠‡¶æ‡¶∑‡¶æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§',
                'account-blocked': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶¨‡¶æ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶® ‡¶®‡¶æ‡•§',
                'toast-account-blocked-action': 'Action failed: Your account is blocked.',
                'coupon-placeholder': '‡¶ï‡ßÅ‡¶™‡¶® ‡¶ï‡ßã‡¶°', 'apply-coupon': '‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó', 'discount': '‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü', 'order-summary': '‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂', 'total-inclusive-vat': '‡¶Æ‡ßã‡¶ü (‡¶≠‡ßç‡¶Ø‡¶æ‡¶ü‡¶∏‡¶π)',
                'toast-coupon-applied': '‡¶ï‡ßÅ‡¶™‡¶® ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!', 'toast-coupon-invalid': '‡¶Ö‡¶¨‡ßà‡¶ß ‡¶¨‡¶æ ‡¶Æ‡ßá‡¶Ø‡¶º‡¶æ‡¶¶‡ßã‡¶§‡ßç‡¶§‡ßÄ‡¶∞‡ßç‡¶£ ‡¶ï‡ßÅ‡¶™‡¶® ‡¶ï‡ßã‡¶°‡•§',
                'toast-coupon-used': '‡¶Ü‡¶™‡¶®‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶è‡¶á ‡¶ï‡ßÅ‡¶™‡¶® ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§', 'toast-coupon-min-purchase': '‡¶è‡¶á ‡¶ï‡ßÅ‡¶™‡¶®‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡ß≥{amount} ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§',
                'warranty': '{text} ‡¶ì‡ßü‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü‡¶ø', // Updated key for text string
                'no-warranty': '‡¶ï‡ßã‡¶®‡ßã ‡¶ì‡ßü‡¶æ‡¶∞‡ßá‡¶®‡ßç‡¶ü‡¶ø ‡¶®‡ßá‡¶á', // Updated key
                'model-id': '‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Ü‡¶á‡¶°‡¶ø: {id}', // FIX: Changed '‡¶Æ‡¶°‡ßá‡¶≤ ‡¶Ü‡¶á‡¶°‡¶ø:' to '‡¶™‡ßç‡¶∞‡ßã‡¶°‡¶æ‡¶ï‡ßç‡¶ü ‡¶Ü‡¶á‡¶°‡¶ø:'
                'available-coupons': '‡¶â‡¶™‡¶≤‡¶¨‡ßç‡¶ß ‡¶ï‡ßÅ‡¶™‡¶®', 'min-spend': '‡¶∏‡¶∞‡ßç‡¶¨‡¶®‡¶ø‡¶Æ‡ßç‡¶® ‡¶ñ‡¶∞‡¶ö', 'discount-value': '‡¶°‡¶ø‡¶∏‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü', 'tap-to-copy': '‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®', 'copied': '‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá!',
                'all-products': '‡¶∏‡¶ï‡¶≤ ‡¶™‡¶£‡ßç‡¶Ø',
                // Hero
                'hero-title': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®‡•§ ‡¶∂‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶¨‡¶æ‡¶ú‡¶º‡ßá‡•§',
                'hero-subtitle': '‡¶á‡¶≤‡ßá‡¶ï‡¶ü‡ßç‡¶∞‡¶®‡¶ø‡¶ï‡ßç‡¶∏, ‡¶´‡ßç‡¶Ø‡¶æ‡¶∂‡¶®‡¶∏‡¶π ‡¶®‡¶æ‡¶®‡¶æ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶§‡ßá ‡¶¨‡¶ø‡¶∂‡ßá‡¶∑ ‡¶Ö‡¶´‡¶æ‡¶∞, ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶ì ‡¶¨‡¶ø‡¶∂‡ßç‡¶¨‡¶∏‡ßç‡¶§ ‡¶™‡¶£‡ßç‡¶Ø‡•§',
                'hero-cta-shop': '‡¶è‡¶ñ‡¶®‡¶á ‡¶ï‡ßá‡¶®‡¶æ‡¶ï‡¶æ‡¶ü‡¶æ',
                'hero-cta-browse': '‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®',
                'hero-badge': '‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶¶‡¶ø‡¶® ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶®',
                'current-category-title': '{category} ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø',
                'sub-category-filter': '‡¶∏‡¶æ‡¶¨-‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®:',
                'write-a-review': '‡¶è‡¶ï‡¶ü‡¶ø ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶¶‡¶ø‡¶®',
                'your-rating': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ü‡¶ø‡¶Ç:',
                'your-comment': '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶®‡ßç‡¶§‡¶¨‡ßç‡¶Ø:',
                'submit-review': '‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®',
                'review-login-prompt': '‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§',
                'review-success': '‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá! ‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶‡•§',
                'review-failed': '‡¶∞‡¶ø‡¶≠‡¶ø‡¶â ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§',
                // Category helpers
                'all-in-category': '‡¶∏‡¶ï‡¶≤',
                // Footer
                'footer-nav-home': '‡¶π‡ßã‡¶Æ',
                'footer-nav-products': '‡¶™‡¶£‡ßç‡¶Ø',
                'footer-nav-categories': '‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø',
                'footer-nav-offers': '‡¶Ö‡¶´‡¶æ‡¶∞',
                'footer-nav-about': '‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá',
                'footer-col-customer-service': '‡¶ó‡ßç‡¶∞‡¶æ‡¶π‡¶ï ‡¶∏‡ßá‡¶¨‡¶æ',
                'footer-faq': 'FAQ',
                'footer-return-policy': '‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶®‡ßÄ‡¶§‡¶ø',
                'footer-shipping-info': '‡¶∂‡¶ø‡¶™‡¶ø‡¶Ç ‡¶§‡¶•‡ßç‡¶Ø',
                'footer-privacy-policy': '‡¶ó‡ßã‡¶™‡¶®‡ßÄ‡¶Ø‡¶º‡¶§‡¶æ ‡¶®‡ßÄ‡¶§‡¶ø',
                'footer-terms': '‡¶∂‡¶∞‡ßç‡¶§‡¶æ‡¶¨‡¶≤‡ßÄ',
                'footer-col-contact': '‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®',
                'footer-we-accept': '‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶ó‡ßç‡¶∞‡¶π‡¶£ ‡¶ï‡¶∞‡¶ø',
                'footer-copyright': '¬© ‡ß®‡ß¶‡ß®‡ß™ TangailBuzz‡•§ ‡¶∏‡¶∞‡ßç‡¶¨‡¶∏‡ßç‡¶¨‡¶§‡ßç‡¶¨ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§‡•§',
                // Header short labels
                'dark-mode': '‡¶°‡¶æ‡¶∞‡ßç‡¶ï ‡¶Æ‡ßã‡¶°',
                'profile': '‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤',
                'wishlist': '‡¶â‡¶á‡¶∂‡¶≤‡¶ø‡¶∏‡ßç‡¶ü',
                'cart-short': '‡¶ï‡¶æ‡¶∞‡ßç‡¶ü',
                'remove': '‡¶∏‡¶∞‡¶æ‡¶®',
                // Support page
                'support-title': '‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü',
                'support-live-chat': '‡¶≤‡¶æ‡¶á‡¶≠ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü',
                'support-live-chat-desc': '‡¶§‡¶æ‡ßé‡¶ï‡ßç‡¶∑‡¶£‡¶ø‡¶ï ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø',
                'support-live-chat-hours': '‡¶∏‡¶Æ‡¶Ø‡¶º: ‡¶∏‡¶ï‡¶æ‡¶≤ ‡ßß‡ß¶‡¶ü‡¶æ - ‡¶∞‡¶æ‡¶§ ‡ßÆ‡¶ü‡¶æ',
                'support-start-chat': '‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®',
                'support-email': '‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü',
                'support-email-desc': '‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶¨‡¶æ ‡¶Ö‡¶≠‡¶ø‡¶Ø‡ßã‡¶ó‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø',
                'support-email-sla': '‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡¶æ‡¶á‡¶Ø‡¶º‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶Ø‡¶º: ‡ß®‡ß™ ‡¶ò‡¶£‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá',
                'support-send-email': '‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶™‡¶æ‡¶†‡¶æ‡¶®',
                'support-phone': '‡¶´‡ßã‡¶® ‡¶ï‡¶≤',
                'support-phone-desc': '‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶ú‡¶∞‡ßÅ‡¶∞‡¶ø ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶¨‡¶æ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶ï‡ßç‡¶∞‡¶æ‡¶®‡ßç‡¶§ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø',
                'support-phone-hours': '‡¶∏‡¶Æ‡¶Ø‡¶º: ‡¶∏‡¶ï‡¶æ‡¶≤ ‡ßß‡ß¶‡¶ü‡¶æ - ‡¶∏‡¶®‡ßç‡¶ß‡ßç‡¶Ø‡¶æ ‡ß¨‡¶ü‡¶æ',
                'support-call-now': '‡¶è‡¶ñ‡¶®‡¶á ‡¶ï‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®',
            }
        };

        const DOMElements = {
            toast: document.getElementById('toast-notification'), toastMessage: document.getElementById('toast-message'), productList: document.getElementById('product-list'), cartCount: document.getElementById('cart-count'), cartItems: document.getElementById('cart-items'), cartSubtotal: document.getElementById('cart-subtotal'), deliveryCharge: document.getElementById('delivery-charge'), cartTotal: document.getElementById('cart-total'), wishlistItems: document.getElementById('wishlist-items'), authOptions: document.getElementById('auth-options'), 
            userProfileView: document.getElementById('user-profile-view'), userPhoto: document.getElementById('user-photo'), userName: document.getElementById('user-name'), userEmail: document.getElementById('user-email'), userMobile: document.getElementById('user-mobile'), userLocation: document.getElementById('user-location'),
            loginBtn: document.getElementById('login-google-btn'), loginFacebookBtn: document.getElementById('login-facebook-btn'), logoutBtn: document.getElementById('logout-btn'), 
            editProfileBtn: document.getElementById('edit-profile-btn'), editProfileForm: document.getElementById('edit-profile-form'), saveProfileBtn: document.getElementById('save-profile-btn'), cancelEditBtn: document.getElementById('cancel-edit-btn'),
            myOrdersBtnProfile: document.getElementById('my-orders-btn-profile'), 
            ordersList: document.getElementById('orders-list'),
            editPhotoPreview: document.getElementById('edit-photo-preview'), editPhotoInput: document.getElementById('edit-photo-input'), editNameInput: document.getElementById('edit-name-input'), editMobileInput: document.getElementById('edit-mobile-input'), editLocationInput: document.getElementById('edit-location-input'),
            searchInput: document.getElementById('search-input'), searchButton: document.getElementById('search-button'), searchInputMobile: document.getElementById('search-input-mobile'), searchButtonMobile: document.getElementById('search-button-mobile'), slidesContainer: document.getElementById('slides-container'), prevBtn: document.getElementById('prev-btn'), nextBtn: document.getElementById('next-btn'), indicatorContainer: document.getElementById('slider-indicators'), drawerOverlay: document.getElementById('drawer-overlay'), rightPromoImg: document.getElementById('right-promo-img'), rightPromoTitle: document.getElementById('right-promo-title'), rightPromoSubtitle: document.getElementById('right-promo-subtitle'), rightPromoLink: document.getElementById('right-promo-link'),
            loginForm: document.getElementById('login-form'), registerForm: document.getElementById('register-form'), showRegisterLink: document.getElementById('show-register-form'), showLoginLink: document.getElementById('show-login-form'), authError: document.getElementById('auth-error'), profileDrawerTitle: document.getElementById('profile-drawer-title'),
            resetForm: document.getElementById('reset-form'), resetEmail: document.getElementById('reset-email'), showResetLink: document.getElementById('show-reset-form'), showLoginFromResetLink: document.getElementById('show-login-from-reset'),
            paymentModal: document.getElementById('payment-modal'), checkoutBtn: document.getElementById('checkout-btn'), confirmOrderBtn: document.getElementById('confirm-order-btn'),
            orderSuccessModal: document.getElementById('order-success-modal'), paymentInstruction: document.getElementById('payment-instruction'), closeSuccessModalBtn: document.getElementById('close-success-modal'),
            discountRow: document.getElementById('discount-row'),
            cartDiscount: document.getElementById('cart-discount'),
            deleteAccountBtn: document.getElementById('delete-account-btn'),
            
            // Confirmation Modal Elements
            confirmationModal: document.getElementById('confirmation-modal'),
            confirmTitle: document.getElementById('confirm-title'),
            confirmMessage: document.getElementById('confirm-message'),
            confirmOkBtn: document.getElementById('confirm-ok-btn'),
            confirmCancelBtn: document.getElementById('confirm-cancel-btn'),

            // Chat Elements
            emergencyContactBtn: document.getElementById('emergency-contact-btn'),
            chatMessages: document.getElementById('chat-messages'),
            chatForm: document.getElementById('chat-form'),
            chatInput: document.getElementById('chat-input'),
            sendChatBtn: document.getElementById('send-chat-btn'),
            chatError: document.getElementById('chat-error'),
            
            // Blocked User Banner
            blockedBanner: document.getElementById('blocked-account-banner'),

            // Coupon Elements
            couponForm: document.getElementById('coupon-form'),
            couponInput: document.getElementById('coupon-input'),
            applyCouponBtn: document.getElementById('apply-coupon-btn'),
            
            // Dark Mode Elements
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            darkModeIcon: document.getElementById('dark-mode-icon'),

            // New Category Elements
            categoryHeader: document.getElementById('category-header'),
            breadcrumb: document.getElementById('breadcrumb'),
            categoryPath: document.getElementById('category-path'),
            currentCategoryTitle: document.getElementById('current-category-title'),
            subcategoryButtons: document.getElementById('subcategory-buttons'),
            // Address management elements
            manageAddressesBtn: document.getElementById('manage-addresses-btn'),
            addressesSection: document.getElementById('addresses-section'),
            addressesList: document.getElementById('addresses-list'),
            addressForm: document.getElementById('address-form'),
            addressFormTitle: document.getElementById('address-form-title'),
            addrIdHidden: document.getElementById('address-id-hidden'),
            addrName: document.getElementById('addr-name'),
            addrMobile: document.getElementById('addr-mobile'),
            addrLine1: document.getElementById('addr-line1'),
            addrLine2: document.getElementById('addr-line2'),
            addrCity: document.getElementById('addr-city'),
            addrArea: document.getElementById('addr-area'),
            addrDefault: document.getElementById('addr-default'),
            saveAddressBtn: document.getElementById('save-address-btn'),
            cancelAddressBtn: document.getElementById('cancel-address-btn'),
            // Payment modal address elements
            shippingAddressSection: document.getElementById('shipping-address-section'),
            selectedAddressDisplay: document.getElementById('selected-address-display'),
            changeAddressBtn: document.getElementById('change-address-btn'),
            addressSelectPanel: document.getElementById('address-select-panel'),
            addressSelectList: document.getElementById('address-select-list'),
            useSelectedAddressBtn: document.getElementById('use-selected-address-btn'),
            manageAddressesShortcut: document.getElementById('manage-addresses-shortcut'),
            // Global breadcrumb elements
            globalBreadcrumb: document.getElementById('global-breadcrumb'),
            globalBreadcrumbPath: document.getElementById('global-breadcrumb-path'),
        };

        // --- Error Handling & UI Helpers ---
        // Safe toast display with localization fallback.
        if (typeof window.showToast !== 'function') {
            window.showToast = function(messageKeyOrText, isSuccess = true) {
                try {
                    const el = DOMElements.toast;
                    const msgEl = DOMElements.toastMessage;
                    if (!el || !msgEl) {
                        // Fallback to alert for environments without toast DOM
                        if (typeof messageKeyOrText === 'string') {
                            console[isSuccess ? 'log' : 'warn'](messageKeyOrText);
                        }
                        return;
                    }
                    const dict = (typeof translations !== 'undefined' && translations[currentLanguage]) ? translations[currentLanguage] : {};
                    const text = dict[messageKeyOrText] || messageKeyOrText || 'Action completed';
                    msgEl.textContent = text;
                    el.classList.remove('hidden');
                    el.classList.toggle('bg-green-600', !!isSuccess);
                    el.classList.toggle('bg-red-600', !isSuccess);
                    clearTimeout(el._hideTimer);
                    el._hideTimer = setTimeout(() => el.classList.add('hidden'), 2500);
                } catch (e) {
                    console.warn('Toast failed:', e);
                }
            }
        }

        // Centralized error logger
        function logError(context, error) {
            try {
                console.error(`[${context}]`, error);
            } catch {}
        }

        // Generic async wrapper to standardize UI state and error reporting
        async function safeAsync(fn, { onStart, onSuccess, onError, onFinally } = {}) {
            try {
                onStart && onStart();
                const res = await fn();
                onSuccess && onSuccess(res);
                return res;
            } catch (err) {
                onError && onError(err);
                // Default surface
                showToast(err?.message || 'Something went wrong. Please try again.', false);
                throw err;
            } finally {
                onFinally && onFinally();
            }
        }

        // Disable/enable a button safely while an async task runs
        async function withDisabled(btn, task) {
            if (!btn) return task();
            const prevDisabled = btn.disabled;
            btn.disabled = true;
            try { return await task(); } finally { btn.disabled = prevDisabled; }
        }

        // Global guards for uncaught errors
        if (!window.__globalErrorHandlersInstalled) {
            window.__globalErrorHandlersInstalled = true;
            window.addEventListener('error', (e) => {
                logError('window.onerror', e?.error || e?.message || e);
            });
            window.addEventListener('unhandledrejection', (e) => {
                logError('unhandledrejection', e?.reason || e);
                showToast('An unexpected error occurred.', false);
            });
        }
        
        // --- Dark Mode Logic ---

        function applyDarkMode(mode) {
            const html = document.documentElement;
            const isDark = mode === 'dark';
            
            if (isDark) {
                html.classList.add('dark');
                DOMElements.darkModeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'dark');
            } else {
                html.classList.remove('dark');
                DOMElements.darkModeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'light');
            }
        }

        function toggleDarkMode() {
            const currentTheme = localStorage.getItem('theme') || 'light';
            applyDarkMode(currentTheme === 'light' ? 'dark' : 'light');
        }
        window.toggleDarkMode = toggleDarkMode;

        
        // --- UI & RENDERING ---

        function showToast(messageKey, isSuccess = true) {
            const message = translations[currentLanguage][messageKey] || messageKey;
            DOMElements.toastMessage.textContent = message;
            DOMElements.toast.className = `fixed top-20 right-5 text-white py-3 px-6 rounded-lg shadow-xl z-[200] transform transition-transform duration-500 ${isSuccess ? 'bg-green-500' : 'bg-red-500'}`;
            DOMElements.toast.classList.remove('translate-x-[150%]', 'opacity-0');
            DOMElements.toast.classList.add('translate-x-0', 'opacity-100');

            setTimeout(() => {
                DOMElements.toast.classList.remove('translate-x-0', 'opacity-100');
                DOMElements.toast.classList.add('translate-x-[150%]', 'opacity-0');
            }, 3000);
        }
        window.showToast = showToast; // Exported for external use
        
        // --- Blocked UI Functions ---
        function showBlockedUI(messageKey) {
            const banner = DOMElements.blockedBanner;
            if (banner) {
                // Prefer translated message if available; otherwise use a clear default per language
                const defaultText = currentLanguage === 'bn' ? '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá' : 'Your account is blocked';
                const map = translations[currentLanguage] || {};
                const text = (messageKey && map[messageKey]) ? map[messageKey] : defaultText;
                banner.textContent = text;
                banner.classList.remove('hidden');
                // Adjust header margin to not overlap
                const headerEl = document.querySelector('header');
                if (headerEl) headerEl.style.marginTop = `${banner.offsetHeight}px`;
            }
            // Disable critical action buttons
            if(DOMElements.checkoutBtn) DOMElements.checkoutBtn.disabled = true;
            if(DOMElements.confirmOrderBtn) DOMElements.confirmOrderBtn.disabled = true;
            if(DOMElements.sendChatBtn) DOMElements.sendChatBtn.disabled = true;
        }
        
        function hideBlockedUI() {
            const banner = DOMElements.blockedBanner;
            if (banner && !banner.classList.contains('hidden')) {
                banner.classList.add('hidden');
                 document.querySelector('header').style.marginTop = `0px`;
            }
             // Re-enable buttons
            if(DOMElements.checkoutBtn) DOMElements.checkoutBtn.disabled = false;
            if(DOMElements.confirmOrderBtn) DOMElements.confirmOrderBtn.disabled = false;
            if(DOMElements.sendChatBtn) DOMElements.sendChatBtn.disabled = false;
        }


        function updateTextContent() {
            document.querySelectorAll('[data-lang]').forEach(el => {
                const key = el.dataset.lang;
                const cur = (translations[currentLanguage] || {});
                const en = (translations['en'] || {});
                const bn = (translations['bn'] || {});
                const value = (cur[key] !== undefined ? cur[key] : (en[key] !== undefined ? en[key] : bn[key]));
                if (value !== undefined) el.textContent = value;
            });
            // Update title/tooltips
            document.querySelectorAll('[data-lang-title]').forEach(el => {
                const key = el.dataset.langTitle;
                const cur = (translations[currentLanguage] || {});
                const en = (translations['en'] || {});
                const bn = (translations['bn'] || {});
                const value = (cur[key] !== undefined ? cur[key] : (en[key] !== undefined ? en[key] : bn[key]));
                if (value !== undefined) el.title = value;
            });
            // Update aria-labels
            document.querySelectorAll('[data-lang-aria-label]').forEach(el => {
                const key = el.dataset.langAriaLabel;
                const cur = (translations[currentLanguage] || {});
                const en = (translations['en'] || {});
                const bn = (translations['bn'] || {});
                const value = (cur[key] !== undefined ? cur[key] : (en[key] !== undefined ? en[key] : bn[key]));
                if (value !== undefined) el.setAttribute('aria-label', value);
            });
            document.querySelectorAll('[data-lang-placeholder]').forEach(el => {
                const key = el.dataset.langPlaceholder;
                const cur = (translations[currentLanguage] || {});
                const en = (translations['en'] || {});
                const bn = (translations['bn'] || {});
                const value = (cur[key] !== undefined ? cur[key] : (en[key] !== undefined ? en[key] : bn[key]));
                if (value !== undefined) el.placeholder = value;
            });
            DOMElements.searchInput.placeholder = translations[currentLanguage]['search-placeholder'];
            DOMElements.searchInputMobile.placeholder = translations[currentLanguage]['search-placeholder'];
            DOMElements.chatInput.placeholder = translations[currentLanguage]['chat-placeholder'];
        }

        function setLanguage(lang) {
            const resolved = (lang === 'en' || lang === 'bn') ? lang : 'bn';
            currentLanguage = resolved;
            try { localStorage.setItem('lang', resolved); } catch (e) {}

            // Update current label on the button if present
            const langCurrent = document.getElementById('lang-current');
            if (langCurrent) langCurrent.textContent = resolved === 'bn' ? '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ' : 'English';

            updateTextContent();
            renderProducts(currentDisplayedProducts); // Re-render products with new language
            // Refresh language-aware dynamic content (e.g., Side Promo titles from Firestore)
            try { fetchRightPromoFromFirestore && fetchRightPromoFromFirestore(); } catch (e) {}
            if (typeof renderTopCategoryStrip === 'function') {
                try { renderTopCategoryStrip(); } catch (e) {}
            }
            const detailsPage = document.getElementById('product-details-page');
            if(detailsPage && !detailsPage.classList.contains('hidden')) {
                const addToCartBtn = document.getElementById('add-to-cart-details');
                const productId = addToCartBtn ? addToCartBtn.dataset.productId : null;
                if(productId) showProductDetails(productId);
            }

            // Close menu if open
            const langMenu = document.getElementById('lang-menu');
            if (langMenu) langMenu.classList.add('hidden');
        }
        window.setLanguage = setLanguage;

        function showPage(pageId) {
            // Stop chat listener when leaving the chat page
            if (pageId !== 'emergency-chat-page') {
                chatUnsubscribe(); 
            } else if (currentUser && !currentUser.isAnonymous) {
                // Start chat listener when entering chat page
                handleEmergencyChat();
            }
            
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            const activePage = document.getElementById(pageId);
            if (activePage) {
                activePage.classList.remove('hidden');
                if (pageId === 'wishlist-page') {
                    renderWishlistItems();
                } else if (pageId === 'my-orders-page'){
                    fetchUserOrders();
                } else if (pageId === 'cart-page') {
                    // Coupons list removed; only apply coupon option remains
                } else if (pageId === 'home-page' && currentDisplayedProducts.length === 0) {
                     renderProducts(productsData);
                }
                // Re-apply translations on newly visible page
                updateTextContent();
            }
            // Toggle global breadcrumb visibility - show only on product details
            try {
                const bc = DOMElements.globalBreadcrumb;
                const path = DOMElements.globalBreadcrumbPath;
                if (bc) {
                    if (pageId === 'product-details-page') {
                        bc.classList.remove('hidden');
                    } else {
                        bc.classList.add('hidden');
                        if (path) path.innerHTML = '';
                    }
                }
            } catch {}
            window.scrollTo(0, 0);
        }
        window.showPage = showPage; // Exported to global scope

        function scrollToElement(elementId) {
            document.getElementById(elementId)?.scrollIntoView({ behavior: 'smooth' });
        }
        window.scrollToElement = scrollToElement;

        // Live Search Suggestions (Autocomplete)
        function hideSearchResults() {
            const desktopBox = document.getElementById('search-results-desktop');
            const mobileBox = document.getElementById('search-results-mobile');
            if (desktopBox) { desktopBox.innerHTML = ''; desktopBox.classList.add('hidden'); }
            if (mobileBox) { mobileBox.innerHTML = ''; mobileBox.classList.add('hidden'); }
        }
        // Expose to global for inline handlers used in suggestion items
        window.hideSearchResults = hideSearchResults;

        function handleSearchSuggestions(event) {
            try {
                const target = event.target;
                const query = String(target.value || '').trim().toLowerCase();
                const isDesktop = target.id === 'search-input';
                const boxId = isDesktop ? 'search-results-desktop' : 'search-results-mobile';
                const resultsBox = document.getElementById(boxId);
                if (!resultsBox) return;

                if (!query || query.length < 2 || !Array.isArray(productsData) || productsData.length === 0) {
                    resultsBox.innerHTML = '';
                    resultsBox.classList.add('hidden');
                    return;
                }

                const matches = productsData
                    .filter(p => {
                        const name = (p?.name || '').toLowerCase();
                        const brand = (p?.brand || '').toLowerCase();
                        const cat = (p?.category || '').toLowerCase();
                        const sub = (p?.subCategory || '').toLowerCase();
                        return name.includes(query) || brand.includes(query) || cat.includes(query) || sub.includes(query);
                    })
                    .slice(0, 5);

                if (matches.length === 0) {
                    resultsBox.innerHTML = '';
                    resultsBox.classList.add('hidden');
                    return;
                }

                const itemCls = 'block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors text-gray-800 dark:text-gray-200';
                const html = matches.map(p => {
                    const title = (p.name || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    return `<button type="button" class="${itemCls}" onclick="(function(){ hideSearchResults(); showProductDetails('${p.id}'); })()">${title}</button>`;
                }).join('');

                resultsBox.innerHTML = html;
                resultsBox.classList.remove('hidden');
            } catch (e) { /* noop */ }
        }

        function renderStars(rating) {
            const fullStars = Math.floor(rating);
            const halfStar = rating % 1 >= 0.5;
            let starsHtml = '';
            for (let i = 0; i < fullStars; i++) starsHtml += `<i class="fas fa-star text-yellow-400"></i>`;
            if (halfStar) starsHtml += `<i class="fas fa-star-half-alt text-yellow-400"></i>`;
            for (let i = 0; i < 5 - fullStars - (halfStar ? 1 : 0); i++) starsHtml += `<i class="far fa-star text-gray-300"></i>`;
            return starsHtml;
        }

        // --- ADDRESS MANAGEMENT & SELECTION ---
        function generateAddressId() {
            return 'addr_' + Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
        }

        function getUserAddresses() {
            return Array.isArray(currentUserData?.addresses) ? currentUserData.addresses : [];
        }

        function getDefaultAddress(addresses) {
            const arr = Array.isArray(addresses) ? addresses : [];
            return arr.find(a => a && a.isDefault) || null;
        }

        function openManageAddresses() {
            if (!currentUser || currentUser.isAnonymous) { openDrawer('profile-drawer'); return; }
            openDrawer('profile-drawer');
            if (DOMElements.userProfileView) DOMElements.userProfileView.classList.remove('hidden');
            if (DOMElements.editProfileForm) DOMElements.editProfileForm.classList.add('hidden');
            if (DOMElements.addressesSection) DOMElements.addressesSection.classList.remove('hidden');
            renderAddressesList();
            resetAddressForm();
        }
        window.openManageAddresses = openManageAddresses;

        function resetAddressForm() {
            if (!DOMElements.addressForm) return;
            DOMElements.addressFormTitle.textContent = 'Add New Address';
            DOMElements.addrIdHidden.value = '';
            DOMElements.addrName.value = '';
            DOMElements.addrMobile.value = '';
            DOMElements.addrLine1.value = '';
            DOMElements.addrLine2.value = '';
            DOMElements.addrCity.value = '';
            DOMElements.addrArea.value = '';
            DOMElements.addrDefault.checked = false;
        }

        function renderAddressesList() {
            const list = DOMElements.addressesList; if (!list) return;
            const addrs = getUserAddresses();
            if (!addrs.length) {
                list.innerHTML = '<p class="text-sm text-gray-500">No saved addresses. Add one below.</p>';
                return;
            }
            list.innerHTML = addrs.map(addr => {
                const title = `${addr.name || ''} ${addr.isDefault ? '<span class=\'ml-2 text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700\'>Default</span>' : ''}`;
                const line = [addr.line1, addr.line2, addr.city, addr.area].filter(Boolean).join(', ');
                return `
                    <div class="p-3 border rounded-xl bg-white dark:bg-gray-800 flex items-start justify-between gap-3">
                        <div>
                            <p class="font-medium">${title}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-300">${line}</p>
                            <p class="text-sm text-gray-600 dark:text-gray-300">üì± ${addr.mobile || ''}</p>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button class="text-sm px-3 py-1 rounded-full bg-gray-100 hover:bg-gray-200 edit-address-btn" data-id="${addr.id}">Edit</button>
                            <button class="text-sm px-3 py-1 rounded-full bg-red-100 text-red-700 hover:bg-red-200 delete-address-btn" data-id="${addr.id}">Delete</button>
                            ${addr.isDefault ? '' : `<button class="text-sm px-3 py-1 rounded-full bg-green-100 text-green-700 hover:bg-green-200 set-default-address-btn" data-id="${addr.id}">Set Default</button>`}
                        </div>
                    </div>`;
            }).join('');

            list.querySelectorAll('.edit-address-btn').forEach(btn => btn.addEventListener('click', () => {
                const id = btn.dataset.id; const addr = getUserAddresses().find(a => a.id === id); if (!addr) return;
                DOMElements.addressFormTitle.textContent = 'Edit Address';
                DOMElements.addrIdHidden.value = addr.id || '';
                DOMElements.addrName.value = addr.name || '';
                DOMElements.addrMobile.value = addr.mobile || '';
                DOMElements.addrLine1.value = addr.line1 || '';
                DOMElements.addrLine2.value = addr.line2 || '';
                DOMElements.addrCity.value = addr.city || '';
                DOMElements.addrArea.value = addr.area || '';
                DOMElements.addrDefault.checked = !!addr.isDefault;
            }));
            list.querySelectorAll('.delete-address-btn').forEach(btn => btn.addEventListener('click', async () => {
                const id = btn.dataset.id; await deleteAddress(id);
            }));
            list.querySelectorAll('.set-default-address-btn').forEach(btn => btn.addEventListener('click', async () => {
                const id = btn.dataset.id; await setDefaultAddress(id);
            }));
        }

        async function saveNewAddress(addressData) {
            if (!currentUser) return;
            const userDocRef = doc(db, 'users', currentUser.uid);
            const addrs = getUserAddresses();
            const newAddr = { ...addressData };
            let updated = [...addrs, newAddr];
            if (newAddr.isDefault) {
                updated = updated.map(a => ({ ...a, isDefault: a.id === newAddr.id }));
            }
            await safeAsync(async () => updateDoc(userDocRef, { addresses: updated }), {
                onSuccess: () => showToast('Address saved!', true),
                onError: () => showToast('Failed to save address', false)
            });
        }

        async function updateAddress(addressId, updatedAddressData) {
            if (!currentUser) return;
            const userDocRef = doc(db, 'users', currentUser.uid);
            const addrs = getUserAddresses();
            let updated = addrs.map(a => a.id === addressId ? { ...a, ...updatedAddressData } : a);
            if (updatedAddressData.isDefault) {
                updated = updated.map(a => ({ ...a, isDefault: a.id === addressId }));
            }
            await safeAsync(async () => updateDoc(userDocRef, { addresses: updated }), {
                onSuccess: () => showToast('Address updated!', true),
                onError: () => showToast('Failed to update address', false)
            });
        }

        async function deleteAddress(addressId) {
            if (!currentUser) return;
            const userDocRef = doc(db, 'users', currentUser.uid);
            const addrs = getUserAddresses();
            const updated = addrs.filter(a => a.id !== addressId);
            await safeAsync(async () => updateDoc(userDocRef, { addresses: updated }), {
                onSuccess: () => showToast('Address deleted', true),
                onError: () => showToast('Failed to delete address', false)
            });
            if (selectedShippingAddressId === addressId) {
                selectedShippingAddressId = null; selectedShippingAddress = null;
            }
        }

        async function setDefaultAddress(addressId) {
            if (!currentUser) return;
            const userDocRef = doc(db, 'users', currentUser.uid);
            const addrs = getUserAddresses();
            const updated = addrs.map(a => ({ ...a, isDefault: a.id === addressId }));
            await safeAsync(async () => updateDoc(userDocRef, { addresses: updated }), {
                onSuccess: () => showToast('Default address set', true),
                onError: () => showToast('Failed to set default', false)
            });
        }

        function renderSelectedShippingAddress() {
            const box = DOMElements.selectedAddressDisplay; if (!box) return;
            if (selectedShippingAddress) {
                const a = selectedShippingAddress;
                const line = [a.line1, a.line2, a.city, a.area].filter(Boolean).join(', ');
                box.textContent = `${a.name || ''} ‚Äî ${line} ‚Äî üì± ${a.mobile || ''}`;
            } else {
                const addrs = getUserAddresses();
                if (addrs.length > 0) {
                    const def = getDefaultAddress(addrs) || addrs[0];
                    selectedShippingAddress = def; selectedShippingAddressId = def?.id || null;
                    return renderSelectedShippingAddress();
                }
                // Legacy fallback
                if (currentUserData?.location || currentUserData?.mobile) {
                    box.textContent = `${currentUser?.displayName || ''} ‚Äî ${currentUserData.location || ''} ‚Äî üì± ${currentUserData.mobile || ''}`;
                } else {
                    box.textContent = 'No address selected';
                }
            }
        }

        function renderAddressSelectList() {
            const list = DOMElements.addressSelectList; if (!list) return;
            const addrs = getUserAddresses();
            if (!addrs.length) { list.innerHTML = '<p class="text-sm text-gray-500">No saved addresses</p>'; return; }
            list.innerHTML = addrs.map(a => {
                const line = [a.line1, a.line2, a.city, a.area].filter(Boolean).join(', ');
                const checked = a.id === selectedShippingAddressId ? 'checked' : '';
                return `<label class="flex items-start gap-3 p-2 border rounded-lg cursor-pointer">
                    <input type="radio" name="select-address" class="mt-1" value="${a.id}" ${checked} />
                    <div>
                        <p class="font-medium">${a.name || ''} ${a.isDefault ? '<span class=\'ml-2 text-xs px-2 py-0.5 rounded-full bg-green-100 text-green-700\'>Default</span>' : ''}</p>
                        <p class="text-sm text-gray-600">${line}</p>
                        <p class="text-sm text-gray-600">üì± ${a.mobile || ''}</p>
                    </div>
                </label>`;
            }).join('');
        }

        function selectAddressById(id) {
            const addrs = getUserAddresses();
            selectedShippingAddressId = id;
            selectedShippingAddress = addrs.find(a => a.id === id) || null;
            renderSelectedShippingAddress();
        }

        // Wire up address UI events
        if (DOMElements.manageAddressesBtn) {
            DOMElements.manageAddressesBtn.addEventListener('click', openManageAddresses);
        }
        if (DOMElements.cancelAddressBtn) {
            DOMElements.cancelAddressBtn.addEventListener('click', () => resetAddressForm());
        }
        if (DOMElements.addressForm) {
            DOMElements.addressForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const data = {
                    id: DOMElements.addrIdHidden.value || generateAddressId(),
                    name: DOMElements.addrName.value.trim(),
                    mobile: DOMElements.addrMobile.value.trim(),
                    line1: DOMElements.addrLine1.value.trim(),
                    line2: DOMElements.addrLine2.value.trim(),
                    city: DOMElements.addrCity.value.trim(),
                    area: DOMElements.addrArea.value.trim(),
                    isDefault: !!DOMElements.addrDefault.checked,
                };
                if (!data.name || !data.mobile || !data.line1) { showToast('Please fill required fields', false); return; }
                const editingId = DOMElements.addrIdHidden.value;
                if (editingId) {
                    await updateAddress(editingId, data);
                } else {
                    await saveNewAddress(data);
                }
                resetAddressForm();
                renderAddressesList();
            });
        }
        if (DOMElements.changeAddressBtn) {
            DOMElements.changeAddressBtn.addEventListener('click', () => {
                if (!DOMElements.addressSelectPanel) return;
                DOMElements.addressSelectPanel.classList.toggle('hidden');
                renderAddressSelectList();
            });
        }
        if (DOMElements.useSelectedAddressBtn) {
            DOMElements.useSelectedAddressBtn.addEventListener('click', () => {
                const picked = document.querySelector('input[name="select-address"]:checked');
                if (picked) selectAddressById(picked.value);
                if (DOMElements.addressSelectPanel) DOMElements.addressSelectPanel.classList.add('hidden');
            });
        }
        if (DOMElements.manageAddressesShortcut) {
            DOMElements.manageAddressesShortcut.addEventListener('click', () => {
                closePaymentModal();
                openManageAddresses();
            });
        }
        // --- END ADDRESS MANAGEMENT & SELECTION ---

        function renderProducts(productsToRender) {
            // Keep a reference of the unfiltered list to re-apply on sort/filter changes
            lastBaseProducts = Array.isArray(productsToRender) ? productsToRender.slice() : [];
            // Ensure toolbar and filters UI are present
            ensureListingToolbar();

            // Reset page when base set changes
            const key = Array.isArray(lastBaseProducts) ? lastBaseProducts.map(p => p && p.id).join('|') : '';
            if (key !== lastRenderKey) { currentPage = 1; lastRenderKey = key; }

            // Apply filters (only when a category/subcategory is active), then sorting
            const filtered = applyFilters(lastBaseProducts);
            const sorted = applySorting(filtered);
            currentDisplayedProducts = sorted;

            // Paging calculations
            const total = sorted.length;
            const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            const startIdx = (currentPage - 1) * PAGE_SIZE;
            const endIdx = Math.min(startIdx + PAGE_SIZE, total);
            const pageItems = sorted.slice(startIdx, endIdx);

            DOMElements.productList.innerHTML = '';
            if (pageItems.length === 0) {
                 DOMElements.productList.innerHTML = `<p class="col-span-full text-center text-gray-500">${translations[currentLanguage]['no-products']}</p>`;
                 renderPagination(0);
                 return;
            }
            const fragment = document.createDocumentFragment();
            pageItems.forEach(product => {
                const productCard = document.createElement('div');
                const isWished = localWishlistCache.has(product.id);
                const heartClass = isWished ? 'fas text-theme-pink' : 'far text-gray-400';
                const imageUrl = product.imageUrl || 'https://placehold.co/400x400/f5f7fa/6a0dad?text=Image';
                const price = product.price || 0;
                
                let priceHtml = `<span class="text-xl font-bold text-price-black">‡ß≥${product.price.toFixed(2)}</span>`;
                let offerSticker = '';
                
                // CHECK if the product is on offer
                if (product.isOffer && product.originalPrice > product.price) {
                    const discountPercent = Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100);
                    priceHtml = `
                        <div class="flex items-baseline gap-2 flex-wrap">
                            <span class="text-xl font-bold text-price-black">‡ß≥${product.price.toFixed(2)}</span>
                            <span class="text-sm text-gray-400 line-through">‡ß≥${product.originalPrice.toFixed(2)}</span>
                             <span class="text-xs font-bold text-red-500">(-${discountPercent}%)</span>
                        </div>`;
                    offerSticker = `<div class="absolute top-2 left-2 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-md">OFFER</div>`;
                }

                const isOutOfStock = Number(product.stock) <= 0;
                const cartButtonText = isOutOfStock ? translations[currentLanguage]['out-of-stock'] : translations[currentLanguage]['add-to-cart'];
                const cartButtonClasses = isOutOfStock ? 'bg-gray-400 cursor-not-allowed' : 'bg-theme-blue hover:bg-theme-purple';
                const cartButtonDisabled = isOutOfStock ? 'disabled' : '';

                productCard.className = 'product-card relative bg-white dark:bg-gray-800 rounded-3xl shadow-xl overflow-hidden transform transition-transform hover:-translate-y-2 hover:shadow-2xl flex flex-col';
                productCard.dataset.productId = product.id;
                productCard.innerHTML = `
                    <div class="relative">
                        ${offerSticker}
                        <img src="${imageUrl}" alt="${product.name}" class="w-full h-48 object-cover cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/400x400/ccc/000?text=Image';">
                    </div>
                    <div class="p-4 flex flex-col flex-grow">
                         <h3 class="product-title font-semibold text-lg text-dark mb-2 cursor-pointer h-12 overflow-hidden">${product.name}</h3>
                         <div class="flex items-center text-sm mb-2">
                            ${renderStars(product.rating || 0)}
                            <span class="text-xs text-gray-500 ml-2">(${product.ratingCount || 0})</span>
                        </div>
                        <div class="mt-auto">
                            <div class="mt-2 mb-4">${priceHtml}</div>
                            <div class="flex items-center justify-between">
                                <button class="add-to-cart text-white py-2 px-4 rounded-full transition-colors shadow-lg ${cartButtonClasses}" ${cartButtonDisabled} data-product-id="${product.id}">${cartButtonText}</button>
                                <button class="wishlist text-2xl transition-colors" data-product-id="${product.id}"><i class="${heartClass} fa-heart"></i></button>
                            </div>
                        </div>
                    </div>`;
                fragment.appendChild(productCard);
            });
            DOMElements.productList.appendChild(fragment);
            // Update filter UI values for current base set
            try { renderFiltersUI(); } catch (e) {}
            // If viewing all products, show the featured header
            if (currentCategory === null && currentSubCategory === null) {
                DOMElements.currentCategoryTitle.dataset.lang = 'featured-products';
                DOMElements.currentCategoryTitle.textContent = translations[currentLanguage]['featured-products'];
            }
            // Keep the top category strip synced whenever products render
            if (typeof renderTopCategoryStrip === 'function') {
                try { renderTopCategoryStrip(); } catch (e) {}
            }
            // Removed redundant updateCategoryHeader call, which caused the error when dataset was accessed from null.
            // Render pagination controls for current dataset
            renderPagination(total);
        }

        // --- CATEGORY & SUB-CATEGORY LOGIC ---

        function getCategoryLabel(cat) {
            if (!cat) return '';
            const slug = String(cat).toLowerCase();
            // Map common slugs to existing translation keys
            const keyMap = {
                'books-stationery': 'cat-books',
                'sports-outdoors': 'cat-sports',
                'kids-toys': 'cat-kids',
                'home-garden': 'cat-home-garden',
                'health-beauty': 'cat-health-beauty',
                'cars-bikes': 'cat-cars', // in case data uses combined slug
                'cars': 'cat-cars'
            };
            const transKey = keyMap[slug] || `cat-${slug}`;
            const cur = translations[currentLanguage] || {};
            if (cur[transKey]) return cur[transKey];
            // Humanize slug fallback
            return slug.split(/[-_]/g).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
        }

        // Curated top categories to always show (merged with categories found in products)
        const TOP_CATEGORIES = [
            'electronics',
            'fashion',
            'groceries',
            'beauty',
            'home-garden',
            'kids-toys',
            'sports-outdoors',
            'books-stationery',
            'automotive',
            'health-beauty',
            'accessories',
            'footwear',
            'watches',
            'jewelry',
            'bags',
            'appliances'
        ];

        // Font Awesome icon mapping for categories (use small icon size)
        function getCategoryIconClass(cat) {
            const slug = String(cat || '').toLowerCase();
            const map = {
                'electronics': 'fa-tv',
                'fashion': 'fa-tshirt',
                'groceries': 'fa-shopping-basket',
                'beauty': 'fa-spa',
                'home-garden': 'fa-home',
                'kids-toys': 'fa-puzzle-piece',
                'sports-outdoors': 'fa-football-ball',
                'books-stationery': 'fa-book',
                'automotive': 'fa-car',
                'cars': 'fa-car',
                'health-beauty': 'fa-heartbeat',
                'accessories': 'fa-star',
                'footwear': 'fa-shoe-prints',
                'watches': 'fa-clock',
                'jewelry': 'fa-gem',
                'bags': 'fa-shopping-bag',
                'appliances': 'fa-plug'
            };
            return map[slug] || 'fa-tags';
        }

        function updateCategoryHeader(category, subCategory = null) {
            const categoryName = category ? getCategoryLabel(category) : '';
            const subCategoryName = subCategory ? subCategory.charAt(0).toUpperCase() + subCategory.slice(1) : '';
            
            currentCategory = category;
            currentSubCategory = subCategory;
            
            let title = translations[currentLanguage]['featured-products'];
            
            if (category) {
                title = subCategoryName ? subCategoryName : categoryName;
            }

            DOMElements.currentCategoryTitle.textContent = title;
            DOMElements.currentCategoryTitle.dataset.lang = category ? (subCategory ? 'N/A' : 'current-category-title') : 'featured-products';

            // Update Breadcrumb
            let breadcrumbHtml = `<a href="javascript:void(0);" onclick="renderAllProducts()" class="text-theme-blue hover:underline">${translations[currentLanguage]['all-products']}</a>`;
            
            if (category) {
                breadcrumbHtml += ` <span class="mx-1">/</span> <a href="javascript:void(0);" onclick="filterProducts('${category}')" class="text-theme-blue hover:underline">${categoryName}</a>`;
            }
            if (subCategory) {
                breadcrumbHtml += ` <span class="mx-1">/</span> <span class="font-semibold text-dark dark:text-gray-100">${subCategoryName}</span>`;
            }
            DOMElements.categoryPath.innerHTML = breadcrumbHtml;
            
            // Render subcategory buttons if a main category is selected
            if (category && !subCategory) {
                renderSubCategories(category);
            } else {
                DOMElements.subcategoryButtons.innerHTML = '';
            }
            // Refresh the top category strip active state
            if (typeof renderTopCategoryStrip === 'function') {
                try { renderTopCategoryStrip(); } catch (e) {}
            }
        }
        
        function renderSubCategories(category) {
            // Get all unique subcategories for the current category
            const subCategories = productsData
                .filter(p => p.category === category && p.subCategory)
                .map(p => p.subCategory)
                .filter((value, index, self) => self.indexOf(value) === index) // Unique values
                .sort();

            let buttonsHtml = '';

          if (subCategories.length > 0) {
              buttonsHtml = subCategories.map(subCat => {
                    const subCatName = subCat.charAt(0).toUpperCase() + subCat.slice(1);
                    const isActive = currentSubCategory === subCat ? 'variant-btn-active bg-theme-blue/30' : '';
                    return `<button class="px-4 py-2 text-sm bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-semibold rounded-full hover:bg-gray-300 transition-colors ${isActive}" onclick="filterSubCategory('${category}', '${subCat}')">
                        ${subCatName}
                    </button>`;
                 }).join('');
                 
                 // Add an 'All' button for the current category
                 const allActive = currentSubCategory === null ? 'variant-btn-active bg-theme-blue/30' : '';
              const categoryName = getCategoryLabel(category);
              const allWord = translations[currentLanguage]['all-in-category'] || (currentLanguage==='bn'?'‡¶∏‡¶ï‡¶≤':'All in');
              const allLabel = `${allWord} ${categoryName}`;
              buttonsHtml = `<button class="px-4 py-2 text-sm bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 font-semibold rounded-full hover:bg-gray-300 transition-colors ${allActive}" onclick="filterProducts('${category}')">${allLabel}</button>` + buttonsHtml;
            } 

            DOMElements.subcategoryButtons.innerHTML = buttonsHtml;
            // Ensure language is updated for the new 'All' button
            updateTextContent();
        }

        // Action when clicking a main category (e.g., Electronics)
        window.filterProducts = (category) => {
            const filtered = productsData.filter(p => p.category === category);
            // Reset filters when switching main category (preserve sort)
            resetFiltersOnCategoryChange();
            
            updateCategoryHeader(category, null); // Set only main category
            renderProducts(filtered); 
            
            showPage('home-page');
            // Scroll to the top category strip so the subcategory dropdown is visible
            scrollToElement('top-category-strip');
        };

        // Action when clicking a sub-category button (e.g., Mobile)
        window.filterSubCategory = (category, subCategory) => {
            const filtered = productsData.filter(p => p.category === category && p.subCategory === subCategory);
            // Reset filters when switching subcategory (preserve sort)
            resetFiltersOnCategoryChange();
            
            updateCategoryHeader(category, subCategory); // Set main and sub category
            renderProducts(filtered); 
            
            showPage('home-page');
            scrollToElement('products');
        };
        
        // --- END CATEGORY & SUB-CATEGORY LOGIC ---

        // --- SORTING & FILTERING UI/LOGIC ---
        function ensureListingToolbar() {
            try {
                const list = DOMElements.productList;
                if (!list || !list.parentNode) return;
                if (!document.getElementById('products-toolbar')) {
                    const toolbar = document.createElement('div');
                    toolbar.id = 'products-toolbar';
                    toolbar.className = 'flex flex-wrap items-center justify-between gap-3 mb-4';
                    toolbar.innerHTML = `
                        <div class="flex items-center gap-2">
                          <label for="sort-select" class="text-sm text-gray-600">Sort:</label>
                          <select id="sort-select" class="px-2 py-1 rounded border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm">
                            <option value="popularity">Popularity</option>
                            <option value="rating">Rating (High to Low)</option>
                            <option value="price-asc">Price: Low to High</option>
                            <option value="price-desc">Price: High to Low</option>
                            <option value="newest">Newest</option>
                          </select>
                        </div>
                        <div class="flex items-center gap-2">
                          <button id="toggle-filters-btn" class="px-3 py-1.5 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700">Filters</button>
                          <button id="clear-filters-btn" class="px-2 py-1 text-sm text-red-600 hover:text-red-700">Clear</button>
                        </div>
                    `;
                    list.parentNode.insertBefore(toolbar, list);

                    const panel = document.createElement('div');
                    panel.id = 'filters-panel';
                    panel.className = 'hidden border rounded-xl p-4 mb-4 bg-white dark:bg-gray-900';
                    panel.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                          <div>
                            <h4 class="font-semibold mb-2">Brand</h4>
                            <div id="filter-brands" class="space-y-1 max-h-48 overflow-auto"></div>
                          </div>
                          <div>
                            <h4 class="font-semibold mb-2">Price</h4>
                            <div class="flex items-center gap-2">
                              <input id="filter-price-min" type="number" placeholder="Min" class="px-2 py-1 rounded border w-24" />
                              <span>-</span>
                              <input id="filter-price-max" type="number" placeholder="Max" class="px-2 py-1 rounded border w-24" />
                            </div>
                          </div>
                          <div>
                            <h4 class="font-semibold mb-2">Sizes</h4>
                            <div id="filter-sizes" class="flex flex-wrap gap-2"></div>
                          </div>
                          <div>
                            <h4 class="font-semibold mb-2">Colors</h4>
                            <div id="filter-colors" class="flex flex-wrap gap-2"></div>
                          </div>
                        </div>
                    `;
                    list.parentNode.insertBefore(panel, list);

                    const sortSelect = document.getElementById('sort-select');
                    sortSelect.value = currentSortOption;
                    sortSelect.addEventListener('change', () => {
                        currentSortOption = sortSelect.value;
                        renderProducts(lastBaseProducts);
                    });

                    const toggleBtn = document.getElementById('toggle-filters-btn');
                    toggleBtn.addEventListener('click', () => {
                        const p = document.getElementById('filters-panel');
                        if (!p) return;
                        const active = !!currentCategory || !!currentSubCategory;
                        if (!active) {
                            showToast('Select a category to use filters.', false);
                            return;
                        }
                        p.classList.toggle('hidden');
                    });

                    const clearBtn = document.getElementById('clear-filters-btn');
                    clearBtn.addEventListener('click', () => {
                        resetFiltersOnCategoryChange(false);
                        renderProducts(lastBaseProducts);
                    });
                }
                // Always ensure the product list uses a responsive grid with 6 columns on large screens
                try {
                    // Ensure 5-column layout on large screens
                    list.classList.remove('lg:grid-cols-6');
                    list.classList.add('grid','gap-4','sm:gap-6','grid-cols-2','sm:grid-cols-3','md:grid-cols-4','lg:grid-cols-5');
                } catch {}

                // Ensure a pagination container exists after the product list
                let pagination = document.getElementById('pagination-controls');
                if (!pagination) {
                    pagination = document.createElement('div');
                    pagination.id = 'pagination-controls';
                    pagination.className = 'mt-6 flex items-center justify-center gap-3 flex-wrap';
                    list.insertAdjacentElement('afterend', pagination);
                }
            } catch (e) { console.warn('ensureListingToolbar failed', e); }
        }

        function resetFiltersOnCategoryChange(showMsg = false) {
            activeFilters = { brands: new Set(), priceMin: null, priceMax: null, sizes: new Set(), colors: new Set() };
            const p = document.getElementById('filters-panel');
            if (p) p.classList.add('hidden');
            if (showMsg) showToast('Filters cleared');
        }

        function deriveAvailableFilters(base) {
            const brands = new Set();
            const sizes = new Set();
            const colors = new Set();
            let minPrice = Infinity, maxPrice = -Infinity;
            (base || []).forEach(p => {
                if (p.brand) brands.add(String(p.brand));
                (Array.isArray(p.sizes) ? p.sizes : []).forEach(s => sizes.add(String(s)));
                (Array.isArray(p.colors) ? p.colors : []).forEach(c => colors.add(String(c)));
                const price = Number(p.price) || 0;
                if (price > 0) { minPrice = Math.min(minPrice, price); maxPrice = Math.max(maxPrice, price); }
            });
            if (!isFinite(minPrice)) minPrice = 0;
            if (!isFinite(maxPrice)) maxPrice = 0;
            return { brands: Array.from(brands).sort(), sizes: Array.from(sizes), colors: Array.from(colors), minPrice, maxPrice };
        }

        function renderFiltersUI() {
            const active = !!currentCategory || !!currentSubCategory;
            const panel = document.getElementById('filters-panel');
            const toggleBtn = document.getElementById('toggle-filters-btn');
            if (!panel || !toggleBtn) return;
            toggleBtn.disabled = !active;
            if (!active) { panel.classList.add('hidden'); return; }

            const { brands, sizes, colors, minPrice, maxPrice } = deriveAvailableFilters(lastBaseProducts);
            const brandsEl = document.getElementById('filter-brands');
            const sizesEl = document.getElementById('filter-sizes');
            const colorsEl = document.getElementById('filter-colors');
            const minEl = document.getElementById('filter-price-min');
            const maxEl = document.getElementById('filter-price-max');
            if (!brandsEl || !sizesEl || !colorsEl || !minEl || !maxEl) return;

            brandsEl.innerHTML = brands.map(b => {
                const id = `brand-${b.replace(/\W+/g,'-')}`;
                const checked = activeFilters.brands.has(b) ? 'checked' : '';
                return `<label class="flex items-center gap-2 text-sm"><input type="checkbox" class="brand-chk" id="${id}" value="${b}" ${checked}/> <span>${b}</span></label>`;
            }).join('') || '<p class="text-sm text-gray-500">No brands</p>';

            sizesEl.innerHTML = sizes.map(s => {
                const act = activeFilters.sizes.has(s);
                return `<button data-size="${s}" class="px-3 py-1 rounded-full border ${act ? 'bg-theme-pink text-white border-theme-pink' : 'bg-white dark:bg-gray-800 text-gray-700 border-gray-300'}">${s}</button>`;
            }).join('') || '<p class="text-sm text-gray-500">No sizes</p>';

            colorsEl.innerHTML = colors.map(c => {
                const act = activeFilters.colors.has(c);
                return `<button data-color="${c}" class="px-3 py-1 rounded-full border ${act ? 'bg-theme-pink text-white border-theme-pink' : 'bg-white dark:bg-gray-800 text-gray-700 border-gray-300'}">${c}</button>`;
            }).join('') || '<p class="text-sm text-gray-500">No colors</p>';

            minEl.placeholder = minPrice ? String(minPrice) : '0';
            maxEl.placeholder = maxPrice ? String(maxPrice) : '0';
            minEl.value = activeFilters.priceMin ?? '';
            maxEl.value = activeFilters.priceMax ?? '';

            brandsEl.querySelectorAll('input.brand-chk').forEach(chk => chk.addEventListener('change', (e) => {
                const v = e.target.value;
                if (e.target.checked) activeFilters.brands.add(v); else activeFilters.brands.delete(v);
                renderProducts(lastBaseProducts);
            }));
            sizesEl.querySelectorAll('button[data-size]').forEach(btn => btn.addEventListener('click', () => {
                const v = btn.dataset.size;
                if (activeFilters.sizes.has(v)) activeFilters.sizes.delete(v); else activeFilters.sizes.add(v);
                renderProducts(lastBaseProducts);
            }));
            colorsEl.querySelectorAll('button[data-color]').forEach(btn => btn.addEventListener('click', () => {
                const v = btn.dataset.color;
                if (activeFilters.colors.has(v)) activeFilters.colors.delete(v); else activeFilters.colors.add(v);
                renderProducts(lastBaseProducts);
            }));
            const onPriceChange = () => {
                const minV = parseFloat(minEl.value);
                const maxV = parseFloat(maxEl.value);
                activeFilters.priceMin = isNaN(minV) ? null : minV;
                activeFilters.priceMax = isNaN(maxV) ? null : maxV;
                renderProducts(lastBaseProducts);
            };
            minEl.onchange = onPriceChange;
            maxEl.onchange = onPriceChange;
        }

        function applyFilters(list) {
            if (!currentCategory && !currentSubCategory) return list;
            return (list || []).filter(p => {
                if (activeFilters.brands.size > 0 && (!p.brand || !activeFilters.brands.has(String(p.brand)))) return false;
                const price = Number(p.price) || 0;
                if (activeFilters.priceMin !== null && price < activeFilters.priceMin) return false;
                if (activeFilters.priceMax !== null && price > activeFilters.priceMax) return false;
                if (activeFilters.sizes.size > 0) {
                    const sizes = new Set(Array.isArray(p.sizes) ? p.sizes.map(String) : []);
                    let ok = false; activeFilters.sizes.forEach(s => { if (sizes.has(s)) ok = true; });
                    if (!ok) return false;
                }
                if (activeFilters.colors.size > 0) {
                    const colors = new Set(Array.isArray(p.colors) ? p.colors.map(String) : []);
                    let ok = false; activeFilters.colors.forEach(c => { if (colors.has(c)) ok = true; });
                    if (!ok) return false;
                }
                return true;
            });
        }

        function applySorting(list) {
            const arr = Array.isArray(list) ? list.slice() : [];
            switch (currentSortOption) {
                case 'price-asc':
                    return arr.sort((a,b) => (Number(a.price)||0) - (Number(b.price)||0));
                case 'price-desc':
                    return arr.sort((a,b) => (Number(b.price)||0) - (Number(a.price)||0));
                case 'rating':
                    return arr.sort((a,b) => (Number(b.rating)||0) - (Number(a.rating)||0));
                case 'newest':
                    return arr.sort((a,b) => {
                        const at = a.createdAt ? (a.createdAt.seconds || a.createdAt) : 0;
                        const bt = b.createdAt ? (b.createdAt.seconds || b.createdAt) : 0;
                        if (bt !== at) return bt - at;
                        const rc = (Number(b.ratingCount)||0) - (Number(a.ratingCount)||0);
                        if (rc !== 0) return rc;
                        return (Number(b.price)||0) - (Number(a.price)||0);
                    });
                case 'popularity':
                default:
                    return arr.sort((a,b) => (Number(b.ratingCount)||0) - (Number(a.ratingCount)||0));
            }
        }
        
        // Simple pagination renderer (Prev/Next + range display)
        function renderPagination(totalItems) {
            try {
                const container = document.getElementById('pagination-controls');
                if (!container) return;
                const total = Number(totalItems) || 0;
                const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
                if (currentPage > totalPages) currentPage = totalPages;
                if (currentPage < 1) currentPage = 1;

                const start = total === 0 ? 0 : (currentPage - 1) * PAGE_SIZE + 1;
                const end = Math.min(currentPage * PAGE_SIZE, total);

                // Professional styling for the pagination block
                container.className = 'mt-8 p-4 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900/60 shadow-sm flex flex-col items-center gap-3';

                container.innerHTML = `
                    <div class="flex items-center justify-center gap-3">
                        <button id="page-prev" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-100 border border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 shadow-sm text-sm sm:text-base disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fa-solid fa-angle-left"></i>
                            <span class="hidden sm:inline">Prev</span>
                        </button>
                        <span class="text-lg font-semibold">Page ${currentPage} of ${totalPages}</span>
                        <button id="page-next" class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-100 border border-gray-300 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 shadow-sm text-sm sm:text-base disabled:opacity-50 disabled:cursor-not-allowed">
                            <span class="hidden sm:inline">Next</span>
                            <i class="fa-solid fa-angle-right"></i>
                        </button>
                    </div>
                    <button id="page-top" class="inline-flex items-center gap-2 mt-1 px-4 py-2 rounded-full bg-theme-pink text-white hover:bg-theme-purple shadow">
                        <i class="fa-solid fa-arrow-up"></i>
                        <span>Back to Top</span>
                    </button>
                `;

                const prevBtn = document.getElementById('page-prev');
                const nextBtn = document.getElementById('page-next');
                const topBtn = document.getElementById('page-top');
                if (prevBtn) {
                    prevBtn.disabled = currentPage <= 1;
                    prevBtn.onclick = () => {
                        if (currentPage > 1) {
                            currentPage -= 1;
                            renderProducts(currentDisplayedProducts);
                            try { document.getElementById('products')?.scrollIntoView({ behavior: 'smooth' }); } catch {}
                        }
                    };
                }
                if (nextBtn) {
                    nextBtn.disabled = currentPage >= totalPages;
                    nextBtn.onclick = () => {
                        if (currentPage < totalPages) {
                            currentPage += 1;
                            renderProducts(currentDisplayedProducts);
                            try { document.getElementById('products')?.scrollIntoView({ behavior: 'smooth' }); } catch {}
                        }
                    };
                }
                if (topBtn) {
                    topBtn.onclick = () => {
                        try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch { window.scrollTo(0,0); }
                    };
                }
            } catch (e) { console.warn('renderPagination failed', e); }
        }
        // --- END SORTING & FILTERING UI/LOGIC ---
        
        // --- TOP CATEGORY STRIP (DYNAMIC) ---
        function renderTopCategoryStrip() {
            const listEl = document.getElementById('top-category-strip-list');
            if (!listEl) return;

            // Derive unique categories from loaded products
            const productCats = Array.from(new Set((productsData || []).map(p => p.category).filter(Boolean)));
            // Merge curated + product categories, preserve order and uniqueness
            const uniqueCategories = Array.from(new Set([...
                TOP_CATEGORIES,
                ...productCats
            ]));

            // Chip classes
            const chipBase = 'shrink-0 inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium border transition-colors';
            const activeCls = 'bg-theme-pink text-white border-transparent';
            const idleCls = 'bg-white text-gray-700 dark:bg-gray-900 dark:text-gray-200 border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800';

            // Build HTML
            const isAllActive = !currentCategory;
            let html = '';
            html += `<button class="${chipBase} ${isAllActive ? activeCls : idleCls}" onclick="renderAllProducts()" data-lang="all-products">${translations[currentLanguage]['all-products'] || 'All Products'}</button>`;

            uniqueCategories.forEach(cat => {
                const isActive = currentCategory === cat;
                const label = getCategoryLabel(cat);
                const safeCat = String(cat).replace(/'/g, "\\'");
                const iconClass = getCategoryIconClass(cat);
                html += `<button class="${chipBase} ${isActive ? activeCls : idleCls}" onclick="filterProducts('${safeCat}')">
                    <i class="fas ${iconClass} mr-2 text-xs sm:text-sm"></i>
                    <span>${label}</span>
                </button>`;
            });

            // Append subcategory dropdown inline if a category is active
            if (currentCategory) {
                const subs = Array.from(new Set((productsData || [])
                    .filter(p => p.category === currentCategory && p.subCategory)
                    .map(p => p.subCategory))).sort();
                if (subs.length > 0) {
                    const selected = currentSubCategory || '';
                    const allLabel = `${translations[currentLanguage]['all-in-category'] || (currentLanguage==='bn'?'‡¶∏‡¶ï‡¶≤':'All in')} ${getCategoryLabel(currentCategory)}`;
                    const options = [`<option value="" ${selected === '' ? 'selected' : ''}>${allLabel}</option>`]
                        .concat(subs.map(s => {
                            const label = s.charAt(0).toUpperCase() + s.slice(1);
                            return `<option value="${s}" ${selected === s ? 'selected' : ''}>${label}</option>`;
                        })).join('');
                    html += `<select id="top-subcategory-select" class="shrink-0 px-3 py-1.5 rounded-full border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900 text-sm text-gray-700 dark:text-gray-200">${options}</select>`;
                }
            }

            listEl.innerHTML = html;

            const selectEl = document.getElementById('top-subcategory-select');
            if (selectEl) {
                // Auto-focus so users see and can use it immediately
                try { selectEl.focus(); } catch (e) {}
                selectEl.onchange = (e) => {
                    const val = e.target.value;
                    if (!val) {
                        window.filterProducts(currentCategory);
                    } else {
                        window.filterSubCategory(currentCategory, val);
                    }
                };
            }
        }
        // --- END TOP CATEGORY STRIP ---
        
        // --- REVIEW LOGIC ---
        
        // Global state to track selected rating
        let currentRating = 0;
        
        function setupReviewForm(productId) {
            const form = document.getElementById('review-form');
            const loginPrompt = document.getElementById('review-login-prompt');
            const reviewControls = document.getElementById('review-controls');
            const ratingStars = document.getElementById('rating-stars');
            const ratingInput = document.getElementById('review-rating');

            if (!currentUser || currentUser.isAnonymous) {
                loginPrompt.classList.remove('hidden');
                reviewControls.classList.add('hidden');
                return;
            }

            loginPrompt.classList.add('hidden');
            reviewControls.classList.remove('hidden');
            
            document.getElementById('review-product-id').value = productId;
            currentRating = 0;
            ratingInput.value = 0;
            updateStarDisplay(ratingStars, 0);

            // Clear previous comment if any
            document.getElementById('review-comment').value = '';
        }

        function handleStarClick(e) {
            const star = e.target.closest('.rating-star');
            if (!star) return;

            const rating = parseInt(star.dataset.rating);
            currentRating = rating;
            document.getElementById('review-rating').value = rating;
            updateStarDisplay(star.parentElement, rating);
        }

        function updateStarDisplay(container, rating) {
            Array.from(container.children).forEach(star => {
                if (star.classList.contains('rating-star')) {
                    const starRating = parseInt(star.dataset.rating);
                    if (starRating <= rating) {
                        star.classList.remove('far', 'text-gray-400');
                        star.classList.add('fas', 'selected');
                    } else {
                        star.classList.remove('fas', 'selected');
                        star.classList.add('far', 'text-gray-400');
                    }
                }
            });
        }
        
        async function submitReview(e) {
            e.preventDefault();
            if (!currentUser || currentUser.isAnonymous) return;

            const productId = document.getElementById('review-product-id').value;
            const rating = parseInt(document.getElementById('review-rating').value);
            const comment = document.getElementById('review-comment').value.trim();

            if (rating === 0 || comment.length < 5) {
                showToast('Please provide a rating and a valid comment (min 5 chars).', false);
                return;
            }

            const productDocRef = doc(db, 'products', productId);
            const productSnap = await getDoc(productDocRef);
            
            if (!productSnap.exists()) {
                showToast('Product not found in database.', false);
                return;
            }

            const productData = productSnap.data();
            const existingReviews = productData.reviews || [];
            const currentRatingCount = productData.ratingCount || 0;
            const currentTotalRating = (productData.rating * currentRatingCount) || 0; // rating is already average

            const newReview = {
                author: currentUser.displayName || currentUser.email || 'Anonymous',
                rating: rating,
                comment: comment,
                // FIX: Changed serverTimestamp() to new Date() as it's inside arrayUnion
                timestamp: new Date() 
            };

            const newRatingCount = currentRatingCount + 1;
            const newTotalRating = currentTotalRating + rating;
            const newAverageRating = newTotalRating / newRatingCount;

            try {
                await updateDoc(productDocRef, {
                    reviews: arrayUnion(newReview),
                    rating: parseFloat(newAverageRating.toFixed(1)), // Keep 1 decimal place
                    ratingCount: newRatingCount
                });
                
                // Manually update the local product data (in productsData array) for immediate UI refresh
                const productIndex = productsData.findIndex(p => p.id === productId);
                if (productIndex !== -1) {
                    productsData[productIndex].reviews = [...existingReviews, newReview];
                    productsData[productIndex].rating = parseFloat(newAverageRating.toFixed(1));
                    productsData[productIndex].ratingCount = newRatingCount;
                }
                
                // Re-render product details with new data
                showProductDetails(productId);
                showToast('review-success', true);
                
            } catch (error) {
                console.error("Error submitting review:", error);
                showToast('review-failed', false);
            }
        }
        
        // --- END REVIEW LOGIC ---


        function handleProductCardClick(e) {
            const target = e.target;
            const productCard = target.closest('.product-card');
            if (!productCard) return;

            const productId = productCard.dataset.productId;
            
            if (target.closest('.add-to-cart')) {
                try {
                    const product = (productsData || []).find(p => p.id === productId);
                    const required = product ? getRequiredVariants(product) : [];
                    if (required.length > 0) {
                        // Open quick-select modal instead of redirecting to details
                        openVariantModal(productId, 'add');
                        return;
                    }
                } catch (err) { console.log('Variant check failed', err); }
                addToCartInDb(productId, true).catch(err => console.log(err));
            } else if (target.closest('.wishlist')) {
                toggleWishlistInDb(productId);
            } else if (target.closest('img') || target.closest('.product-title')) {
                showProductDetails(productId);
            }
        }
        
        async function showProductDetails(productId, skuEnc = '', modelEnc = '', nameEnc = '') {
            try {
                selectedVariants = {};
                const fallbackSku = skuEnc ? decodeURIComponent(skuEnc) : '';
                const fallbackModel = modelEnc ? decodeURIComponent(modelEnc) : '';
                const fallbackName = nameEnc ? decodeURIComponent(nameEnc) : '';

                let product = Array.isArray(productsData) ? productsData.find(p => p.id === productId) : null;
                if (!product && window.db && typeof window.db === 'object') {
                    try {
                        const ref = doc(db, 'products', String(productId));
                        const snap = await getDoc(ref);
                        if (snap && snap.exists()) {
                            product = { id: snap.id, ...snap.data() };
                            // Cache it for later to speed up next visit
                            if (Array.isArray(productsData)) {
                                productsData.push(product);
                            }
                        }
                    } catch (e) {
                        console.warn('Fallback fetch product failed', e);
                    }
                    // If still not found, try queries by SKU / modelID / name
                    if (!product) {
                        try {
                            if (fallbackSku) {
                                const q1 = query(collection(db, 'products'), where('sku', '==', fallbackSku));
                                const qs1 = await getDocs(q1);
                                if (!qs1.empty) {
                                    const d = qs1.docs[0];
                                    product = { id: d.id, ...d.data() };
                                }
                            }
                            if (!product && fallbackSku) {
                                const q1b = query(collection(db, 'products'), where('SKU', '==', fallbackSku));
                                const qs1b = await getDocs(q1b);
                                if (!qs1b.empty) {
                                    const d = qs1b.docs[0];
                                    product = { id: d.id, ...d.data() };
                                }
                            }
                            if (!product && fallbackModel) {
                                const q2 = query(collection(db, 'products'), where('modelID', '==', fallbackModel));
                                const qs2 = await getDocs(q2);
                                if (!qs2.empty) {
                                    const d = qs2.docs[0];
                                    product = { id: d.id, ...d.data() };
                                }
                            }
                            if (!product && fallbackName) {
                                const q3 = query(collection(db, 'products'), where('name', '==', fallbackName));
                                const qs3 = await getDocs(q3);
                                if (!qs3.empty) {
                                    const d = qs3.docs[0];
                                    product = { id: d.id, ...d.data() };
                                }
                            }
                            if (product && Array.isArray(productsData)) {
                                productsData.push(product);
                            }
                        } catch (e) {
                            console.warn('Fallback query by fields failed', e);
                        }
                    }
                }
                if (!product) {
                    if (typeof showToast === 'function') showToast('Product not found', false);
                    return;
                }

            const detailsPage = document.getElementById('product-details-page');
            if(!detailsPage) return;
            
            // Update global breadcrumb: Home > Category > Subcategory > Product Name
            try {
                const bc = DOMElements.globalBreadcrumb;
                const path = DOMElements.globalBreadcrumbPath;
                if (bc && path) {
                    const homeLabel = (translations?.[currentLanguage]?.['home']) || 'Home';
                    const cat = product.category || null;
                    const sub = product.subCategory || null;
                    const catLabel = cat ? getCategoryLabel(cat) : null;
                    const safeCat = cat ? String(cat).replace(/'/g, "\\'") : '';
                    const safeSub = sub ? String(sub).replace(/'/g, "\\'") : '';
                    let html = `<a href=\"javascript:void(0);\" class=\"text-theme-blue hover:underline\" onclick=\"renderAllProducts && renderAllProducts(); showPage('home-page');\">${homeLabel}</a>`;
                    if (cat) {
                        html += ` <span class=\"mx-2 text-gray-400\">‚Ä∫</span> <a href=\"javascript:void(0);\" class=\"text-theme-blue hover:underline\" onclick=\"filterProducts && filterProducts('${safeCat}');\">${catLabel}</a>`;
                    }
                    if (sub) {
                        html += ` <span class=\"mx-2 text-gray-400\">‚Ä∫</span> <a href=\"javascript:void(0);\" class=\"text-theme-blue hover:underline\" onclick=\"filterSubCategory && filterSubCategory('${safeCat}','${safeSub}');\">${sub}</a>`;
                    }
                    html += ` <span class=\"mx-2 text-gray-400\">‚Ä∫</span> <span class=\"font-semibold text-gray-900 dark:text-gray-100\">${(product.name||'').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span>`;
                    path.innerHTML = html;
                    bc.classList.remove('hidden');
                }
            } catch (e) { console.warn('breadcrumb update failed', e); }
            
            // Populate product details
            const isWished = localWishlistCache.has(product.id);
            const heartClass = isWished ? 'fas text-theme-pink' : 'far text-gray-400';
            
            const productTitleEl = detailsPage.querySelector('#product-title-details');
            if (productTitleEl) productTitleEl.textContent = product.name || "Product Name";
            
            const productBrandEl = detailsPage.querySelector('#product-brand-details');
            if (productBrandEl) productBrandEl.textContent = product.brand || "Brand";

            // --- Model ID Logic ---
            const productModelEl = detailsPage.querySelector('#product-model-details');
            const modelID = product.modelID || null; 

            if (productModelEl) {
                let displayModelID = '';
                if (modelID && modelID.trim() !== '') {
                    displayModelID = translations[currentLanguage]['model-id'].replace('{id}', modelID);
                    productModelEl.classList.remove('hidden');
                } else {
                    productModelEl.classList.add('hidden');
                }
                // FIX: Use translation key string and replace {id} with modelID
                productModelEl.querySelector('#model-text').textContent = translations[currentLanguage]['model-id'].replace('{id}', modelID);
            }
            // --- END Model ID Logic ---

            // --- Warranty Logic (remains as string fetch) ---
            const productWarrantyEl = detailsPage.querySelector('#product-warranty-details');
            const warrantyTextFromDB = product.warrantyText || null; 

            if (productWarrantyEl) {
                let displayWarranty = translations[currentLanguage]['no-warranty'];
                let isWarrantyPresent = false;
                
                if (warrantyTextFromDB && warrantyTextFromDB.trim() !== '') {
                    displayWarranty = translations[currentLanguage]['warranty'].replace('{text}', warrantyTextFromDB);
                    isWarrantyPresent = true;
                }
                
                productWarrantyEl.querySelector('#warranty-text').textContent = displayWarranty;
                
                if (isWarrantyPresent) {
                    productWarrantyEl.classList.add('text-green-600');
                    productWarrantyEl.classList.remove('text-red-500');
                } else {
                    productWarrantyEl.classList.add('text-red-500');
                    productWarrantyEl.classList.remove('text-green-600');
                }
            }
            // --- END Warranty Logic ---


            const productImageEl = detailsPage.querySelector('#product-image');
            if (productImageEl) productImageEl.src = product.imageUrl || 'https://placehold.co/400x400/f5f7fa/6a0dad?text=Image';

            const productRatingEl = detailsPage.querySelector('#product-rating-details');
            if (productRatingEl) productRatingEl.textContent = product.rating || 0;

            const productStarsEl = detailsPage.querySelector('#product-stars-details');
            if (productStarsEl) productStarsEl.innerHTML = renderStars(product.rating || 0);

            const productRatingCountEl = detailsPage.querySelector('#product-rating-count-details');
            if (productRatingCountEl) productRatingCountEl.textContent = `(${product.ratingCount || 0})`;

            // Stock display with low-stock visual indicator
            const stockEl = detailsPage.querySelector('#product-stock-details');
            if (stockEl) {
                const stockNum = Number(product.stock) || 0;
                stockEl.classList.remove('text-green-600','text-amber-600','text-red-600');
                if (stockNum <= 0) {
                    stockEl.textContent = translations?.[currentLanguage]?.['out-of-stock'] || 'Out of Stock';
                    stockEl.classList.add('text-red-600');
                } else if (stockNum < 5) {
                    stockEl.textContent = `Only ${stockNum} left!`;
                    stockEl.classList.add('text-amber-600');
                } else {
                    stockEl.textContent = `In stock: ${stockNum}`;
                    stockEl.classList.add('text-green-600');
                }
            }
            
            const addToCartBtn = detailsPage.querySelector('#add-to-cart-details');
            if (addToCartBtn) addToCartBtn.dataset.productId = productId;
            
            const wishlistBtn = detailsPage.querySelector('#wishlist-details');
            if (wishlistBtn) wishlistBtn.dataset.productId = productId;

            const wishlistIcon = detailsPage.querySelector('#wishlist-details i');
            if (wishlistIcon) wishlistIcon.className = `${heartClass} fa-heart`;

            const productDescriptionEl = detailsPage.querySelector('#product-full-description');
            if (productDescriptionEl) productDescriptionEl.textContent = product.fullDescription || product.description || 'No detailed description available.';


            const isOutOfStock = Number(product.stock) <= 0;
            const buyNowBtn = detailsPage.querySelector('.buy-now');

            if (isOutOfStock) {
                if (addToCartBtn) {
                    addToCartBtn.textContent = translations[currentLanguage]['out-of-stock'];
                    addToCartBtn.disabled = true;
                    addToCartBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    addToCartBtn.classList.remove('bg-theme-blue', 'hover:bg-theme-purple');
                }
                if (buyNowBtn) {
                    buyNowBtn.disabled = true;
                    buyNowBtn.classList.add('bg-gray-200', 'text-gray-400', 'cursor-not-allowed', 'border-gray-300');
                    buyNowBtn.classList.remove('hover:bg-gray-100', 'border-theme-blue', 'text-theme-blue');
                }
            } else {
                if (addToCartBtn) {
                    addToCartBtn.textContent = translations[currentLanguage]['add-to-cart'];
                    addToCartBtn.disabled = false;
                    addToCartBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                    addToCartBtn.classList.add('bg-theme-blue', 'hover:bg-theme-purple');
                }
                if (buyNowBtn) {
                    buyNowBtn.disabled = false;
                    buyNowBtn.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed', 'border-gray-300');
                    buyNowBtn.classList.add('hover:bg-gray-100', 'border-theme-blue', 'text-theme-blue');
                }
            }

            renderThumbnails(product.thumbnails || []);
            renderSpecifications(product.specifications || {});
            renderReviews(product.reviews || []);
            renderPriceDetails(product);
            renderInfoDetails(product);
            renderAllVariants(product);
            setupReviewForm(productId); // Setup review form
            // Render related products based on this product
            try { renderRelatedProducts(product); } catch (e) { console.warn('related products render failed', e); }

            showPage('product-details-page');
            updateTextContent();
            } catch (err) {
                console.error('showProductDetails failed', err);
                if (typeof showToast === 'function') showToast('Failed to open product', false);
            }
    }
    // Expose to global for inline onclick usage in product cards and suggestions
    window.showProductDetails = showProductDetails;

    function renderThumbnails(thumbnails) {
            const container = document.getElementById('thumbnail-container');
            container.innerHTML = thumbnails.map(src => 
                `<img src="${src}" class="w-16 h-16 rounded-lg object-cover cursor-pointer hover:ring-2 hover:ring-theme-pink transition-all" onclick="document.getElementById('product-image').src='${src}'">`
            ).join('');
        }
        
        function renderSpecifications(specifications) {
            const container = document.getElementById('product-specifications');
            if (!container) return;

            // Empty state
            if (!specifications || Object.keys(specifications).length === 0) {
                container.innerHTML = `<p class="text-gray-500" data-lang="no-specs">${translations[currentLanguage]['no-specs']}</p>`;
                return;
            }

            // Humanize label: replace _, - with space and Title Case each word; fix common acronyms
            const humanize = (str) => {
                const raw = (str || '')
                    .toString()
                    .replace(/[_-]+/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
                const title = raw.replace(/\b\w/g, (c) => c.toUpperCase());
                const keyLower = raw.toLowerCase();
                const acronyms = { ram: 'RAM', ssd: 'SSD', hdd: 'HDD', cpu: 'CPU', gpu: 'GPU', usb: 'USB', rom: 'ROM' };
                if (acronyms[keyLower]) return acronyms[keyLower];
                return title;
            };

            // Normalize values and preferred order
            const normalizeVal = (v) => {
                if (Array.isArray(v)) return v.filter(Boolean).join(', ');
                if (v && typeof v === 'object') return Object.values(v).filter(Boolean).join(', ');
                return v ?? '';
            };

            const preferredOrder = ['storage', 'processor', 'cpu', 'color', 'battery', 'ram', 'display'];
            const entriesRaw = Object.entries(specifications)
                .map(([k, v]) => [k, normalizeVal(v)])
                .filter(([, v]) => String(v).trim() !== '');

            const entries = entriesRaw.sort((a, b) => {
                const ia = preferredOrder.indexOf(a[0].toLowerCase());
                const ib = preferredOrder.indexOf(b[0].toLowerCase());
                if (ia === -1 && ib === -1) return a[0].localeCompare(b[0]);
                if (ia === -1) return 1;
                if (ib === -1) return -1;
                return ia - ib;
            });

            container.innerHTML = `
                <div class="overflow-hidden">
                    <dl class="divide-y divide-gray-200 dark:divide-gray-600">
                        ${entries.map(([key, value]) => `
                            <div class="grid grid-cols-12 gap-3 py-3">
                                <dt class="col-span-4 font-semibold text-gray-800 dark:text-gray-100">${humanize(key)}</dt>
                                <dd class="col-span-8 text-gray-700 dark:text-gray-300">${value}</dd>
                            </div>
                        `).join('')}
                    </dl>
                </div>
            `;
        }

        function renderReviews(reviews) {
            const container = document.getElementById('product-reviews');
            if (!container) return;
            if (!reviews || reviews.length === 0) {
                container.innerHTML = `<p class="text-gray-500" data-lang="no-reviews">${translations[currentLanguage]['no-reviews']}</p>`;
                return;
            }

            container.innerHTML = reviews.map(review => {
                // Check if timestamp is a Firestore Timestamp object (has toDate()) or a native Date object
                let dateString = 'N/A';
                if (review.timestamp?.toDate) {
                     dateString = review.timestamp.toDate().toLocaleDateString('en-GB');
                } else if (review.timestamp instanceof Date) {
                    dateString = review.timestamp.toLocaleDateString('en-GB');
                }

                return `
                    <div class="border-b pb-4">
                        <div class="flex items-center mb-2">
                            <div class="flex items-center mr-4">
                                ${renderStars(review.rating)}
                            </div>
                            <p class="font-bold text-gray-800">${review.author || 'Anonymous'}</p>
                            <span class="text-xs text-gray-500 ml-auto">${dateString}</span>
                        </div>
                        <p class="text-gray-600 dark:text-gray-300">${review.comment || ''}</p>
                    </div>
                `;
            }).join('');
        }

        // Render Related Products based on same subCategory or category
        function renderRelatedProducts(product) {
            const section = document.getElementById('related-products-section');
            const listEl = document.getElementById('related-product-list');
            if (!section || !listEl) return;
            try {
                if (!productsData || productsData.length === 0) {
                    section.classList.add('hidden');
                    listEl.innerHTML = '';
                    return;
                }
                let pool = [];
                if (product?.subCategory) {
                    pool = productsData.filter(p => p?.subCategory === product.subCategory);
                }
                if ((!pool || pool.length === 0) && product?.category) {
                    pool = productsData.filter(p => p?.category === product.category);
                }
                pool = (pool || []).filter(p => p && p.id !== product.id);
                if (pool.length === 0) {
                    section.classList.add('hidden');
                    listEl.innerHTML = '';
                    return;
                }
                // Randomize and limit
                const picks = pool.slice().sort(() => Math.random() - 0.5).slice(0, 5);
                listEl.innerHTML = picks.map(p => {
                    const img = p.imageUrl || p.image || 'https://placehold.co/300x300/f5f7fa/6a0dad?text=Product';
                    const price = Number(p.price || 0);
                    const isOffer = p.isOffer && Number(p.originalPrice) > Number(p.price);
                    const priceHtml = isOffer
                        ? `<div class="flex items-baseline gap-1"><span class="font-semibold text-price-black">‡ß≥${price.toFixed(0)}</span><span class="text-xs text-gray-400 line-through">‡ß≥${Number(p.originalPrice||0).toFixed(0)}</span></div>`
                        : `<span class="font-semibold text-price-black">‡ß≥${price.toFixed(0)}</span>`;
                    return `
                        <div class="rounded-2xl border bg-white dark:bg-gray-800 overflow-hidden hover:shadow transition cursor-pointer" onclick="showProductDetails('${p.id}')">
                            <div class="aspect-square overflow-hidden bg-gray-50 dark:bg-gray-900 flex items-center justify-center">
                                <img src="${img}" alt="${(p.name||'').replace(/"/g,'&quot;')}" class="w-full h-full object-cover">
                            </div>
                            <div class="p-3">
                                <p class="text-sm font-medium line-clamp-2 mb-1">${p.name || ''}</p>
                                <div class="text-sm">${priceHtml}</div>
                            </div>
                        </div>`;
                }).join('');
                section.classList.remove('hidden');
            } catch (e) {
                console.warn('renderRelatedProducts failed', e);
                try { section.classList.add('hidden'); } catch {}
            }
        }

        function renderPriceDetails(product) {
            const priceElement = document.getElementById('product-price-details');
            const price = product.price || 0;
            
            // CHECK if the product is on offer (same logic as renderProducts)
            if (product.isOffer && product.originalPrice > product.price) {
                const discountPercent = Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100);
                priceElement.innerHTML = `
                    <div class="flex items-baseline gap-2 flex-wrap">
                        <span class="text-2xl font-bold text-price-black">‡ß≥${price.toFixed(2)}</span>
                        <span class="text-lg text-gray-400 line-through">‡ß≥${product.originalPrice.toFixed(2)}</span>
                        <span class="text-sm font-bold text-red-500">(-${discountPercent}%)</span>
                    </div>`;
            } else {
                // If not on offer, only show the main price (which is stored in product.price in this case)
                priceElement.innerHTML = `<span class="text-2xl font-bold text-price-black">‡ß≥${price.toFixed(2)}</span>`;
            }
        }

        function renderInfoDetails(product) {
            const infoDetails = document.getElementById('product-info-details');
            const returnableText = product.isReturnable ? translations[currentLanguage]['returnable'] : translations[currentLanguage]['not-returnable'];
            const returnableIcon = product.isReturnable ? 'fas fa-undo text-green-500' : 'fas fa-ban text-red-500';
            infoDetails.innerHTML = `
                <div class="flex items-center space-x-2">
                    <i class="${returnableIcon}"></i>
                    <span class="text-sm text-gray-600 dark:text-gray-300">${returnableText}</span>
                </div>
                <div class="flex items-center space-x-2">
                    <i class="fas fa-lock text-green-500"></i>
                    <span class="text-sm text-gray-600 dark:text-gray-300" data-lang="secure-payments">${translations[currentLanguage]['secure-payments']}</span>
                </div>`;
        }

        function renderAllVariants(product) {
            renderVariantOptions('size', product.sizes);
            renderVariantOptions('storage', product.storage);
            renderVariantOptions('color', product.colors);
        }

        function renderVariantOptions(variantType, options) {
            const containerDiv = document.getElementById(`${variantType}-options`);
            if (!options || options.length === 0) {
                containerDiv.classList.add('hidden');
                return;
            }
            containerDiv.classList.remove('hidden');
            const container = document.getElementById(`${variantType}-variants-container`);
            container.innerHTML = options.map(option => {
                if (variantType === 'color') {
                    return `<button class="w-8 h-8 rounded-full border-2 border-gray-300" style="background-color: ${String(option).toLowerCase()}" data-variant-type="color" data-value="${option}"></button>`;
                }
                return `<button class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors text-dark" data-variant-type="${variantType}" data-value="${option}">${option}</button>`;
            }).join('');
        }
        function handleVariantSelection(e) {
            const button = e.target.closest('button[data-variant-type]');
            if (!button) return;

            const { variantType, value } = button.dataset;
            const container = button.parentElement;
            
            container.querySelectorAll('button').forEach(btn => {
                btn.classList.remove(variantType === 'color' ? 'color-variant-active' : 'variant-btn-active');
            });
            button.classList.add(variantType === 'color' ? 'color-variant-active' : 'variant-btn-active');
            
            selectedVariants[variantType] = value;

            // Clear missing highlight when user selects a variant
            const labelEl = document.querySelector(`#${variantType}-options label`);
            if (labelEl) labelEl.classList.remove('text-red-600', 'animate-pulse');
        }

        // Helper: highlight missing variant fields and scroll to options
        function highlightMissingVariantUI(missingTypes = []) {
            try {
                missingTypes.forEach(type => {
                    const labelEl = document.querySelector(`#${type}-options label`);
                    const wrapper = document.getElementById(`${type}-options`);
                    if (wrapper) wrapper.classList.remove('hidden');
                    if (labelEl) labelEl.classList.add('text-red-600', 'animate-pulse');
                });
                const opts = document.getElementById('product-options');
                if (opts) opts.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } catch (err) { console.log('Variant highlight failed:', err); }
        }

        // --- Firestore Database Logic ---
        
        async function fetchProductsFromFirestore() {
            try {
                const querySnapshot = await getDocs(collection(db, "products"));
                productsData = querySnapshot.docs.map(doc => {
                    const data = doc.data();
                    
                    // Robustly check for offer flag and prices (camelCase or lowercase)
                    const hasOffer = data.isOnOffer === true || data.isonoffer === true;
                    const mainPrice = Number(data.mainPrice || data.mainprice) || 0;
                    const offerPrice = Number(data.offerPrice || data.offerprice) || 0;

                    // An offer is valid only if the flag is set, prices are positive, and the offer is a discount.
                    const isValidOffer = hasOffer && mainPrice > 0 && offerPrice > 0 && offerPrice < mainPrice;
                    
                    // NEW LOGIC: Use model1 if present, otherwise try model, otherwise use the Firestore document ID
                    const modelID = data.model1 || data.model || doc.id; 

                    // Normalize category and subcategory across different schemas
                    let categoryValue = data.category ?? data.Category ?? data.cat ?? data.categoryName ?? 'general';
                    if (typeof categoryValue === 'string') categoryValue = categoryValue.trim().toLowerCase();

                    let rawSub = data.subCategory ?? data.subcategory ?? data.sub_category ?? data.subCat ?? data.subcat ?? data.sub ?? null;
                    let normalizedSub = null;
                    if (Array.isArray(rawSub)) {
                        normalizedSub = rawSub.length ? String(rawSub[0]).trim().toLowerCase() : null;
                    } else if (typeof rawSub === 'string') {
                        const first = rawSub.split(',')[0];
                        normalizedSub = first ? first.trim().toLowerCase() : null;
                    } else if (rawSub && typeof rawSub === 'object' && rawSub.name) {
                        normalizedSub = String(rawSub.name).trim().toLowerCase();
                    }

                    return {
                        id: doc.id,
                        modelID: modelID, // NEW: Fetch Model ID
                        name: data.name || "No Name Provided",
                        brand: data.brand || "No Brand",
                        price: isValidOffer ? offerPrice : mainPrice,
                        originalPrice: isValidOffer ? mainPrice : null,
                        isOffer: isValidOffer,
                        rating: data.rating || 0,
                        ratingCount: data.ratingCount || 0,
                        image: data.imageUrl || '',
                        imageUrl: data.imageUrl || '',
                        description: data.details || '',
                        fullDescription: data.details || '',
                        category: categoryValue,
                        subCategory: normalizedSub, // normalized subcategory
                        isReturnable: data.isRefundable === true,
                        specifications: data.specification || {},
                        reviews: data.reviews || [],
                        thumbnails: data.thumbnails || [],
                        sizes: data.variants && typeof data.variants.size === 'string' ? data.variants.size.split(',').map(s => s.trim()) : (Array.isArray(data.sizes) ? data.sizes : []),
                        storage: data.storage || [],
                        colors: data.variants && typeof data.variants.color === 'string' ? data.variants.color.split(',').map(c => c.trim()) : (Array.isArray(data.colors) ? data.colors : []),
                        stock: data.stock !== undefined ? Number(data.stock) : 1,
                        warrantyText: data.warranty || null // Use the fetched string field
                    };
                });
                if (productsData.length === 0) {
                    DOMElements.productList.innerHTML = `<p class="col-span-full text-center text-gray-500">No products found in the database.</p>`;
                } else {
                     renderProducts(productsData);
                }
            } catch (error) {
                console.error("Error fetching products from Firestore: ", error);
                DOMElements.productList.innerHTML = `<p class="col-span-full text-center text-red-500">Error loading products. Check console for details.</p>`;
            }
        }
        
        async function fetchBannersFromFirestore() {
            try {
                const querySnapshot = await getDocs(collection(db, "banners"));
                const banners = querySnapshot.docs.map(doc => doc.data());
                banners.sort((a, b) => (a.order || 0) - (b.order || 0)); // Sort banners by order

                DOMElements.slidesContainer.innerHTML = '';
                banners.forEach(banner => {
                    const slide = document.createElement('div');
                    slide.className = 'w-full flex-shrink-0 aspect-[3/1]';
                    const link = banner.url || banner.link || banner.href || '';
                    if (link) {
                        const isExternal = /^https?:\/\//i.test(link);
                        slide.innerHTML = `
                            <a href="${link}" ${isExternal ? 'target="_blank" rel="noopener"' : ''} class="block w-full h-full">
                                <img src="${banner.imageUrl}" alt="${banner.alt || 'Banner Image'}" class="w-full h-full object-cover" />
                            </a>`;
                    } else {
                        slide.innerHTML = `<img src="${banner.imageUrl}" alt="${banner.alt || 'Banner Image'}" class="w-full h-full object-cover">`;
                    }
                    DOMElements.slidesContainer.appendChild(slide);
                });

                initializeSlider(); 
            } catch (error) {
                console.error("Error fetching banners:", error);
                initializeSlider(); // Initialize slider even if fetch fails to handle static/empty state
            }
        }

        // Load Right Promo Tile from Firestore
    async function fetchRightPromoFromFirestore() {
            try {
                // Expect a collection 'sidePromos' with fields: imageUrl, title, subtitle, link(url), alt, active(bool), order(number)
                const snap = await getDocs(collection(db, 'sidePromos'));
                let promos = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                // Filter active first if present
                promos = promos.filter(p => p.active !== false);
                // Sort by order if provided
                promos.sort((a, b) => (a.order || 0) - (b.order || 0));
                const promo = promos[0];
                if (!promo) {
                    // No promo in Firestore: hide any default texts
                    const titleEl0 = DOMElements.rightPromoTitle;
                    const subEl0 = DOMElements.rightPromoSubtitle;
                    if (titleEl0) { titleEl0.textContent = ''; titleEl0.classList.add('hidden'); }
                    if (subEl0) { subEl0.textContent = ''; subEl0.classList.add('hidden'); }
                    return;
                }

                const img = DOMElements.rightPromoImg;
                const titleEl = DOMElements.rightPromoTitle;
                const subEl = DOMElements.rightPromoSubtitle;
                const linkEl = DOMElements.rightPromoLink;
                if (!img || !titleEl || !subEl || !linkEl) return;

                if (promo.imageUrl) {
                    img.src = promo.imageUrl;
                }
                img.alt = promo.alt || promo.title || 'Promo';

                // Language-aware fields (use bn-specific if available)
                const isBn = (typeof currentLanguage !== 'undefined' && currentLanguage === 'bn');
                const titleBn = promo.title_bn || promo.titleBn || promo.titleBangla;
                const subtitleBn = promo.subtitle_bn || promo.subtitleBn || promo.subtitleBangla;
                const title = (isBn && titleBn) ? titleBn : (promo.title || titleBn || '');
                const subtitle = (isBn && subtitleBn) ? subtitleBn : (promo.subtitle || subtitleBn || '');
                if (title && String(title).trim()) {
                    titleEl.textContent = title;
                    titleEl.classList.remove('hidden');
                } else {
                    titleEl.textContent = '';
                    titleEl.classList.add('hidden');
                }
                if (subtitle && String(subtitle).trim()) {
                    subEl.textContent = subtitle;
                    subEl.classList.remove('hidden');
                } else {
                    subEl.textContent = '';
                    subEl.classList.add('hidden');
                }

                const link = promo.url || promo.link || promo.href;
                if (link) {
                    const isExternal = /^https?:\/\//i.test(link);
                    linkEl.setAttribute('href', link);
                    // Remove default scroll onclick when we have a real link
                    linkEl.onclick = null;
                    if (isExternal) {
                        linkEl.setAttribute('target', '_blank');
                        linkEl.setAttribute('rel', 'noopener');
                    } else {
                        linkEl.removeAttribute('target');
                        linkEl.removeAttribute('rel');
                    }
                } else {
                    // Keep internal scroll behavior if no link was provided
                    linkEl.setAttribute('href', 'javascript:void(0)');
                    linkEl.onclick = () => scrollToElement('categories');
                }
            } catch (err) {
                console.error('Error fetching right promo:', err);
                // Keep defaults silently
            }
        }

        function setupFirestoreListeners(user) {
            userDocUnsubscribe();

            if (user && !user.isAnonymous) {
                const userDocRef = doc(db, 'users', user.uid);
                
                userDocUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                    if (!docSnap.exists()) {
                        setDoc(userDocRef, { email: user.email, name: user.displayName, cart: {}, wishlist: {}, usedCoupons: [], mobile: '', location: '', isBlocked: false }, { merge: true });
                        currentUserData = { cart: {}, wishlist: {}, usedCoupons: [], isBlocked: false };
                        return;
                    }
                    const data = docSnap.data() || {};
                    currentUserData = data;
                    if (!Array.isArray(currentUserData.addresses)) currentUserData.addresses = [];
                    
                    // --- Check Block Status ---
                    isCurrentUserBlocked = data.isBlocked || false;
                    if (isCurrentUserBlocked) {
                        showBlockedUI('account-blocked-banner');
                    } else {
                        hideBlockedUI();
                    }
                    // --- End Check Block Status ---

                    updateProfileModalUI(user, data);
                    // Keep addresses UI in sync
                    try { renderAddressesList(); } catch (_) {}
                    // Reconcile selected shipping address if needed
                    try {
                        const addrs = currentUserData.addresses || [];
                        if (!selectedShippingAddressId && addrs.length > 0) {
                            const def = getDefaultAddress(addrs);
                            selectedShippingAddressId = def?.id || addrs[0]?.id || null;
                            selectedShippingAddress = addrs.find(a => a.id === selectedShippingAddressId) || null;
                        } else if (selectedShippingAddressId) {
                            selectedShippingAddress = addrs.find(a => a.id === selectedShippingAddressId) || null;
                            if (!selectedShippingAddress && addrs.length > 0) {
                                const def = getDefaultAddress(addrs);
                                selectedShippingAddressId = def?.id || addrs[0]?.id || null;
                                selectedShippingAddress = addrs.find(a => a.id === selectedShippingAddressId) || null;
                            }
                        }
                        renderSelectedShippingAddress();
                    } catch (_) {}

                    localWishlistCache.clear();
                    const wishlistData = data.wishlist || {};
                    Object.keys(wishlistData).forEach(productId => {
                        if (wishlistData[productId]) {
                           localWishlistCache.add(productId);
                        }
                    });
                    updateWishlistUI();

                    localCartCache.clear();
                    const cartData = data.cart || {};
                    Object.keys(cartData).forEach(cartItemId => {
                        localCartCache.set(cartItemId, cartData[cartItemId]);
                    });
                    updateCartUI();
                }, (error) => {
                    console.error("Error in snapshot listener:", error);
                });
            } else {
                currentUserData = null;
                isCurrentUserBlocked = false; // Reset block status on logout
                hideBlockedUI();
                localCartCache.clear();
                localWishlistCache.clear();
                updateCartUI();
                updateWishlistUI();
                updateProfileModalUI(null);
                selectedShippingAddressId = null;
                selectedShippingAddress = null;
            }
        }
        
        function getRequiredVariants(product) {
            const required = [];
            if (product.sizes && product.sizes.length > 0) required.push('size');
            if (product.storage && product.storage.length > 0) required.push('storage');
            if (product.colors && product.colors.length > 0) required.push('color');
            return required;
        }

    async function addToCartInDb(productId, fromCard = false) {
            if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return Promise.reject("User is blocked");
            }
            if (!currentUser || currentUser.isAnonymous) { 
                showToast("Please log in to manage your cart.", false); 
                openDrawer('profile-drawer'); 
                return Promise.reject("User not logged in"); 
            }
            const product = productsData.find(p => p.id === productId);
            if (!product) return Promise.reject("Product not found");
            
            if (Number(product.stock) <= 0) {
                showToast('toast-out-of-stock', false);
                return Promise.reject("Product is out of stock");
            }
            
            const requiredVariants = getRequiredVariants(product);
            
            if (fromCard && requiredVariants.length > 0) {
                 showProductDetails(productId);
                 showToast('toast-select-variant', false);
                 return Promise.reject("Variants not selected");
            }
            
            for(const variant of requiredVariants) {
                if (!selectedVariants[variant]) {
                    showToast('toast-select-variant', false);
                    return Promise.reject("Variants not selected");
                }
            }

            // Only include variant keys that are actually applicable to this product
            const variantFieldMap = { size: 'sizes', storage: 'storage', color: 'colors' };
            const applicableVariantKeys = ['size','storage','color'].filter(k => {
                const fieldName = variantFieldMap[k];
                const val = product[fieldName];
                return Array.isArray(val) ? val.length > 0 : !!val;
            });
            const selectedForProduct = {};
            for (const key of applicableVariantKeys) {
                if (selectedVariants[key]) selectedForProduct[key] = selectedVariants[key];
            }
            // Use distinct codes for variants to avoid collisions (legacy used _S: for both size and storage)
            const codeMap = { size: 'SZ', storage: 'ST', color: 'C' };
            const sortedVariantKeys = Object.keys(selectedForProduct).sort();
            const variantString = sortedVariantKeys.map(key => `_${codeMap[key]}:${selectedForProduct[key]}`).join('');
            const cartItemId = productId + variantString;
            
            const userDocRef = doc(db, 'users', currentUser.uid);
            
            try {
                const currentItem = localCartCache.get(cartItemId);
                if (currentItem) {
                    // Optimistic increment
                    const backupQty = currentItem.quantity || 0;
                    currentItem.quantity = backupQty + 1;
                    localCartCache.set(cartItemId, currentItem);
                    updateCartUI();
                    await updateDoc(userDocRef, new FieldPath('cart', cartItemId, 'quantity'), increment(1));
                } else {
                    const newItemData = {
                        productId: product.id || '',
                        name: product.name || 'Unknown Product',
                        price: product.price || 0,
                        image: product.imageUrl || product.image || 'https://placehold.co/80x80/ccc/000?text=Image',
                        quantity: 1,
                        ...selectedForProduct
                    };
                    // Optimistic add
                    localCartCache.set(cartItemId, newItemData);
                    updateCartUI();
                    await setDoc(userDocRef, { cart: { [cartItemId]: newItemData } }, { merge: true });
                }
                showToast('toast-cart-added');
                return Promise.resolve();
            } catch (error) {
                 console.error("Error adding to cart: ", error);
                 // Rollback optimistic update for add/increment
                 const existing = localCartCache.get(cartItemId);
                 if (existing) {
                    if ((existing.quantity || 0) > 1) {
                        existing.quantity = (existing.quantity || 1) - 1;
                        localCartCache.set(cartItemId, existing);
                    } else {
                        localCartCache.delete(cartItemId);
                    }
                    updateCartUI();
                 }
                 showToast("Error: Could not add to cart", false);
                 return Promise.reject(error);
            }
        }
        window.addToCartInDb = addToCartInDb;
        
        async function removeFromCart(cartItemId) {
            if (!currentUser || currentUser.isAnonymous) {
                showToast("Please log in to manage your cart.", false);
                openDrawer('profile-drawer');
                return;
            }
            const userDocRef = doc(db, 'users', currentUser.uid);
            // Optimistic update
            const backup = localCartCache.get(cartItemId);
            if (backup) {
                localCartCache.delete(cartItemId);
                updateCartUI();
            }
            try {
                await updateDoc(userDocRef, new FieldPath('cart', cartItemId), deleteField());
                // Remove DOM row immediately as a visual confirmation
                const rowSelector = `[data-cart-item-id="${cartItemId}"]`;
                document.querySelectorAll(rowSelector).forEach(el => el.remove());
                // If cache is empty now, show empty state
                if (localCartCache.size === 0) {
                    const emptyHtml = `<p data-lang="cart-empty" class="text-center text-gray-500">${translations[currentLanguage]['cart-empty']}</p>`;
                    const cartEl = DOMElements.cartItems;
                    const pageItems = document.getElementById('cart-page-items');
                    if (cartEl && !cartEl.innerHTML.trim()) cartEl.innerHTML = emptyHtml;
                    if (pageItems && !pageItems.innerHTML.trim()) pageItems.innerHTML = emptyHtml;
                }
            } catch (error) {
                // Rollback on error
                if (backup) {
                    localCartCache.set(cartItemId, backup);
                    updateCartUI();
                }
                console.error("Error removing from cart: ", error);
                showToast("Error: Could not remove item", false);
            }
        }
        window.removeFromCart = removeFromCart;

        async function updateQuantity(cartItemId, change) {
            if (!currentUser || currentUser.isAnonymous) {
                showToast("Please log in to manage your cart.", false);
                openDrawer('profile-drawer');
                return;
            }
            const currentItem = localCartCache.get(cartItemId);
            const currentQuantity = currentItem?.quantity || 0;
            if (currentQuantity + change <= 0) {
                // Optimistic remove when quantity would go to 0 or less
                await removeFromCart(cartItemId);
                return;
            }
            // Optimistic quantity update
            const userDocRef = doc(db, 'users', currentUser.uid);
            const backupQty = currentQuantity;
            if (currentItem) {
                currentItem.quantity = currentQuantity + change;
                localCartCache.set(cartItemId, currentItem);
                updateCartUI();
            }
            try {
                await updateDoc(userDocRef, new FieldPath('cart', cartItemId, 'quantity'), increment(change));
            } catch (error) {
                // Rollback on error
                if (currentItem) {
                    currentItem.quantity = backupQty;
                    localCartCache.set(cartItemId, currentItem);
                    updateCartUI();
                }
                console.error("Error updating quantity: ", error);
                showToast("Error: Could not update quantity", false);
            }
        }
        window.updateQuantity = updateQuantity;
        
        async function toggleWishlistInDb(productId) {
             if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return;
            }
            if (!currentUser || currentUser.isAnonymous) { showToast("Please log in to manage your wishlist.", false); openDrawer('profile-drawer'); return; }
            const userDocRef = doc(db, 'users', currentUser.uid);
            const isWished = localWishlistCache.has(productId);

            try {
                if (isWished) {
                    await updateDoc(userDocRef, { [`wishlist.${productId}`]: deleteField() });
                } else {
                    await setDoc(userDocRef, { wishlist: { [productId]: true } }, { merge: true });
                }
                showToast(isWished ? 'toast-wishlist-removed' : 'toast-wishlist-added', true);
            } catch (error) {
                console.error("Error updating wishlist: ", error);
                showToast("Error: Could not update wishlist", false);
            }
        }
        
        async function updateCartUI() {
            // Use effective price: prefer item.price, fall back to product price from productsData
            const subtotal = Array.from(localCartCache.entries()).reduce((sum, [cartItemId, item]) => {
                const productRef = getProductRefForCartItem(cartItemId, item);
                const unitPrice = Number(item?.price ?? productRef?.price ?? 0);
                const qty = Number(item?.quantity ?? 0);
                return sum + (unitPrice * qty);
            }, 0);
            
            const deliveryCharge = await getDeliveryCharge(subtotal);
            const total = subtotal + deliveryCharge - discountAmount;
            
            if (DOMElements.cartSubtotal) DOMElements.cartSubtotal.textContent = `‡ß≥${subtotal.toFixed(2)}`;
            
            if (discountAmount > 0) {
             if (DOMElements.discountRow) DOMElements.discountRow.classList.remove('hidden');
             if (DOMElements.cartDiscount) DOMElements.cartDiscount.textContent = `- ‡ß≥${discountAmount.toFixed(2)}`;
            } else {
              if (DOMElements.discountRow) DOMElements.discountRow.classList.add('hidden');
            }
            
          if (DOMElements.deliveryCharge) DOMElements.deliveryCharge.textContent = `‡ß≥${deliveryCharge.toFixed(2)}`;
          if (DOMElements.cartTotal) DOMElements.cartTotal.textContent = `‡ß≥${total.toFixed(2)}`;

            // Mirror values to full-page cart if present
            const pageSubtotal = document.getElementById('cart-page-subtotal');
            const pageDelivery = document.getElementById('cart-page-delivery');
            const pageTotal = document.getElementById('cart-page-total');
            const pageDiscountRow = document.getElementById('cart-page-discount-row');
            const pageDiscount = document.getElementById('cart-page-discount');
            if (pageSubtotal) pageSubtotal.textContent = `‡ß≥${subtotal.toFixed(2)}`;
            if (pageDelivery) pageDelivery.textContent = `‡ß≥${deliveryCharge.toFixed(2)}`;
            if (pageTotal) pageTotal.textContent = `‡ß≥${total.toFixed(2)}`;
            if (pageDiscountRow && pageDiscount) {
                if (discountAmount > 0) {
                    pageDiscountRow.classList.remove('hidden');
                    pageDiscount.textContent = `- ‡ß≥${discountAmount.toFixed(2)}`;
                } else {
                    pageDiscountRow.classList.add('hidden');
                }
            }

            // Applied coupon message under Order Summary input
            const pageCouponMsg = document.getElementById('cart-page-coupon-applied');
            if (pageCouponMsg) {
                if (appliedCouponCode && discountAmount > 0) {
                    pageCouponMsg.textContent = `Applied ${appliedCouponCode}: - ‡ß≥${discountAmount.toFixed(2)}`;
                    pageCouponMsg.classList.remove('hidden');
                } else {
                    pageCouponMsg.classList.add('hidden');
                    pageCouponMsg.textContent = '';
                }
            }

            const totalItems = Array.from(localCartCache.values()).reduce((sum, item) => sum + (item.quantity || 0), 0);
            if (DOMElements.cartCount) DOMElements.cartCount.textContent = totalItems;
            renderCartItems();
        }

      async function getDeliveryCharge(subtotal) {
          if (!currentUser || !currentUserData) return 0;
          if (subtotal <= 0) return 0;
            
            const ordersRef = collection(db, "orders");
            // NOTE: We rely on client-side sorting instead of Firestore orderBy for simplicity/index avoidance
            const q = query(ordersRef, where("userId", "==", currentUser.uid));
            const querySnapshot = await getDocs(q);
            const isFirstOrder = querySnapshot.empty;
            
            const location = (currentUserData?.location || "").toLowerCase();
            const isInTangail = location.includes("tangail");

            if (isInTangail) {
                return isFirstOrder && subtotal > 500 ? 0 : 100;
            } else {
                return isFirstOrder && subtotal > 1000 ? 0 : 200;
            }
        }

        function renderCartItems() {
            const cartEl = DOMElements.cartItems;
            const pageItems = document.getElementById('cart-page-items');
            if (!currentUser || currentUser.isAnonymous) {
                if (cartEl) cartEl.innerHTML = `<p class="text-center text-gray-500">Please log in to see your cart.</p>`;
                if (pageItems) pageItems.innerHTML = `<p class="text-center text-gray-500">Please log in to see your cart.</p>`;
                return;
            }
            
            let cartHtml = '';
            
            if(localCartCache.size === 0){
                // Empty state with smart suggestions from wishlist or featured products
                const emptyMsg = `<p data-lang="cart-empty" class="text-center text-gray-500 mb-4">${translations[currentLanguage]['cart-empty']}</p>`;
                let subheading = '';
                let suggested = [];
                try {
                    const all = Array.isArray(productsData) ? productsData : [];
                    if (localWishlistCache && localWishlistCache.size > 0) {
                        subheading = '<h4 class="text-center font-semibold text-gray-800 dark:text-gray-100 mb-3">Add items from your Wishlist?</h4>';
                        suggested = all.filter(p => p && localWishlistCache.has(p.id));
                    } else {
                        subheading = '<h4 class="text-center font-semibold text-gray-800 dark:text-gray-100 mb-3">Shop our Featured Products</h4>';
                        suggested = all.slice().sort((a,b) => (Number(b.ratingCount)||0) - (Number(a.ratingCount)||0));
                    }
                } catch (e) { /* fallback: no suggestions */ }

                // Horizontal row showing up to 6 products
                const row = (suggested && suggested.length > 0) ? (`
                    <div class="flex gap-4 overflow-x-auto pb-2 -mx-1 px-1">
                        ${suggested.slice(0, 6).map(p => {
                            const img = p?.imageUrl || p?.image || 'https://placehold.co/300x300/f5f7fa/6a0dad?text=Product';
                            const name = (p?.name || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                            const price = Number(p?.price || 0);
                            return `
                                <div class="w-40 flex-shrink-0 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 overflow-hidden">
                                    <div class="aspect-square bg-gray-50 dark:bg-gray-900 flex items-center justify-center overflow-hidden">
                                        <img src="${img}" alt="${name}" class="w-full h-full object-cover"/>
                                    </div>
                                    <div class="p-3 flex flex-col gap-2">
                                        <p class="text-sm font-medium line-clamp-2">${name}</p>
                                        <div class="text-sm font-semibold text-price-black">‡ß≥${price.toFixed(0)}</div>
                                        <button class="mt-auto inline-flex items-center justify-center px-3 py-1.5 text-sm rounded-full bg-theme-pink text-white hover:bg-theme-purple"
                                            onclick="addToCartInDb && addToCartInDb('${p?.id}', true)">Add to Cart</button>
                                    </div>
                                </div>`;
                        }).join('')}
                    </div>
                `) : '';

                const combinedHtml = `<div class="py-4">${emptyMsg}${subheading}${row}</div>`;
                if (cartEl) cartEl.innerHTML = combinedHtml;
                if (pageItems) pageItems.innerHTML = combinedHtml;
            } else {
                for (const [cartItemId, item] of localCartCache.entries()) {
                    // Build variants text
                    let variantsHtml = '<div class="text-[11px] text-gray-500 mt-0.5">';
                    if (item.size) variantsHtml += `Size: ${item.size} `;
                    if (item.color) variantsHtml += `Color: ${item.color} `;
                    if (item.storage) variantsHtml += `Storage: ${item.storage} `;
                    variantsHtml += '</div>';

                    // Enrich with product data for missing fields and discount/original price
                    const productRef = getProductRefForCartItem(cartItemId, item);
                    const displayName = item?.name || productRef?.name || 'Unknown Product';
                    const displayImage = item?.image || productRef?.imageUrl || productRef?.image || 'https://placehold.co/80x80/ccc/000?text=Image';
                    const unitPrice = Number(item?.price ?? productRef?.price ?? 0);
                    const hasDiscount = !!(productRef && productRef.isOffer && productRef.originalPrice && productRef.originalPrice > unitPrice);
                    const discountPercent = hasDiscount ? Math.round(((Number(productRef.originalPrice) - unitPrice) / Number(productRef.originalPrice)) * 100) : 0;

                    let priceHtml = '';
                    if (hasDiscount) {
                        priceHtml = `
                            <div class="flex items-baseline gap-2 flex-wrap mt-1">
                                <span class="text-base sm:text-md font-bold text-price-black">‡ß≥${unitPrice.toFixed(2)}</span>
                                <span class="text-xs text-gray-400 line-through">‡ß≥${Number(productRef.originalPrice).toFixed(2)}</span>
                                <span class="text-[10px] font-bold text-red-600 bg-red-50 px-1.5 py-0.5 rounded">-${discountPercent}%</span>
                            </div>`;
                    } else {
                        priceHtml = `<div class="mt-1"><span class="text-base sm:text-md font-bold text-price-black">‡ß≥${unitPrice.toFixed(2)}</span></div>`;
                    }

                    // Compose each cart row (mobile-first, Temu-like compact)
                    cartHtml += `
                        <div class="rounded-2xl border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-700 p-3 sm:p-4 shadow-sm" data-cart-item-id="${cartItemId}">
                            <div class="flex gap-3">
                                <img src="${displayImage}" alt="${displayName}" class="w-16 h-16 sm:w-20 sm:h-20 rounded-xl object-cover flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/80x80/ccc/000?text=Image';">
                                <div class="flex-1 min-w-0">
                                    <h4 class="text-[15px] sm:text-base font-semibold text-theme-purple leading-tight break-words">${displayName}</h4>
                                    ${variantsHtml}
                                    ${priceHtml}
                                </div>
                                <button onclick="removeFromCart('${cartItemId}')" class="text-red-500 hover:text-red-600 ml-1 self-start"><i class="fas fa-trash"></i></button>
                            </div>
                            <div class="mt-2 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <button onclick="updateQuantity('${cartItemId}', -1)" class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-600 text-dark dark:text-gray-200 hover:bg-gray-300 transition-colors">-</button>
                                    <span class="w-8 text-center text-dark">${item.quantity}</span>
                                    <button onclick="updateQuantity('${cartItemId}', 1)" class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-600 text-dark dark:text-gray-200 hover:bg-gray-300 transition-colors">+</button>
                                </div>
                                <div class="text-[12px] text-gray-500">‡ß≥${(unitPrice * (item.quantity || 0)).toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                }
                // Also append a Featured Products section below the cart items
                let featuredSection = '';
                try {
                    const all = Array.isArray(productsData) ? productsData : [];
                    const suggested = all.slice().sort((a,b) => (Number(b.ratingCount)||0) - (Number(a.ratingCount)||0));
                    if (suggested.length > 0) {
                        const row = `
                            <div class="flex gap-4 overflow-x-auto pb-2 -mx-1 px-1">
                                ${suggested.slice(0, 6).map(p => {
                                    const img = p?.imageUrl || p?.image || 'https://placehold.co/300x300/f5f7fa/6a0dad?text=Product';
                                    const name = (p?.name || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                                    const price = Number(p?.price || 0);
                                    return `
                                        <div class="w-40 flex-shrink-0 rounded-xl border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 overflow-hidden">
                                            <div class="aspect-square bg-gray-50 dark:bg-gray-900 flex items-center justify-center overflow-hidden">
                                                <img src="${img}" alt="${name}" class="w-full h-full object-cover"/>
                                            </div>
                                            <div class="p-3 flex flex-col gap-2">
                                                <p class="text-sm font-medium line-clamp-2">${name}</p>
                                                <div class="text-sm font-semibold text-price-black">‡ß≥${price.toFixed(0)}</div>
                                                <button class="mt-auto inline-flex items-center justify-center px-3 py-1.5 text-sm rounded-full bg-theme-pink text-white hover:bg-theme-purple"
                                                    onclick="addToCartInDb && addToCartInDb('${p?.id}', true)">Add to Cart</button>
                                            </div>
                                        </div>`;
                                }).join('')}
                            </div>
                        `;
                        featuredSection = `
                            <div class="mt-5 pt-4 border-t border-gray-200 dark:border-gray-700">
                                <h4 class="text-base font-semibold text-gray-800 dark:text-gray-100 mb-3">Featured Products</h4>
                                ${row}
                            </div>`;
                    }
                } catch(e) { /* ignore */ }

                const combined = cartHtml + featuredSection;
                if (cartEl) cartEl.innerHTML = combined;
                if (pageItems) pageItems.innerHTML = combined;
            }
        }
        
        function updateWishlistUI() {
            renderProducts(currentDisplayedProducts);
            if (!document.getElementById('wishlist-page').classList.contains('hidden')) {
                renderWishlistItems();
            }
        }

        function renderWishlistItems() {
            DOMElements.wishlistItems.innerHTML = '';
            if (localWishlistCache.size === 0) {
                DOMElements.wishlistItems.innerHTML = `<p class="col-span-full text-center text-gray-500" data-lang="wishlist-empty">${translations[currentLanguage]['wishlist-empty']}</p>`;
                return;
            }
            const wishedProducts = productsData.filter(p => localWishlistCache.has(p.id));
            
            const tempContainer = document.createElement('div');
            // Temporarily re-assign productList to render into our temp container
            const originalProductList = DOMElements.productList;
            DOMElements.productList = tempContainer;
            renderContext = 'wishlist';
            renderProducts(wishedProducts);
            // Inject Remove buttons in place of the wishlist heart
            const tmp = document.createElement('div');
            tmp.innerHTML = tempContainer.innerHTML;
            tmp.querySelectorAll('.product-card').forEach(card => {
                const wishBtn = card.querySelector('.wishlist');
                if (wishBtn) {
                    const pid = wishBtn.getAttribute('data-product-id') || (card.dataset.productId || '');
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-from-wishlist bg-red-500 text-white py-2 px-4 rounded-full font-semibold hover:bg-red-600 transition-colors';
                    removeBtn.setAttribute('data-product-id', pid);
                    removeBtn.textContent = translations[currentLanguage]['remove'] || 'Remove';
                    wishBtn.replaceWith(removeBtn);
                }
            });
            DOMElements.wishlistItems.innerHTML = tmp.innerHTML;
            DOMElements.productList = originalProductList; // Reset to original
            renderContext = null;
        }

        // --- CART HELPERS ---
        function getBaseProductId(cartItemId) {
            if (!cartItemId) return '';
            // Find start of variant segment. Support both legacy keys (_S:, _C:) and new keys (_SZ:, _ST:, _C:)
            const indices = [
                cartItemId.indexOf('_SZ:'), // size (new)
                cartItemId.indexOf('_ST:'), // storage (new)
                cartItemId.indexOf('_S:'),  // legacy size/storage
                cartItemId.indexOf('_C:')   // color (legacy and new)
            ].filter(i => i >= 0);
            if (indices.length === 0) return cartItemId;
            const minIdx = Math.min(...indices);
            return cartItemId.slice(0, minIdx);
        }

        function getProductRefForCartItem(cartItemId, item) {
            const pid = item?.productId || getBaseProductId(cartItemId);
            if (!pid) return null;
            return (productsData || []).find(p => p.id === pid) || null;
        }
        // --- END CART HELPERS ---

        // --- AUTHENTICATION ---
        
        async function initialAuthBootstrap() {
            if (window.initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, window.initialAuthToken);
                } catch (error) {
                    console.warn("Custom token sign-in failed. Anonymous sign-in attempt skipped due to potential auth restrictions. Error:", error);
                }
            } else {
                console.log("No initial auth token provided. Skipping anonymous sign-in attempt to avoid errors.");
            }
        }
        
        onAuthStateChanged(auth, user => {
             // Stop listening for previous user's block status
            unsubscribeUserStatus();
            
            if (user && !user.isAnonymous) {
                currentUser = user;
                const userRef = doc(db, 'users', user.uid);
                // Backfill createdAt if missing
                getDoc(userRef).then(snap => {
                    if (snap.exists() && !snap.data()?.createdAt) {
                        updateDoc(userRef, { createdAt: serverTimestamp() }).catch(() => {});
                    }
                }).catch(() => {});
                
                // Listen for real-time changes to the user's block status
                unsubscribeUserStatus = onSnapshot(userRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const userData = docSnap.data();
                        isCurrentUserBlocked = userData.isBlocked || false;

                        if (isCurrentUserBlocked) {
                            showBlockedUI('account-blocked-banner');
                        } else {
                            hideBlockedUI();
                        }
                    }
                });

                setupFirestoreListeners(user);
            } else if (user && user.isAnonymous) {
                currentUser = null;
                isCurrentUserBlocked = false;
                hideBlockedUI();
                setupFirestoreListeners(null);
            } else {
                currentUser = null;
                isCurrentUserBlocked = false;
                hideBlockedUI();
                setupFirestoreListeners(null);
            }
        });

        function updateProfileModalUI(user, data = null) {
            const userData = data || currentUserData;
            if (user && !user.isAnonymous) {
                DOMElements.authOptions.classList.add('hidden');
                DOMElements.userProfileView.classList.remove('hidden');
                DOMElements.editProfileForm.classList.add('hidden');
                DOMElements.userPhoto.src = user.photoURL || 'https://placehold.co/96x96/6a0dad/white?text=User';
                DOMElements.userName.textContent = user.displayName || 'User';
                DOMElements.userEmail.textContent = user.email;
                DOMElements.userMobile.textContent = userData?.mobile ? `üì± ${userData.mobile}` : '';
                // Prefer default saved address for display if available
                const addrs = Array.isArray(userData?.addresses) ? userData.addresses : [];
                if (addrs.length > 0) {
                    const def = getDefaultAddress(addrs) || addrs[0];
                    DOMElements.userLocation.textContent = def?.line1 ? `üìç ${def.line1}${def.city ? ', ' + def.city : ''}` : '';
                } else {
                    DOMElements.userLocation.textContent = userData?.location ? `üìç ${userData.location}` : '';
                }

            } else {
                DOMElements.authOptions.classList.remove('hidden');
                DOMElements.userProfileView.classList.add('hidden');
                DOMElements.editProfileForm.classList.add('hidden');
                const addrSec = DOMElements.addressesSection; if (addrSec) addrSec.classList.add('hidden');
            }
        }
        
        async function handleGoogleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const userDocRef = doc(db, 'users', user.uid);
                const docSnap = await getDoc(userDocRef);
             if (!docSnap.exists()) {
                 await setDoc(userDocRef, { email: user.email, name: user.displayName, photoURL: user.photoURL, cart: {}, wishlist: {}, usedCoupons: [], mobile: '', location: '', addresses: [], isBlocked: false, createdAt: serverTimestamp() });
             } else if (!docSnap.data()?.createdAt) {
                 await updateDoc(userDocRef, { createdAt: serverTimestamp() });
             }
                closeDrawer();
                showToast('toast-login-success');
            } catch (error) {
                console.error("Google sign-in error", error);
                if (error.code === 'auth/unauthorized-domain') {
                    DOMElements.authError.textContent = "This domain is not authorized. Please add it in your Firebase console.";
                } else {
                    DOMElements.authError.textContent = error.message;
                }
            }
        }

        async function handleFacebookLogin() {
            const provider = new FacebookAuthProvider();
            // Optional: request additional scopes
            // provider.addScope('public_profile');
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const userDocRef = doc(db, 'users', user.uid);
                const docSnap = await getDoc(userDocRef);
                if (!docSnap.exists()) {
                    await setDoc(userDocRef, { email: user.email || '', name: user.displayName || 'Facebook User', photoURL: user.photoURL || '', cart: {}, wishlist: {}, usedCoupons: [], mobile: '', location: '', addresses: [], isBlocked: false, createdAt: serverTimestamp() });
                } else if (!docSnap.data()?.createdAt) {
                    await updateDoc(userDocRef, { createdAt: serverTimestamp() });
                }
                closeDrawer();
                showToast('toast-login-success');
            } catch (error) {
                console.error('Facebook sign-in error', error);
                if (error.code === 'auth/account-exists-with-different-credential') {
                    DOMElements.authError.textContent = 'An account already exists with the same email. Please sign in with the provider you used previously.';
                } else if (error.code === 'auth/unauthorized-domain') {
                    DOMElements.authError.textContent = 'This domain is not authorized for Facebook login. Add it in your Firebase console Auth settings.';
                } else {
                    DOMElements.authError.textContent = error.message;
                }
            }
        }

        async function handleLogout() {
            try {
                await signOut(auth);
                // Re-authenticate anonymously to maintain connection
                await signInAnonymously(auth);
                closeDrawer();
                showToast('toast-logout-success');
            } catch (error) {
                console.error("Logout error", error);
            }
        }

        function toggleAuthForms(formToShow) {
            DOMElements.authError.textContent = '';
            // Hide all
            DOMElements.loginForm.classList.add('hidden');
            DOMElements.registerForm.classList.add('hidden');
            if (DOMElements.resetForm) DOMElements.resetForm.classList.add('hidden');

            if (formToShow === 'register') {
                DOMElements.registerForm.classList.remove('hidden');
                DOMElements.profileDrawerTitle.textContent = translations[currentLanguage]['register'] || 'Register';
            } else if (formToShow === 'reset') {
                if (DOMElements.resetForm) {
                    // Prefill email from login form if present
                    const loginEmail = document.getElementById('login-email')?.value || '';
                    if (loginEmail) DOMElements.resetEmail.value = loginEmail;
                    DOMElements.resetForm.classList.remove('hidden');
                    DOMElements.profileDrawerTitle.textContent = 'Reset Password';
                } else {
                    // fallback to login
                    DOMElements.loginForm.classList.remove('hidden');
                    DOMElements.profileDrawerTitle.textContent = translations[currentLanguage]['login'] || 'Login';
                }
            } else {
                DOMElements.loginForm.classList.remove('hidden');
                DOMElements.profileDrawerTitle.textContent = translations[currentLanguage]['login'] || 'Login';
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const name = DOMElements.registerForm.querySelector('#register-name').value;
            const mobile = DOMElements.registerForm.querySelector('#register-mobile').value;
            const location = DOMElements.registerForm.querySelector('#register-location').value;
            const email = DOMElements.registerForm.querySelector('#register-email').value;
            const password = DOMElements.registerForm.querySelector('#register-password').value;
            DOMElements.authError.textContent = '';

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, {
                    displayName: name
                });
                const userDocRef = doc(db, 'users', userCredential.user.uid);
                await setDoc(userDocRef, { email: userCredential.user.email, name, mobile, location, addresses: [], cart: {}, wishlist: {}, usedCoupons: [], isBlocked: false, createdAt: serverTimestamp() });

                closeDrawer();
                showToast('toast-register-success', true); 
            } catch (error) {
                DOMElements.authError.textContent = error.message;
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            // FIX: Corrected DOMEElements to DOMElements
            const email = DOMElements.loginForm.querySelector('#login-email').value;
            const password = DOMElements.loginForm.querySelector('#login-password').value;
            DOMElements.authError.textContent = '';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeDrawer();
                showToast('toast-login-success');
            } catch (error) {
                 // Better messaging for common cases
                 if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                     try {
                         const methods = await fetchSignInMethodsForEmail(auth, email);
                         if (!methods || methods.length === 0) {
                             // No account exists for this email
                             DOMElements.authError.textContent = currentLanguage === 'bn'
                                 ? "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßã‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"
                                 : "You don't have an account. Please create one.";
                         } else {
                             // Account exists but password is wrong or signed up with provider
                             if (methods.includes('password')) {
                                 DOMElements.authError.textContent = currentLanguage === 'bn'
                                     ? "‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Ø‡¶º‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"
                                     : "Incorrect password. Please try again.";
                             } else if (methods.includes('google.com') || methods.includes('facebook.com')) {
                                 DOMElements.authError.textContent = currentLanguage === 'bn'
                                     ? "‡¶Ü‡¶™‡¶®‡¶ø ‡¶∏‡ßã‡¶∂‡ßç‡¶Ø‡¶æ‡¶≤ ‡¶≤‡¶ó‡¶á‡¶® ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶∏‡¶æ‡¶á‡¶® ‡¶Ü‡¶™ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶∏‡ßá‡¶á ‡¶™‡ßç‡¶∞‡ßã‡¶≠‡¶æ‡¶á‡¶°‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"
                                     : "This email is registered via social login. Please sign in with that provider.";
                             } else {
                                 DOMElements.authError.textContent = error.message;
                             }
                         }
                     } catch (e2) {
                         DOMElements.authError.textContent = currentLanguage === 'bn'
                             ? "‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶§‡¶•‡ßç‡¶Ø‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"
                             : "Login failed. Please verify your details.";
                     }
                 } else if (error.code === 'auth/user-not-found') {
                     DOMElements.authError.textContent = currentLanguage === 'bn'
                         ? "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßã‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"
                         : "You don't have an account. Please create one.";
                 } else if (error.code === 'auth/invalid-email') {
                     DOMElements.authError.textContent = currentLanguage === 'bn'
                         ? "‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶†‡¶ø‡¶ï‡¶æ‡¶®‡¶æ ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡¶Ø‡¶º‡•§"
                         : "Invalid email address.";
                 } else {
                     DOMElements.authError.textContent = error.message;
                 }
            }
        }

        async function handlePasswordReset(e) {
            e.preventDefault();
            try {
                const email = DOMElements.resetEmail.value.trim();
                DOMElements.authError.textContent = '';
                if (!email) {
                    DOMElements.authError.textContent = 'Please enter your email.';
                    return;
                }
                await sendPasswordResetEmail(auth, email);
                showToast('Password reset email sent! Check your inbox.');
                // Navigate back to login
                toggleAuthForms('login');
            } catch (error) {
                console.error('Password reset error', error);
                if (error.code === 'auth/invalid-email') {
                    DOMElements.authError.textContent = 'Invalid email address.';
                } else if (error.code === 'auth/user-not-found') {
                    DOMElements.authError.textContent = 'No user found with this email.';
                } else {
                    DOMElements.authError.textContent = error.message;
                }
            }
        }

        async function reauthenticateForSensitiveAction() {
            // Try to reauthenticate depending on the provider
            const user = auth.currentUser;
            if (!user) throw new Error('No authenticated user');
            const providerId = user.providerData?.[0]?.providerId;

            try {
                if (providerId === 'google.com') {
                    const provider = new GoogleAuthProvider();
                    await reauthenticateWithPopup(user, provider);
                } else if (providerId === 'facebook.com') {
                    const provider = new FacebookAuthProvider();
                    await reauthenticateWithPopup(user, provider);
                } else if (providerId === 'password') {
                    // Prompt the user for their password
                    const email = user.email;
                    const password = prompt('Please re-enter your password to confirm deletion:');
                    if (!password) throw new Error('Reauthentication cancelled.');
                    const credential = EmailAuthProvider.credential(email, password);
                    await reauthenticateWithCredential(user, credential);
                } else {
                    // Default: try Google popup if available, else fail
                    const provider = new GoogleAuthProvider();
                    await reauthenticateWithPopup(user, provider);
                }
                return true;
            } catch (e) {
                console.error('Reauthentication failed:', e);
                return false;
            }
        }

        async function handleDeleteAccountConfirmed() {
            if (!currentUser) return;
            const user = currentUser;

            const attemptDelete = async () => {
                // 1. Delete Firestore user document
                const userDocRef = doc(db, 'users', user.uid);
                await deleteDoc(userDocRef).catch(() => {}); // tolerate if already missing

                // 2. Delete profile photo from Storage (if exists)
                if (user.photoURL) {
                    const storageRef = ref(storage, `profileImages/${user.uid}`);
                    await deleteObject(storageRef).catch(e => console.log("No profile image found to delete or storage permission denied.", e));
                }

                // 3. Delete the user from Firebase Auth
                await deleteUser(user);
            };

            try {
                await attemptDelete();
                // Show success immediately if delete succeeded, regardless of anon sign-in
                showToast('account-deleted', true);
                closeDrawer();
                // Best-effort: sign in anonymously (do not impact success)
                signInAnonymously(auth).catch(e => console.warn('Anonymous sign-in failed after delete (non-fatal):', e));
            } catch (error) {
                console.error("Error deleting account:", error);
                if (error.code === 'auth/requires-recent-login') {
                    const ok = await reauthenticateForSensitiveAction();
                    if (ok) {
                        try {
                            await attemptDelete();
                            showToast('account-deleted', true);
                            closeDrawer();
                            signInAnonymously(auth).catch(e => console.warn('Anonymous sign-in failed after delete (non-fatal):', e));
                            return;
                        } catch (e2) {
                            console.error('Delete after reauth failed:', e2);
                        }
                    }
                }
                showToast('delete-account-failed', false);
            }
        }
        
        function handleDeleteAccount() {
            if (!currentUser || currentUser.isAnonymous) return;
            
            showConfirmModal(
                translations[currentLanguage]['delete-account-confirm'],
                translations[currentLanguage]['confirm-delete-title'],
                handleDeleteAccountConfirmed
            );
        }
        
        async function handleProfileUpdate(e) {
            e.preventDefault();
            if (!currentUser || currentUser.isAnonymous) return;
            
            const saveBtn = DOMElements.saveProfileBtn;
            saveBtn.querySelector('.btn-text').classList.add('hidden');
            saveBtn.querySelector('.loader-small').classList.remove('hidden');
            saveBtn.disabled = true;

            const newName = DOMElements.editNameInput.value;
            const newMobile = DOMElements.editMobileInput.value;
            const newLocation = DOMElements.editLocationInput.value;
            const photoFile = DOMElements.editPhotoInput.files[0];
            const wantRemovePhoto = DOMElements.editPhotoInput.dataset.remove === 'true';

            const authUpdateData = {};
            const firestoreUpdateData = {};

            if (newName !== currentUser.displayName) {
                authUpdateData.displayName = newName;
                firestoreUpdateData.name = newName;
            }
            if (newMobile !== (currentUserData.mobile || '')) {
                firestoreUpdateData.mobile = newMobile;
            }
            if (newLocation !== (currentUserData.location || '')) {
                firestoreUpdateData.location = newLocation;
            }

            try {
                if (photoFile) {
                    const storageRef = ref(storage, `profileImages/${currentUser.uid}`);
                    await uploadBytes(storageRef, photoFile);
                    const downloadURL = await getDownloadURL(storageRef);
                    authUpdateData.photoURL = downloadURL;
                    firestoreUpdateData.photoURL = downloadURL;
                } else if (wantRemovePhoto) {
                    // Remove profile image from Storage and clear URLs
                    try {
                        const storageRef = ref(storage, `profileImages/${currentUser.uid}`);
                        await deleteObject(storageRef);
                    } catch (e) {
                        console.log('No profile image to delete or permission denied.', e);
                    }
                    authUpdateData.photoURL = null;
                    firestoreUpdateData.photoURL = deleteField();
                }

                if (Object.keys(authUpdateData).length > 0) {
                    await updateProfile(auth.currentUser, authUpdateData);
                }

                if (Object.keys(firestoreUpdateData).length > 0) {
                    const userDocRef = doc(db, 'users', currentUser.uid);
                    await updateDoc(userDocRef, firestoreUpdateData);
                }
                
                // Reset file input and remove flag, update profile avatar preview
                DOMElements.editPhotoInput.value = '';
                delete DOMElements.editPhotoInput.dataset.remove;
                if (authUpdateData.photoURL === null) {
                    // Removed photo
                    DOMElements.userPhoto.src = 'https://placehold.co/96x96/6a0dad/white?text=User';
                } else if (authUpdateData.photoURL) {
                    DOMElements.userPhoto.src = authUpdateData.photoURL;
                }
                showToast('profile-updated');
                DOMElements.editProfileForm.classList.add('hidden');
                DOMElements.userProfileView.classList.remove('hidden');

            } catch(error) {
                console.error("Full error object:", error);
                let errorMessageKey = 'profile-update-fail';
                 if (error.code && error.code.includes('storage/unauthorized')) {
                    errorMessageKey = 'toast-storage-permission-error'; 
                }
                showToast(errorMessageKey, false);
            } finally {
                saveBtn.querySelector('.btn-text').classList.remove('hidden');
                saveBtn.querySelector('.loader-small').classList.add('hidden');
                saveBtn.disabled = false;
            }
        }

        // --- DRAWER & MODAL LOGIC ---
        function openDrawer(drawerId) {
            closeDrawer(); // Stop chat listener when closing drawers
            
            const drawer = document.getElementById(drawerId);
            if (drawer) {
                if (drawerId === 'profile-drawer') {
                    if (!currentUser || currentUser.isAnonymous) {
                       toggleAuthForms('login');
                    } else {
                       DOMElements.profileDrawerTitle.dataset.lang = "your-account";
                       DOMElements.userProfileView.classList.remove('hidden');
                       DOMElements.editProfileForm.classList.add('hidden');
                       updateTextContent();
                    }
                }
                DOMElements.drawerOverlay.classList.remove('hidden');
                drawer.classList.add('active');
                if(drawerId === 'cart-drawer') {
                    updateCartUI();
                    // Coupons list removed; only apply coupon option remains
                }
            }
        }
        window.openDrawer = openDrawer;

        function closeDrawer() {
            DOMElements.drawerOverlay.classList.add('hidden');
            document.querySelectorAll('.drawer').forEach(d => d.classList.remove('active'));
            chatUnsubscribe(); // Ensure chat listener stops when drawer closes
        }
        window.closeDrawer = closeDrawer;

        // Custom Confirmation Modal
        function showConfirmModal(message, title, onConfirm) {
            DOMElements.confirmTitle.textContent = title;
            DOMElements.confirmMessage.textContent = message;
            DOMElements.confirmationModal.classList.remove('hidden');
            DOMElements.confirmationModal.classList.add('flex');

            confirmResolver = onConfirm;
        }

        function closeConfirmModal() {
            DOMElements.confirmationModal.classList.add('hidden');
            DOMElements.confirmationModal.classList.remove('flex');
            confirmResolver = null;
        }
        
        function handleConfirmClick() {
            if (confirmResolver) {
                confirmResolver();
            }
            closeConfirmModal();
        }

        function handleCancelClick() {
            closeConfirmModal();
        }

        function openPaymentModal() {
            if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return;
            }
            if (!currentUser || currentUser.isAnonymous) {
                showToast('Please log in to check out.', false);
                openDrawer('profile-drawer');
                return;
            }
            if (localCartCache.size === 0) {
                showToast('cart-is-empty', false);
                return;
            }
            // Address validation: require at least one saved address or fallback to legacy fields
            const addrs = Array.isArray(currentUserData?.addresses) ? currentUserData.addresses : [];
            if (addrs.length === 0) {
                if (!currentUserData?.location || !currentUserData?.mobile) {
                    showToast('Please add a shipping address in your profile.', false);
                    openDrawer('profile-drawer');
                    // Show addresses section to guide the user
                    try { openManageAddresses(); } catch (_) {}
                    return;
                }
            }
            closeDrawer();
            DOMElements.paymentModal.classList.remove('hidden');
            DOMElements.paymentModal.classList.add('flex');
            // Initialize selected shipping address view
            try {
                if (addrs.length > 0) {
                    if (!selectedShippingAddressId) {
                        const def = getDefaultAddress(addrs);
                        selectedShippingAddressId = def?.id || addrs[0]?.id || null;
                        selectedShippingAddress = addrs.find(a => a.id === selectedShippingAddressId) || null;
                    }
                } else {
                    selectedShippingAddressId = null;
                    selectedShippingAddress = null;
                }
                renderSelectedShippingAddress();
                renderAddressSelectList();
            } catch (_) {}
        }

        function closePaymentModal() {
            DOMElements.paymentModal.classList.add('hidden');
            DOMElements.paymentModal.classList.remove('flex');
        }
        window.closePaymentModal = closePaymentModal;
        
        // --- Variant Selection Modal Logic ---
        let currentVariantModal = null; // { productId, action: 'add'|'buy', selected: { size, storage, color } }

        function openVariantModal(productId, action = 'add') {
            try {
                const product = (productsData || []).find(p => p.id === productId);
                if (!product) return;
                currentVariantModal = { productId, action, selected: {} };

                // Fill product summary
                const img = document.getElementById('vm-product-image');
                const nameEl = document.getElementById('vm-product-name');
                const priceEl = document.getElementById('vm-product-price');
                if (img) img.src = product.imageUrl || product.image || '';
                if (nameEl) nameEl.textContent = product.name || '';
                if (priceEl) priceEl.textContent = `‡ß≥${Number(product.price || 0).toFixed(2)}`;

                // Render options
                renderVariantOptionsModal('size', product.sizes);
                renderVariantOptionsModal('storage', product.storage);
                renderVariantOptionsModal('color', product.colors);

                const modal = document.getElementById('variant-modal');
                if (modal) {
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                }
            } catch (err) { console.log('openVariantModal failed', err); }
        }
        window.openVariantModal = openVariantModal;

        function closeVariantModal() {
            const modal = document.getElementById('variant-modal');
            if (modal) {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }
            currentVariantModal = null;
        }
        window.closeVariantModal = closeVariantModal;

        function renderVariantOptionsModal(variantType, options) {
            const wrapper = document.getElementById(`vm-${variantType}-options`);
            const container = document.getElementById(`vm-${variantType}-variants-container`);
            if (!wrapper || !container) return;
            if (!options || options.length === 0) {
                wrapper.classList.add('hidden');
                container.innerHTML = '';
                return;
            }
            wrapper.classList.remove('hidden');
            container.innerHTML = options.map(option => {
                if (variantType === 'color') {
                    return `<button class="w-8 h-8 rounded-full border-2 border-gray-300" style="background-color: ${String(option).toLowerCase()}" data-vm-variant-type="color" data-value="${option}"></button>`;
                }
                return `<button class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors text-dark" data-vm-variant-type="${variantType}" data-value="${option}">${option}</button>`;
            }).join('');
        }

        function highlightMissingVariantUIForModal(missingTypes = []) {
            try {
                missingTypes.forEach(type => {
                    const labelEl = document.querySelector(`#vm-${type}-options label`);
                    const wrapper = document.getElementById(`vm-${type}-options`);
                    if (wrapper) wrapper.classList.remove('hidden');
                    if (labelEl) labelEl.classList.add('text-red-600', 'animate-pulse');
                });
            } catch (err) { console.log('Variant modal highlight failed:', err); }
        }

        // Delegate clicks inside the modal to handle variant selection
        document.getElementById('variant-modal-options').addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-vm-variant-type]');
            if (!btn || !currentVariantModal) return;
            const { vmVariantType } = { vmVariantType: btn.dataset.vmVariantType };
            const value = btn.dataset.value;
            const container = btn.parentElement;
            container.querySelectorAll('button').forEach(b => b.classList.remove(vmVariantType === 'color' ? 'color-variant-active' : 'variant-btn-active'));
            btn.classList.add(vmVariantType === 'color' ? 'color-variant-active' : 'variant-btn-active');
            currentVariantModal.selected[vmVariantType] = value;
            const labelEl = document.querySelector(`#vm-${vmVariantType}-options label`);
            if (labelEl) labelEl.classList.remove('text-red-600', 'animate-pulse');
        });

        // Confirm buttons inside modal
        document.getElementById('vm-add-btn').addEventListener('click', async () => {
            if (!currentVariantModal) return;
            const product = (productsData || []).find(p => p.id === currentVariantModal.productId);
            const required = product ? getRequiredVariants(product) : [];
            const missing = required.filter(t => !currentVariantModal.selected[t]);
            if (missing.length > 0) {
                showToast('toast-select-variant', false);
                highlightMissingVariantUIForModal(missing);
                return;
            }
            // Copy to global selection and add
            selectedVariants = { ...currentVariantModal.selected };
            try { await addToCartInDb(currentVariantModal.productId, false); } catch (e) { console.log(e); }
            closeVariantModal();
        });
        document.getElementById('vm-buy-btn').addEventListener('click', async () => {
            if (!currentVariantModal) return;
            const product = (productsData || []).find(p => p.id === currentVariantModal.productId);
            const required = product ? getRequiredVariants(product) : [];
            const missing = required.filter(t => !currentVariantModal.selected[t]);
            if (missing.length > 0) {
                showToast('toast-select-variant', false);
                highlightMissingVariantUIForModal(missing);
                return;
            }
            selectedVariants = { ...currentVariantModal.selected };
            try {
                await addToCartInDb(currentVariantModal.productId, false);
                closeVariantModal();
                openPaymentModal();
            } catch (e) { console.log(e); }
        });
        // --- END Variant Selection Modal Logic ---

        function generateRandomOrderId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        async function handlePlaceOrder() {
             if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return;
            }
            if (!currentUser || currentUser.isAnonymous) {
                showToast('Please log in to place an order.', false);
                openDrawer('profile-drawer');
                return;
            }
            if (localCartCache.size === 0) {
                showToast('cart-is-empty', false);
                return;
            }

            // Ensure we have a shipping address: prefer selected saved address, else fallback to legacy fields
            let shippingAddress = null;
            const addrs = Array.isArray(currentUserData?.addresses) ? currentUserData.addresses : [];
            if (addrs.length > 0) {
                if (!selectedShippingAddress) {
                    const def = getDefaultAddress(addrs);
                    selectedShippingAddress = def || addrs[0] || null;
                }
                shippingAddress = selectedShippingAddress;
            } else if (currentUserData?.location && currentUserData?.mobile) {
                shippingAddress = {
                    id: 'legacy',
                    name: currentUser.displayName || 'Customer',
                    mobile: currentUserData.mobile,
                    line1: currentUserData.location,
                    city: '',
                    area: '',
                    isDefault: true,
                };
            } else {
                showToast('Please add a shipping address in your profile.', false);
                closePaymentModal();
                openDrawer('profile-drawer');
                try { openManageAddresses(); } catch (_) {}
                return;
            }
            
            const mainPayment = document.querySelector('input[name="main-payment"]:checked').value;
            let finalPaymentMethod = mainPayment;
            
            if (mainPayment === 'Mobile Banking') {
                const subPayment = document.querySelector('input[name="sub-payment"]:checked');
                if (!subPayment) {
                    showToast('Please select a mobile banking option.', false);
                    return;
                }
                finalPaymentMethod = subPayment.value;
            }
            
            const subtotal = Array.from(localCartCache.values()).reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const deliveryCharge = await getDeliveryCharge(subtotal);
            const totalAmount = subtotal + deliveryCharge - discountAmount;
            
            const orderData = {
                orderId: generateRandomOrderId(),
                userId: currentUser.uid,
                userName: currentUser.displayName,
                userEmail: currentUser.email,
                // Keep legacy fields for backward compatibility but prefer shippingAddress for fulfillment
                userLocation: shippingAddress?.line1 || currentUserData.location || '',
                userMobile: shippingAddress?.mobile || currentUserData.mobile || '',
                shippingAddress: shippingAddress ? {
                    id: shippingAddress.id,
                    name: shippingAddress.name || currentUser.displayName || '',
                    mobile: shippingAddress.mobile || '',
                    line1: shippingAddress.line1 || '',
                    line2: shippingAddress.line2 || '',
                    city: shippingAddress.city || '',
                    area: shippingAddress.area || '',
                    isDefault: !!shippingAddress.isDefault,
                } : null,
                items: Array.from(localCartCache.values()),
                subtotal: subtotal,
                deliveryCharge: deliveryCharge,
                discount: discountAmount,
                couponCode: appliedCouponCode || null,
                totalAmount: totalAmount,
                paymentMethod: finalPaymentMethod,
                status: "Pending",
                createdAt: serverTimestamp()
            };

            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                await addDoc(collection(db, "orders"), orderData);

                const updates = { cart: {} };
                if (appliedCouponCode) {
                    updates.usedCoupons = arrayUnion(appliedCouponCode);
                }
                await updateDoc(userDocRef, updates);
                
                discountAmount = 0;
                appliedCouponCode = null;

                closePaymentModal();
                closeDrawer();
                
                let instructionKey = '';
                 if (finalPaymentMethod === 'Bkash') {
                    instructionKey = 'payment-instruction-bkash';
                } else if (finalPaymentMethod === 'Nagad') {
                    instructionKey = 'payment-instruction-nagad';
                } else {
                     instructionKey = 'payment-instruction-cod';
                }
                const instructionText = translations[currentLanguage][instructionKey].replace('{amount}', totalAmount.toFixed(2));
                DOMElements.paymentInstruction.textContent = instructionText;
                DOMElements.orderSuccessModal.classList.remove('hidden');
                DOMElements.orderSuccessModal.classList.add('flex');

            } catch (error) {
                console.error("Error placing order: ", error);
                showToast('order-placed-fail', false);
            }
        }

        // Place order based on return from mock payment page
        async function placeOrderFromReturn(methodFromReturn, txnIdFromReturn) {
            try {
                if (isCurrentUserBlocked) {
                    showToast('account-blocked', false);
                    return false;
                }
                if (!currentUser || currentUser.isAnonymous) {
                    showToast('Please log in to place an order.', false);
                    openDrawer('profile-drawer');
                    return false;
                }
                if (localCartCache.size === 0) {
                    showToast('cart-is-empty', false);
                    return false;
                }

                // Ensure shipping address (reuse logic)
                let shippingAddress = null;
                const addrs = Array.isArray(currentUserData?.addresses) ? currentUserData.addresses : [];
                if (addrs.length > 0) {
                    if (!selectedShippingAddress) {
                        const def = getDefaultAddress(addrs);
                        selectedShippingAddress = def || addrs[0] || null;
                    }
                    shippingAddress = selectedShippingAddress;
                } else if (currentUserData?.location && currentUserData?.mobile) {
                    shippingAddress = {
                        id: 'legacy',
                        name: currentUser.displayName || 'Customer',
                        mobile: currentUserData.mobile,
                        line1: currentUserData.location,
                        city: '',
                        area: '',
                        isDefault: true,
                    };
                } else {
                    showToast('Please add a shipping address in your profile.', false);
                    closePaymentModal();
                    openDrawer('profile-drawer');
                    try { openManageAddresses(); } catch (_) {}
                    return false;
                }

                const subtotal = Array.from(localCartCache.values()).reduce((sum, item) => sum + (item.price * item.quantity), 0);
                const deliveryCharge = await getDeliveryCharge(subtotal);
                const totalAmount = subtotal + deliveryCharge - discountAmount;

                const orderData = {
                    orderId: generateRandomOrderId(),
                    userId: currentUser.uid,
                    userName: currentUser.displayName,
                    userEmail: currentUser.email,
                    userLocation: shippingAddress?.line1 || currentUserData.location || '',
                    userMobile: shippingAddress?.mobile || currentUserData.mobile || '',
                    shippingAddress: shippingAddress ? {
                        id: shippingAddress.id,
                        name: shippingAddress.name || currentUser.displayName || '',
                        mobile: shippingAddress.mobile || '',
                        line1: shippingAddress.line1 || '',
                        line2: shippingAddress.line2 || '',
                        city: shippingAddress.city || '',
                        area: shippingAddress.area || '',
                        isDefault: !!shippingAddress.isDefault,
                    } : null,
                    items: Array.from(localCartCache.values()),
                    subtotal,
                    deliveryCharge,
                    discount: discountAmount,
                    couponCode: appliedCouponCode || null,
                    totalAmount,
                    paymentMethod: methodFromReturn || 'Online Payment',
                    transactionId: txnIdFromReturn || null,
                    status: 'Pending',
                    createdAt: serverTimestamp()
                };

                const userDocRef = doc(db, 'users', currentUser.uid);
                await addDoc(collection(db, 'orders'), orderData);

                const updates = { cart: {} };
                if (appliedCouponCode) updates.usedCoupons = arrayUnion(appliedCouponCode);
                await updateDoc(userDocRef, updates);

                // Reset local state
                discountAmount = 0;
                appliedCouponCode = null;

                // Show success modal (reuse existing) and include txn id if available
                DOMElements.paymentInstruction.textContent = txnIdFromReturn ? `Transaction successful. Txn ID: ${txnIdFromReturn}` : '';
                DOMElements.orderSuccessModal.classList.remove('hidden');
                DOMElements.orderSuccessModal.classList.add('flex');

                return true;
            } catch (err) {
                console.error('placeOrderFromReturn failed:', err);
                showToast('order-placed-fail', false);
                return false;
            }
        }
        
        // --- COUPON LOGIC ---
        async function fetchAndRenderCoupons() {
            const couponListEl = document.getElementById('coupons-list');
            const couponListElPage = document.getElementById('cart-page-coupons-list');
            if (!couponListEl && !couponListElPage) return;

            const loaderHtml = `<div class="col-span-full text-center py-4"><div class="loader mx-auto"></div></div>`;
            if (couponListEl) couponListEl.innerHTML = loaderHtml;
            if (couponListElPage) couponListElPage.innerHTML = loaderHtml;

            if (!currentUser || currentUser.isAnonymous) {
                const loginHtml = `<p class="text-center text-gray-500">Please log in to see available coupons.</p>`;
                if (couponListEl) couponListEl.innerHTML = loginHtml;
                if (couponListElPage) couponListElPage.innerHTML = loginHtml;
                return;
            }

            try {
                const couponsRef = collection(db, "coupons");
                // Fetch all coupons without filtering by 'isActive' since it might not be present, relying on client-side expiry check
                const querySnapshot = await getDocs(couponsRef); 
                allCoupons = querySnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(), 
                    code: doc.data().code || doc.id // Ensure code field exists
                }));

                const now = new Date();
                const usableCoupons = allCoupons.filter(coupon => {
                    const expiryDate = coupon.expiryDate ? new Date(coupon.expiryDate) : null;
                    const hasExpired = expiryDate && expiryDate < now;
                    // Check if coupon is active/not expired (assuming if isActive isn't present, it's considered active if not expired)
                    const isActive = coupon.isActive === undefined ? true : coupon.isActive; 
                    
                    return isActive && !hasExpired;
                });

                if (usableCoupons.length === 0) {
                    const emptyHtml = `<p class="text-center text-gray-500">No active coupons available right now.</p>`;
                    if (couponListEl) couponListEl.innerHTML = emptyHtml;
                    if (couponListElPage) couponListElPage.innerHTML = emptyHtml;
                    return;
                }

                let couponsHtml = usableCoupons.map(coupon => {
                    const code = coupon.code || '';
                    return `
                        <div class="p-2 sm:p-3 bg-gray-100 dark:bg-gray-700 rounded-lg border border-dashed border-theme-pink/50">
                            <div class="flex items-center justify-between gap-2">
                                <button onclick="copyToClipboard(this, '${code}')" class="text-sm sm:text-base font-bold bg-theme-blue text-white px-3 py-1 rounded-full hover:bg-theme-purple transition-colors">
                                    ${code}
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                if (couponListEl) couponListEl.innerHTML = couponsHtml;
                if (couponListElPage) couponListElPage.innerHTML = couponsHtml;

            } catch (error) {
                console.error("Error fetching coupons:", error);
                const errHtml = `<p class="text-center text-red-500">Error loading coupons.</p>`;
                if (couponListEl) couponListEl.innerHTML = errHtml;
                if (couponListElPage) couponListElPage.innerHTML = errHtml;
            }
        }

        function copyToClipboard(button, text) {
            if (!text || navigator.clipboard === undefined) {
                 // Fallback for older browsers
                 showToast("Could not copy. Browser unsupported.", false);
                 return;
            }
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = translations[currentLanguage]['copied'];
                showToast('Coupon copied!', true);
                setTimeout(() => {
                    button.textContent = originalText;
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                showToast("Copy failed.", false);
            });
        }
        window.copyToClipboard = copyToClipboard;
        
        async function handleApplyCoupon(e) {
            e.preventDefault();
            const drawerInput = DOMElements.couponInput;
            const pageInput = document.getElementById('cart-page-coupon-input');
            const raw = (pageInput && pageInput.value ? pageInput.value : (drawerInput ? drawerInput.value : '')) || '';
            const couponCode = raw.trim().toUpperCase();
            if (!couponCode) return;

            if (!currentUser || currentUser.isAnonymous) {
                showToast('Please log in to use coupons.', false);
                return;
            }

            // Query coupon by 'code' field to support arbitrary document IDs
            const couponQuery = query(collection(db, 'coupons'), where('code', '==', couponCode));
            const couponQuerySnap = await getDocs(couponQuery);

            if (couponQuerySnap.empty) {
                showToast('toast-coupon-invalid', false);
                return;
            }

            const couponData = couponQuerySnap.docs[0].data();
            const subtotal = Array.from(localCartCache.values()).reduce((sum, item) => sum + (item.price * item.quantity), 0);

            if (subtotal < (couponData.minSpend || 0)) {
                const message = translations[currentLanguage]['toast-coupon-min-purchase'].replace('{amount}', couponData.minSpend);
                showToast(message, false);
                return;
            }

            if (currentUserData.usedCoupons && currentUserData.usedCoupons.includes(couponCode)) {
                showToast('toast-coupon-used', false);
                return;
            }
            
            // Check expiry date (Client-side validation as Firebase doesn't support complex queries in rules)
            const expiryDate = couponData.expiryDate ? new Date(couponData.expiryDate) : null;
            const now = new Date();
            if (expiryDate && expiryDate < now) {
                showToast('toast-coupon-invalid', false); // Invalid/expired coupon message
                return;
            }
            
            // Check isActive (if present)
            if (couponData.isActive === false) {
                 showToast('toast-coupon-invalid', false); // Inactive coupon message
                 return;
            }

            if (couponData.type === 'percentage') {
                const percent = Number(couponData.value) || 0;
                discountAmount = Math.max(0, (subtotal * percent) / 100);
            } else if (couponData.type === 'fixed') {
                const fixed = Number(couponData.value ?? couponData.discountValue) || 0;
                discountAmount = Math.min(fixed, subtotal);
            } else {
                discountAmount = 0;
            }
            
            appliedCouponCode = couponCode;
            // Clear inputs for better UX
            if (drawerInput) drawerInput.value = '';
            if (pageInput) pageInput.value = '';
            showToast('toast-coupon-applied');
            await updateCartUI();
        }

        // --- GLOBAL FUNCTIONS for onclick ---
        window.renderAllProducts = () => {
            updateCategoryHeader(null, null); // Reset header to All Products
            renderProducts(productsData);
            showPage('home-page');
        };
        window.filterProducts = (category) => {
            const filtered = productsData.filter(p => p.category === category);
            updateCategoryHeader(category, null);
            renderProducts(filtered);
            showPage('home-page');
            scrollToElement('products');
        };
        window.filterSubCategory = (category, subCategory) => {
            const filtered = productsData.filter(p => p.category === category && p.subCategory === subCategory);
            updateCategoryHeader(category, subCategory);
            renderProducts(filtered);
            showPage('home-page');
            scrollToElement('products');
        };
        window.showOffers = () => {
            const offers = productsData.filter(p => p.isOffer);
            updateCategoryHeader('Offers', null); // Use 'Offers' as a temporary category name
            renderProducts(offers);
            showPage('home-page');
            scrollToElement('products');
        };
        
        function performSearch() {
            const qDesktop = DOMElements.searchInput ? DOMElements.searchInput.value : '';
            const qMobile = DOMElements.searchInputMobile ? DOMElements.searchInputMobile.value : '';
            const query = String(qDesktop || qMobile || '').trim().toLowerCase();
            if (!query) { hideSearchResults(); return; }
            const base = Array.isArray(productsData) ? productsData : [];
            const filtered = base.filter(p => {
                const name = (p?.name || '').toLowerCase();
                const brand = (p?.brand || '').toLowerCase();
                const cat = (p?.category || '').toLowerCase();
                const sub = (p?.subCategory || '').toLowerCase();
                return name.includes(query) || brand.includes(query) || cat.includes(query) || sub.includes(query);
            });
            hideSearchResults();
            renderProducts(filtered);
            showPage('home-page');
            scrollToElement('products');
        }

        function handleImageZoom(e) {
            const container = e.currentTarget;
            const rect = container.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const xPercent = (x / container.offsetWidth) * 100;
            const yPercent = (y / container.offsetHeight) * 100;
            container.style.setProperty('--x-pos', `${xPercent}%`);
            container.style.setProperty('--y-pos', `${yPercent}%`);
        }
        
        async function fetchUserOrders() {
             if (!currentUser || currentUser.isAnonymous) {
                DOMElements.ordersList.innerHTML = `<p class="text-center text-gray-500">Please log in to see your orders.</p>`;
                return;
            }
            DOMElements.ordersList.innerHTML = `<div class="loader mx-auto"></div>`;
            try {
                const ordersRef = collection(db, "orders");
                const q = query(ordersRef, where("userId", "==", currentUser.uid));
                
                onSnapshot(q, (querySnapshot) => {
                    userOrders = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    userOrders.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)); // Sort by newest first
                    renderOrders();
                });
            } catch (error) {
                console.error("Error fetching orders:", error);
                DOMElements.ordersList.innerHTML = `<p class="text-center text-red-500">Could not load orders.</p>`;
            }
        }
        
        function renderOrders() {
            const container = DOMElements.ordersList;
            if(!container) return;

            if (userOrders.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-500">You haven't placed any orders yet.</p>`;
                return;
            }

            const statuses = ['Pending', 'Confirmed', 'Shipped', 'Out for delivery', 'Delivered'];
            // Helper to normalize status strings (handles case, hyphens, underscores, extra spaces)
            const normalizeStatus = (str) => (str || '')
                .toString()
                .trim()
                .toLowerCase()
                .replace(/[-_]/g, ' ')
                .replace(/\s+/g, ' ');
            const normalizedStatuses = statuses.map(s => normalizeStatus(s));
            
            const renderTrackerSteps = (order) => {
                const status = normalizeStatus(order?.status || 'N/A');
                if (status === 'cancelled') return '';
                
                const currentStatusIndex = normalizedStatuses.indexOf(status);
                
                let html = '';
                
                // Use a standard flex container to lay out nodes and connectors
                html += `<div class="tracker-step-container w-full pt-4 pb-4">`;

                // Render nodes and connectors
                // Helper: parse various timestamp shapes into a Date
                const parseToDate = (val) => {
                    try {
                        if (!val) return null;
                        if (typeof val?.toDate === 'function') return val.toDate();
                        if (typeof val === 'number') { const ms = val < 1e12 ? val * 1000 : val; return new Date(ms); }
                        if (typeof val === 'object' && typeof val.seconds === 'number') return new Date(val.seconds * 1000);
                        if (typeof val === 'string') { const d = new Date(val); return isNaN(d.getTime()) ? null : d; }
                    } catch {}
                    return null;
                };
                // Helper: resolve timestamp for a given step name from multiple fields
                const resolveStepDate = (o, stepName) => {
                    if (!o) return null;
                    const norm = normalizeStatus(stepName); // e.g., 'out for delivery'
                    const camel = norm.replace(/\s+(.)/g, (m, g1) => g1.toUpperCase()); // 'outForDelivery'
                    const pascal = camel.charAt(0).toUpperCase() + camel.slice(1);
                    const upper = stepName.toUpperCase();
                    // Common direct fields
                    const candidates = [
                        o?.statusTimestamps?.[norm], o?.statusTimestamps?.[stepName], o?.statusTimestamps?.[camel], o?.statusTimestamps?.[pascal],
                        o?.[`${camel}At`], o?.[`${pascal}At`], o?.[`${norm}At`], o?.[`${stepName}At`],
                        o?.[norm], o?.[camel], o?.[pascal], o?.[stepName], o?.[upper],
                    ];
                    // Special-case aliases
                    if (norm === 'pending') candidates.push(o?.createdAt);
                    if (norm === 'delivered') candidates.push(
                        o?.deliveredAt, o?.deliveredTime, o?.deliveredOn, o?.deliveredDate, o?.deliveryCompletedAt, o?.completedAt,
                        o?.delivered_at, o?.deliveredTimestamp, o?.deliveredDateTime
                    );
                    // Nested common containers
                    candidates.push(
                        o?.delivery?.[`${camel}At`], o?.delivery?.[camel], o?.delivery?.deliveredAt,
                        o?.timeline?.[`${camel}At`], o?.timeline?.[camel], o?.timeline?.deliveredAt
                    );
                    // History arrays
                    const findInHistory = (arr) => {
                        if (!Array.isArray(arr)) return null;
                        for (const e of arr) {
                            const st = normalizeStatus(e?.status || e?.state || e?.label);
                            if (st === norm) return e.timestamp || e.time || e.at || e.date || e.when;
                        }
                        return null;
                    };
                    candidates.push(findInHistory(o?.statusHistory));
                    candidates.push(findInHistory(o?.statusLogs));
                    candidates.push(findInHistory(o?.logs));

                    // Pick first truthy and parse
                    for (const c of candidates) {
                        const d = parseToDate(c);
                        if (d instanceof Date && !isNaN(d.getTime())) return d;
                    }
                    return null;
                };

                statuses.forEach((step, index) => {
                    const isStepComplete = currentStatusIndex >= index;
                    const connectorActive = currentStatusIndex > index; // Connector between this step and next is active only if we've progressed past this step
                    const isLastStep = index === statuses.length - 1;
                    
                    const circleClass = isStepComplete ? 'bg-green-500 border-green-500 text-white' : 'bg-white dark:bg-gray-700 border-gray-400 text-gray-500';
                    const labelColor = isStepComplete ? 'text-gray-700 dark:text-gray-100' : 'text-gray-500';
                    const stepDate = isStepComplete ? resolveStepDate(order, step) : null;
                    const stepDateHtml = stepDate ? `<p class="text-[10px] mt-1 ${isLastStep ? 'text-green-700' : 'text-gray-500'}">${stepDate.toLocaleDateString('en-GB')} at ${stepDate.toLocaleTimeString('en-US')}</p>` : '';
                    
                    // Render Node (Circle + Label)
                    html += `
                        <div class="tracker-node">
                            <div class="tracker-circle rounded-full border-2 flex items-center justify-center ${circleClass} shadow-md relative z-10">
                                <i class="fas fa-check text-xs"></i>
                            </div>
                            <p class="text-xs mt-2 ${labelColor}">${step}</p>
                            ${stepDateHtml}
                        </div>`;
                    
                    // Render Connector Line (Appears between nodes)
                    if (!isLastStep) {
                        const connectorClass = connectorActive ? 'active' : '';

                        // Connector line is rendered in the gap between two fixed-width tracker-node elements
                        html += `
                            <div class="tracker-connector ${connectorClass}">
                                <div class="tracker-connector-line"></div>
                            </div>`;
                    }
                });
                
                html += `</div>`; // Close tracker-step-container
                return html;
            }

            container.innerHTML = userOrders.map(order => {
                const rawStatus = order.status || 'N/A';
                const status = normalizeStatus(rawStatus);
                const orderDate = order.createdAt?.toDate().toLocaleDateString('en-GB');
                const orderTime = order.createdAt?.toDate().toLocaleTimeString('en-US');
                const isCancelled = status === 'cancelled';
                const canCancel = status === 'pending';
                const txnHtml = order.transactionId ? `<p class="text-xs text-gray-600 mt-1 break-all">Txn ID: ${order.transactionId}</p>` : '';

                // Derive expected/estimated delivery time from multiple possible fields
                const deliveryValue = order.expectedDelivery || order.deliveryTime || order.delivery_date || order.deliveryDate || order.eta;
                let expectedDeliveryHtml = '';
                if (deliveryValue) {
                    let dStr = '';
                    try {
                        if (typeof deliveryValue?.toDate === 'function') {
                            dStr = deliveryValue.toDate().toLocaleString();
                        } else if (typeof deliveryValue === 'number') {
                            const ms = deliveryValue < 1e12 ? deliveryValue * 1000 : deliveryValue;
                            dStr = new Date(ms).toLocaleString();
                        } else if (typeof deliveryValue === 'object' && typeof deliveryValue.seconds === 'number') {
                            dStr = new Date(deliveryValue.seconds * 1000).toLocaleString();
                        } else if (typeof deliveryValue === 'string') {
                            dStr = deliveryValue;
                        }
                    } catch {}
                    if (dStr) {
                        expectedDeliveryHtml = `<p class="text-xs text-gray-600 mt-1">Estimated Delivery: ${dStr}</p>`;
                    }
                }

                // Show actual delivered timestamp when status is delivered
                let deliveredTimeHtml = '';
                if (status === 'delivered') {
                    // Helper to parse various timestamp shapes into a Date
                    const parseToDate = (val) => {
                        try {
                            if (!val) return null;
                            if (typeof val?.toDate === 'function') return val.toDate(); // Firestore Timestamp
                            if (typeof val === 'number') {
                                const ms = val < 1e12 ? val * 1000 : val;
                                return new Date(ms);
                            }
                            if (typeof val === 'object' && typeof val.seconds === 'number') {
                                return new Date(val.seconds * 1000);
                            }
                            if (typeof val === 'string') {
                                const d = new Date(val);
                                return isNaN(d.getTime()) ? null : d;
                            }
                        } catch {}
                        return null;
                    };

                    // Resolve delivered timestamp from many possible shapes/fields
                    const resolveDeliveredTs = (o) => {
                        let v = (
                            o.deliveredAt || o.deliveredTime || o.deliveredOn || o.deliveredDate ||
                            o.deliveryCompletedAt || o.completedAt ||
                            (o.statusTimestamps && (o.statusTimestamps.delivered || o.statusTimestamps.Delivered || o.statusTimestamps.deliveredAt || o.statusTimestamps.DeliveredAt)) ||
                            o.delivery_date_delivered || o.deliveryAt || o.delivery_time ||
                            o.delivered_at || o.deliveredTimestamp || o.deliveredDateTime
                        );
                        if (!v && o.delivery) {
                            v = o.delivery.deliveredAt || o.delivery.deliveredTime || o.delivery.delivered_on || o.delivery.delivered;
                        }
                        if (!v && o.timeline) {
                            v = o.timeline.deliveredAt || o.timeline.delivered || o.timeline.delivered_on;
                        }
                        const findInHistory = (arr) => {
                            if (!Array.isArray(arr)) return null;
                            for (const e of arr) {
                                const st = (e?.status || e?.state || e?.label || '').toString().trim().toLowerCase().replace(/[-_]/g, ' ').replace(/\s+/g, ' ');
                                if (st === 'delivered') {
                                    return e.timestamp || e.time || e.at || e.date || e.when;
                                }
                            }
                            return null;
                        };
                        if (!v) v = findInHistory(o.statusHistory);
                        if (!v) v = findInHistory(o.statusLogs);
                        if (!v) v = findInHistory(o.logs);
                        if (!v && o.updatedAt) v = o.updatedAt; // last resort fallback when marked delivered
                        const dObj = parseToDate(v);
                        return dObj ? dObj : (typeof v === 'string' ? v : null);
                    };

                    const resolved = resolveDeliveredTs(order);
                    if (resolved instanceof Date) {
                        const dDate = resolved.toLocaleDateString('en-GB');
                        const dTime = resolved.toLocaleTimeString('en-US');
                        deliveredTimeHtml = `<p class=\"text-xs text-green-700 mt-1 text-right self-end\">Delivered on: ${dDate} at ${dTime}</p>`;
                    } else if (typeof resolved === 'string' && resolved) {
                        deliveredTimeHtml = `<p class=\"text-xs text-green-700 mt-1 text-right self-end\">Delivered on: ${resolved}</p>`;
                    }
                }

                // Use theme colors for status badges
                let statusBgClass = 'bg-gray-500';
                if (status === 'delivered') { statusBgClass = 'bg-green-500'; }
                else if (status === 'cancelled') { statusBgClass = 'bg-red-500'; }
                else if (status === 'shipped' || status === 'out for delivery') { statusBgClass = 'bg-theme-blue'; }
                else if (status === 'confirmed' || status === 'pending') { statusBgClass = 'bg-yellow-500'; }
                
                const statusTextColor = 'text-white';
                
                // Helper to resolve a productId from various possible item shapes
                const resolveProductId = (it) => {
                    try {
                        const candidates = [
                            it.productId, it.productID, it.product_id, it.id, it.pid, it._id, it.docId, it.productDocId
                        ].filter(Boolean);
                        if (Array.isArray(productsData) && productsData.length) {
                            for (const cand of candidates) {
                                if (productsData.some(p => p.id === cand)) return cand;
                            }
                            // Match by SKU if present
                            if (it.sku) {
                                const pSku = productsData.find(p => (p.sku || p.SKU) && ((p.sku || p.SKU) === it.sku));
                                if (pSku) return pSku.id;
                            }
                            // Match by modelID if present
                            if (it.modelID) {
                                const modelNorm = String(it.modelID).trim().toLowerCase();
                                const pModel = productsData.find(p => String(p.modelID || '').trim().toLowerCase() === modelNorm);
                                if (pModel) return pModel.id;
                            }
                            // Last resort: match by exact name
                            if (it.name) {
                                const nameNorm = String(it.name).trim().toLowerCase();
                                const matches = productsData.filter(p => String(p.name || '').trim().toLowerCase() === nameNorm);
                                if (matches.length === 1) return matches[0].id;
                            }
                        }
                    } catch {}
                    return it?.productId || null;
                };

                const itemRows = (order.items || []).map(item => {
                    // Variants text
                    let variants = '';
                    if (item.size || item.color || item.storage) {
                        const parts = [];
                        if (item.size) parts.push(`Size: ${item.size}`);
                        if (item.color) parts.push(`Color: ${item.color}`);
                        if (item.storage) parts.push(`Storage: ${item.storage}`);
                        variants = ` [${parts.join(', ')}]`;
                    }

                    const title = `${item.name || 'Product'}${variants} (x${item.quantity || 1})`;
                    const imgSrc = item.image || 'https://placehold.co/80x80/ccc/000?text=Image';
                    const resolvedProductId = resolveProductId(item);
                    const fallbackSkuEnc = encodeURIComponent(item.sku || '');
                    const fallbackModelEnc = encodeURIComponent(item.modelID || item.modelId || '');
                    const fallbackNameEnc = encodeURIComponent(item.name || '');
                    const priceText = `‡ß≥${((item.price || 0) * (item.quantity || 0)).toFixed(2)}`;

                    const titleHtml = `<button class="order-item-open text-left text-base text-gray-800 dark:text-gray-200 hover:underline" data-product-id="${resolvedProductId || ''}" data-sku="${item.sku || ''}" data-model="${item.modelID || item.modelId || ''}" data-name="${item.name || ''}">${title}</button>`;

                    const imageHtml = `<img src="${imgSrc}" alt="${item.name || 'Product'}" class="order-item-open w-14 h-14 rounded-lg object-cover cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/80x80/ccc/000?text=Image';" data-product-id="${resolvedProductId || ''}" data-sku="${item.sku || ''}" data-model="${item.modelID || item.modelId || ''}" data-name="${item.name || ''}">`;

                    return `
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2 py-3">
                            <div class="flex items-center gap-3 min-w-0">
                                ${imageHtml}
                                <div class="flex flex-col min-w-0">
                                    <div class="break-words">${titleHtml}</div>
                                </div>
                            </div>
                            <p class="font-semibold text-sm sm:text-base text-price-black dark:text-gray-100">${priceText}</p>
                        </div>
                    `;
                }).join('');
                
                const invoiceButton = status === 'delivered' 
                    ? `<button class="download-invoice-btn bg-green-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-green-600 transition-colors" data-order-id="${order.id}">Download Invoice</button>`
                    : '';

                // Final Card structure based on user image
                return `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-100">
                        <!-- Top Header Row -->
                        <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-3">
                            <div>
                                <p class="font-bold text-lg text-theme-purple">Order ID: <span class="text-purple-600">${order.orderId}</span></p>
                                <p class="text-xs text-gray-500 mt-1">Placed on: ${orderDate} at ${orderTime}</p>
                                ${txnHtml}
                                ${status === 'delivered' ? '' : expectedDeliveryHtml}
                            </div>
                            <div class="flex flex-col items-end w-full md:w-auto">
                                 <p class="font-bold text-xl text-theme-blue mb-1 text-right self-end">‡ß≥${order.totalAmount.toFixed(2)}</p>
                                 <span class="text-xs font-semibold px-3 py-1 rounded-full ${statusBgClass} ${statusTextColor} uppercase self-end">
                                    ${rawStatus}
                                 </span>
                                 ${deliveredTimeHtml}
                            </div>
                        </div>

                        ${isCancelled ? 
                            `<div class="text-center text-red-500 font-bold p-4 bg-red-100 rounded-lg mt-4">Order Cancelled</div>`
                            : renderTrackerSteps(order)
                        }

                        <!-- Items List -->
                        <div class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                            <h4 class="font-bold text-base mb-2">Items:</h4>
                            <div class="space-y-1">
                                ${itemRows}
                            </div>
                        </div>

                        <!-- Footer: Actions -->
                        <div class="mt-4 flex flex-col sm:flex-row gap-3 sm:justify-between sm:items-center">
                            <div></div>
                            <div class="flex gap-3 justify-end">
                                ${canCancel ? `<button class="cancel-order-btn bg-red-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-600 transition-colors" data-order-id="${order.id}">Cancel Order</button>` : ''}
                                ${invoiceButton}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Wire up cancel buttons
            container.querySelectorAll('.cancel-order-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const orderId = e.currentTarget.getAttribute('data-order-id');
                    showConfirmModal('Are you sure you want to cancel this order?', 'Cancel Order', async () => {
                        try {
                            const orderRef = doc(db, 'orders', orderId);
                            const snap = await getDoc(orderRef);
                            if (!snap.exists()) {
                                showToast('Order not found', false);
                                return;
                            }
                            const normalize = (s) => (s || '').toString().trim().toLowerCase().replace(/[-_]/g, ' ').replace(/\s+/g, ' ');
                            const currentStatus = normalize(snap.data().status);
                            if (currentStatus !== 'pending') {
                                showToast('Order can no longer be cancelled', false);
                                return;
                            }
                            await updateDoc(orderRef, { status: 'Cancelled' });
                            showToast('Order cancelled successfully');
                        } catch (err) {
                            console.error('Cancel order failed:', err);
                            showToast('Failed to cancel order', false);
                        }
                    });
                });
            });

            // Delegated handler for opening product from order list
            container.addEventListener('click', async (e) => {
                const trigger = e.target.closest('.order-item-open');
                if (!trigger) return;
                const pid = trigger.getAttribute('data-product-id') || '';
                const sku = trigger.getAttribute('data-sku') || '';
                const model = trigger.getAttribute('data-model') || '';
                const name = trigger.getAttribute('data-name') || '';
                await showProductDetails(pid, encodeURIComponent(sku), encodeURIComponent(model), encodeURIComponent(name));
            });
        }

        // --- Emergency Chat Logic ---

        function handleEmergencyChatClick() {
            if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return;
            }
            if (!currentUser || currentUser.isAnonymous) {
                showToast(translations[currentLanguage]['chat-unauthorized'], false);
                openDrawer('profile-drawer');
                return;
            }
            closeDrawer();
            showPage('emergency-chat-page');
            // Starts listening to chat once on the page
        }
        
        async function handleEmergencyChat() {
            if (!currentUser || currentUser.isAnonymous) return;

            const chatId = currentUser.uid;
            const chatDocRef = doc(db, 'live_chats', chatId);
            const messagesCollectionRef = collection(chatDocRef, 'messages');

            // Atomically ensure chat doc exists, update lastActive, and send a single welcome message once.
            await runTransaction(db, async (tx) => {
                const snap = await tx.get(chatDocRef);
                const nowFields = { lastActive: serverTimestamp() };
                const baseDoc = {
                    userId: currentUser.uid,
                    userName: currentUser.displayName || currentUser.email || 'User',
                    createdAt: serverTimestamp(),
                    lastActive: serverTimestamp(),
                };

                if (!snap.exists()) {
                    // First-time chat: create doc and send the welcome message with the flag in the same transaction
                    tx.set(chatDocRef, { ...baseDoc, welcomeMessageSent: true });
                    const welcomeRef = doc(messagesCollectionRef);
                    tx.set(welcomeRef, {
                        text: "‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®! ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶¨‡ßá‡¶®‡•§",
                        senderId: "admin",
                        senderName: "Admin",
                        timestamp: serverTimestamp()
                    });
                } else {
                    // Existing chat: bump lastActive and send welcome only if not already sent
                    const data = snap.data() || {};
                    const alreadySent = data.welcomeMessageSent === true;
                    if (!alreadySent) {
                        tx.update(chatDocRef, { ...nowFields, welcomeMessageSent: true });
                        const welcomeRef = doc(messagesCollectionRef);
                        tx.set(welcomeRef, {
                            text: "‡¶Ö‡¶≠‡¶ø‡¶®‡¶®‡ßç‡¶¶‡¶®! ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶∂‡ßÄ‡¶ò‡ßç‡¶∞‡¶á ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶¨‡ßá‡¶®‡•§",
                            senderId: "admin",
                            senderName: "Admin",
                            timestamp: serverTimestamp()
                        });
                    } else {
                        tx.update(chatDocRef, nowFields);
                    }
                }
            });

            DOMElements.chatMessages.innerHTML = `<p class="text-center text-gray-500">Loading messages...</p>`;

            // Set up real-time listener for messages
            const q = query(messagesCollectionRef, orderBy('timestamp', 'asc'));

            chatUnsubscribe = onSnapshot(q, (snapshot) => {
                let messagesHtml = '';
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({ id: doc.id, ...doc.data() });
                });

                // If the latest message is from the admin, mark previous user messages as seen
                const latestMessage = messages.length > 0 ? messages[messages.length - 1] : null;
                if (latestMessage && latestMessage.senderId === 'admin') {
                    const unseenUserMessages = messages.filter(msg => msg.senderId === currentUser.uid && !msg.isSeen);
                    if (unseenUserMessages.length > 0) {
                        const batch = writeBatch(db);
                        const messagesCollectionRef = collection(db, 'live_chats', currentUser.uid, 'messages');
                        unseenUserMessages.forEach(msg => {
                            const msgRef = doc(messagesCollectionRef, msg.id);
                            batch.update(msgRef, { isSeen: true });
                        });
                        batch.commit().catch(e => console.error("Failed to batch update seen status:", e));
                    }
                }

                messages.forEach(msg => {
                    const isUser = msg.senderId === currentUser.uid;
                    const senderName = isUser ? 'You' : (msg.senderName || 'Admin');
                    const time = msg.timestamp?.toDate().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) || '';
                    
                    let seenStatusHtml = '';
                    if (isUser && msg.isSeen) {
                        seenStatusHtml = `<span class="text-xs ml-2 text-blue-200">‚úì Seen</span>`;
                    }

                    messagesHtml += `
                        <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                            <div class="max-w-xs md:max-w-md p-3 rounded-xl shadow-md ${isUser ? 'bg-theme-blue text-white rounded-br-none' : 'bg-white dark:bg-gray-700 text-dark rounded-tl-none border'}">
                                <p class="text-xs font-semibold ${isUser ? 'text-blue-200' : 'text-theme-purple'} mb-1">${senderName}</p>
                                <p class="text-sm">${msg.text}</p>
                                <div class="text-right text-xs mt-1 ${isUser ? 'text-blue-300' : 'text-gray-500'}">
                                    <span>${time}</span>
                                    ${seenStatusHtml}
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                DOMElements.chatMessages.innerHTML = messagesHtml;
                // Scroll to bottom
                DOMElements.chatMessages.scrollTop = DOMElements.chatMessages.scrollHeight;
            }, (error) => {
                console.error("Error listening to messages:", error);
                DOMElements.chatMessages.innerHTML = `<p class="text-center text-red-500">Error loading chat history.</p>`;
            });
        }
        
        const forbiddenWords = [
            // Bengali slang/abusive words
            'sala', 'hala', 'bainchod', 'banchod', 'magi', 'khanki', 'chudir vai', 'kutta', 
            'haramjada', 'shoytaner baccha', 'chagol', 'gadha', 'bokachoda', 'boka',
            'bal', 'khankir pola', 'maderchod', 'chodnar po', 'halar po', 'doner bal',

            // English slang/abusive words
            'fuck', 'fucker', 'fucking', 'bitch', 'asshole', 'dick', 'pussy', 'cunt', 'shit', 'motherfucker',
            'bastard', 'damn', 'hell', 'son of a bitch', 'idiot', 'stupid', 'slang'
        ];

        async function sendChatMessage(e) {
            e.preventDefault();
            if (isCurrentUserBlocked) {
                showToast('account-blocked', false);
                return;
            }
            if (!currentUser || currentUser.isAnonymous) return;

            const text = DOMElements.chatInput.value.trim();
            if (!text) return;

            DOMElements.chatError.textContent = '';
            
            // --- Slang word filter ---
            const lowerCaseText = text.toLowerCase();
            const containsForbiddenWord = forbiddenWords.some(word => lowerCaseText.includes(word));

            if (containsForbiddenWord) {
                showToast('toast-abusive-language', false);
                return; // Stop the function here
            }
            // --- End of slang word filter ---
            
            const chatId = currentUser.uid;
            const messagesCollectionRef = collection(db, 'live_chats', chatId, 'messages');

            try {
                await addDoc(messagesCollectionRef, {
                    text: text,
                    senderId: currentUser.uid,
                    senderName: currentUser.displayName || currentUser.email || 'User',
                    timestamp: serverTimestamp(),
                    isSeen: false // Mark new messages as not seen initially
                });
                
                // Update parent chat doc with latest message metadata
                await updateDoc(doc(db, 'live_chats', chatId), {
                    lastActive: serverTimestamp(),
                    lastMessage: text,
                    lastMessageTimestamp: serverTimestamp(),
                    lastSender: "user",
                    isReadByAdmin: false, // notify admin
                    userName: currentUser.displayName || currentUser.email || 'User'
                });

                DOMElements.chatInput.value = ''; // Clear input
                
            } catch (error) {
                console.error("Error sending message:", error);
                DOMElements.chatError.textContent = "Failed to send message.";
            }
        }

        // --- Invoice Generation Logic (jsPDF) ---
        
        async function downloadInvoice(orderDocId) {
            const order = userOrders.find(o => o.id === orderDocId);
            if (!order) {
                showToast("Error: Order data not found for invoice.", false);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            let marginX = 20;
            let y = 15;
            
            doc.setFont("helvetica", "normal"); 
            
            doc.setFontSize(24);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(74, 123, 237); // theme-blue
            doc.text("TangailBuzz", marginX, y);
            y += 8;

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(100);
            doc.text("Your trusted online shop for quality products. | +8801863205976", marginX, y); 
            y += 10;
            
            doc.setFontSize(20);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(51);
            doc.text("SALES INVOICE", pageWidth - marginX, y, { align: "right" });
            y += 8;

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(51);
            doc.text(`Order ID: ${order.orderId}`, pageWidth - marginX, y, { align: "right" });
            y += 6;

            const date = order.createdAt?.toDate().toLocaleDateString('en-GB') || 'N/A';
            doc.text(`Date: ${date}`, pageWidth - marginX, y, { align: "right" });
            y += 10;

            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(106, 13, 173); // theme-purple
            doc.text("Bill To:", marginX, y);
            y += 7;

            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(51);
            doc.text(`Name: ${order.userName || 'N/A'}`, marginX, y);
            y += 5;
            doc.text(`Mobile: ${order.userMobile || 'N/A'}`, marginX, y);
            y += 5;
            
            const addressText = `Address: ${order.userLocation || 'N/A'}`;
            const addressLines = doc.splitTextToSize(addressText, pageWidth - (2 * marginX)); 
            doc.text(addressLines, marginX, y);
            y += (addressLines.length * 5) + 5; 
            
            y += 5;

            const tableColumn = ["Product Name", "Variant", "Price", "Qty", "Total"];
            const tableRows = [];

            const items = order.items || [];
            items.forEach(item => {
                let variantString = '';
                if (item.size) variantString += `Size: ${item.size} `;
                if (item.color) variantString += `Color: ${item.color} `;
                if (item.storage) variantString += `Storage: ${item.storage} `;
                
                tableRows.push([
                    item.name,
                    variantString.trim(),
                    `BDT ${Number(item.price).toFixed(2)}`,
                    item.quantity,
                    `BDT ${Number(item.price * item.quantity).toFixed(2)}`
                ]);
            });

            doc.autoTable({ 
                head: [tableColumn],
                body: tableRows,
                startY: y,
                margin: { left: marginX, right: marginX },
                theme: 'striped',
                headStyles: { fillColor: [74, 123, 237], textColor: 255, font: "helvetica", fontStyle: "bold" },
                columnStyles: {
                    0: { cellWidth: 65, font: "helvetica", fontStyle: "normal" },
                    1: { cellWidth: 35, font: "helvetica", fontStyle: "normal" },
                    2: { halign: 'right', cellWidth: 25, font: "helvetica", fontStyle: "normal" },
                    3: { halign: 'center', cellWidth: 15, font: "helvetica", fontStyle: "normal" },
                    4: { halign: 'right', fontStyle: 'bold', cellWidth: 30, font: "helvetica", fontStyle: "bold" },
                },
                styles: { fontSize: 9, cellPadding: 2, font: "helvetica" },
                didDrawPage: function(data) {
                    y = data.cursor.y;
                }
            });

            y = doc.autoTable.previous.finalY + 10;

            doc.setFontSize(11);
            doc.setFont("helvetica", "normal");
            
            const totalSummaryX = pageWidth - marginX - 50; 

            doc.text("Subtotal:", totalSummaryX, y, { align: "right" });
            doc.text(`BDT ${order.subtotal.toFixed(2)}`, pageWidth - marginX, y, { align: "right" });
            y += 7;
            
            doc.text("Delivery Charge:", totalSummaryX, y, { align: "right" });
            doc.text(`BDT ${order.deliveryCharge.toFixed(2)}`, pageWidth - marginX, y, { align: "right" });
            y += 7;

            doc.setDrawColor(0, 0, 0);
            doc.setLineWidth(0.5);
            doc.line(totalSummaryX, y - 2, pageWidth - marginX, y - 2);
            
            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(229, 54, 122); // theme-pink
            doc.text("TOTAL AMOUNT:", totalSummaryX, y + 4, { align: "right" });
            doc.text(`BDT ${order.totalAmount.toFixed(2)}`, pageWidth - marginX, y + 4, { align: "right" });
            y += 15;

            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.setTextColor(100);
            doc.text(`Payment Method: ${order.paymentMethod}`, marginX, y);
            y += 5;
            if (order.transactionId) {
                doc.text(`Transaction ID: ${order.transactionId}`, marginX, y);
                y += 5;
            }
            doc.text("Thank you for shopping with TangailBuzz!", pageWidth - marginX, y, { align: "right" });

            doc.save(`Invoice_${order.orderId}.pdf`);
            showToast("Invoice downloaded successfully!");
        }

        // --- INITIALIZATION & EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Initial Firebase Authentication Bootstrap
            await initialAuthBootstrap();
            
            // 1.5 Apply Theme Preference
            const storedTheme = localStorage.getItem('theme');
            applyDarkMode(storedTheme || 'light');
            
            // 2. Load Product/Banner Data
            // Initialize language from storage
            const storedLang = (() => { try { return localStorage.getItem('lang'); } catch (e) { return null; } })();
            setLanguage(storedLang || 'bn');
            DOMElements.productList.innerHTML = `<div class="loader"></div>`;
            await fetchProductsFromFirestore();
            await fetchBannersFromFirestore();
            await fetchRightPromoFromFirestore();
            // Recompute cart totals and mirror UI now that product data is available
            try { await updateCartUI(); } catch (_) {}
            
            // 3. Attach Event Listeners
            DOMElements.loginBtn.addEventListener('click', handleGoogleLogin);
            if (DOMElements.loginFacebookBtn) DOMElements.loginFacebookBtn.addEventListener('click', handleFacebookLogin);
            DOMElements.logoutBtn.addEventListener('click', handleLogout); 
            DOMElements.loginForm.addEventListener('submit', handleLogin);
            DOMElements.registerForm.addEventListener('submit', handleRegister);
            if (DOMElements.resetForm) DOMElements.resetForm.addEventListener('submit', handlePasswordReset);
            DOMElements.checkoutBtn.addEventListener('click', openPaymentModal);
            DOMElements.confirmOrderBtn.addEventListener('click', handlePlaceOrder);
            DOMElements.couponForm.addEventListener('submit', handleApplyCoupon);
            
            // Dark Mode Toggle Listener
            if (DOMElements.darkModeToggle) {
                DOMElements.darkModeToggle.addEventListener('click', toggleDarkMode);
            }
            
            // Confirmation Modal Listeners
            DOMElements.confirmOkBtn.addEventListener('click', handleConfirmClick);
            DOMElements.confirmCancelBtn.addEventListener('click', handleCancelClick);
            
            // Emergency Contact Button
            if(DOMElements.emergencyContactBtn) DOMElements.emergencyContactBtn.addEventListener('click', handleEmergencyChatClick);
            if(DOMElements.chatForm) DOMElements.chatForm.addEventListener('submit', sendChatMessage);
            const headerEmergencyBtn = document.getElementById('emergency-contact-header');
            // Header Support button should open the Support page (with Chat, Email, Phone options)
            if (headerEmergencyBtn) headerEmergencyBtn.addEventListener('click', () => {
                showPage('support-page');
            });

            if(document.getElementById('my-orders-btn')) document.getElementById('my-orders-btn').addEventListener('click', () => { showPage('my-orders-page'); closeDrawer(); });
            if(DOMElements.myOrdersBtnProfile) DOMElements.myOrdersBtnProfile.addEventListener('click', () => { showPage('my-orders-page'); closeDrawer(); });
            if(DOMElements.deleteAccountBtn) DOMElements.deleteAccountBtn.addEventListener('click', handleDeleteAccount);
            if(DOMElements.closeSuccessModalBtn) DOMElements.closeSuccessModalBtn.addEventListener('click', () => {
                 DOMElements.orderSuccessModal.classList.add('hidden');
                 DOMElements.orderSuccessModal.classList.remove('flex');
                 showPage('my-orders-page');
            });
             if(DOMElements.editProfileForm) DOMElements.editProfileForm.addEventListener('submit', handleProfileUpdate);


            DOMElements.editProfileBtn.addEventListener('click', () => {
                DOMElements.userProfileView.classList.add('hidden');
                DOMElements.editProfileForm.classList.remove('hidden');
                DOMElements.editPhotoPreview.src = currentUser.photoURL || 'https://placehold.co/96x96/6a0dad/white?text=User';
                DOMElements.editNameInput.value = currentUser.displayName || '';
                DOMElements.editMobileInput.value = currentUserData?.mobile || '';
                DOMElements.editLocationInput.value = currentUserData?.location || '';
                // Clear any previous remove flag
                delete DOMElements.editPhotoInput.dataset.remove;
            });

            DOMElements.cancelEditBtn.addEventListener('click', () => {
                DOMElements.editProfileForm.classList.add('hidden');
                DOMElements.userProfileView.classList.remove('hidden');
            });

            // Remove Photo handler
            const removeBtn = document.getElementById('remove-photo-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', () => {
                    DOMElements.editPhotoInput.value = '';
                    DOMElements.editPhotoInput.dataset.remove = 'true';
                    DOMElements.editPhotoPreview.src = 'https://placehold.co/96x96/6a0dad/white?text=User';
                });
            }

            DOMElements.showRegisterLink.addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthForms('register');
            });

            // Cart page: coupon + checkout wiring
            const cartPageCouponForm = document.getElementById('cart-page-coupon-form');
            if (cartPageCouponForm) cartPageCouponForm.addEventListener('submit', handleApplyCoupon);
            const cartPageCheckoutBtn = document.getElementById('cart-page-checkout-btn');
            if (cartPageCheckoutBtn) cartPageCheckoutBtn.addEventListener('click', openPaymentModal);
            DOMElements.showLoginLink.addEventListener('click', (e) => {
                e.preventDefault();
                toggleAuthForms('login');
            });
            if (DOMElements.showResetLink) DOMElements.showResetLink.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms('reset'); });
            if (DOMElements.showLoginFromResetLink) DOMElements.showLoginFromResetLink.addEventListener('click', (e) => { e.preventDefault(); toggleAuthForms('login'); });

            document.querySelectorAll('input[name="main-payment"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const mobileOptions = document.getElementById('mobile-banking-options');
                    if (e.target.value === 'Mobile Banking') {
                        mobileOptions.classList.remove('hidden');
                        mobileOptions.querySelector('input[value="Bkash"]').checked = true;
                    } else {
                        mobileOptions.classList.add('hidden');
                    }
                });
            });

            DOMElements.searchButton.addEventListener('click', performSearch);
            DOMElements.searchInput.addEventListener('keypress', e => e.key === 'Enter' && performSearch());
            // Live search suggestions
            if (DOMElements.searchInput) DOMElements.searchInput.addEventListener('input', handleSearchSuggestions);
            if (DOMElements.searchInputMobile) DOMElements.searchInputMobile.addEventListener('input', handleSearchSuggestions);
            if (DOMElements.searchButton) DOMElements.searchButton.addEventListener('click', hideSearchResults);
            if (DOMElements.searchButtonMobile) DOMElements.searchButtonMobile.addEventListener('click', hideSearchResults);
            DOMElements.searchButtonMobile.addEventListener('click', performSearch);
            DOMElements.searchInputMobile.addEventListener('keypress', e => e.key === 'Enter' && performSearch());
            // Hide suggestions when clicking outside of search areas
            document.addEventListener('click', (e) => {
                const inDesktop = e.target.closest('#search-input') || e.target.closest('#search-results-desktop') || e.target.closest('#search-button');
                const inMobile = e.target.closest('#search-input-mobile') || e.target.closest('#search-results-mobile') || e.target.closest('#search-button-mobile');
                if (!inDesktop && !inMobile) hideSearchResults();
            });
            
            document.getElementById('hamburger-btn').addEventListener('click', () => openDrawer('nav-drawer'));
            
            document.addEventListener('click', handleProductCardClick); // Delegated click handler
            document.getElementById('product-options').addEventListener('click', handleVariantSelection);
            document.getElementById('product-image-container').addEventListener('mousemove', handleImageZoom);
            
            // Review Form Listeners
            document.getElementById('rating-stars').addEventListener('click', handleStarClick);
            document.getElementById('review-form').addEventListener('submit', submitReview);

            // Language selector interactions
            const langButton = document.getElementById('lang-button');
            const langMenu = document.getElementById('lang-menu');
            const langCurrent = document.getElementById('lang-current');
            if (langButton && langMenu) {
                // Set initial label from stored language
                const currentLang = (() => { try { return localStorage.getItem('lang'); } catch (e) { return null; } })() || 'bn';
                if (langCurrent) langCurrent.textContent = currentLang === 'bn' ? '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ' : 'English';

                langButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    langMenu.classList.toggle('hidden');
                });

                document.querySelectorAll('#lang-menu .lang-option').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const value = e.currentTarget.getAttribute('data-lang-value');
                        setLanguage(value);
                    });
                });

                // Close on outside click
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('#lang-selector')) {
                        langMenu.classList.add('hidden');
                    }
                });
            }

            // --- Invoice Button Delegation ---
            document.addEventListener('click', (e) => {
                const target = e.target.closest('.download-invoice-btn');
                if (target) {
                    const orderId = target.dataset.orderId;
                    downloadInvoice(orderId);
                }
            });
            // --- END Invoice Button Delegation ---

            // --- Wishlist Remove Delegation ---
            document.addEventListener('click', async (e) => {
                const removeBtn = e.target.closest('.remove-from-wishlist');
                if (!removeBtn) return;
                const pid = removeBtn.getAttribute('data-product-id');
                await toggleWishlistInDb(pid);
                updateWishlistUI();
            });
            // --- END Wishlist Remove Delegation ---
            
            const detailsPage = document.getElementById('product-details-page');
            detailsPage.querySelector('#add-to-cart-details').addEventListener('click', (e) => addToCartInDb(e.target.dataset.productId, false));
            detailsPage.querySelector('.buy-now').addEventListener('click', (e) => {
                const productId = detailsPage.querySelector('#add-to-cart-details').dataset.productId;
                // Pre-check variants and guide the user if any required option is missing
                const product = (productsData || []).find(p => p.id === productId);
                const required = product ? getRequiredVariants(product) : [];
                const missing = required.filter(t => !selectedVariants[t]);
                if (missing.length > 0) {
                    showToast('toast-select-variant', false);
                    highlightMissingVariantUI(missing);
                    return;
                }
                addToCartInDb(productId).then(() => {
                   openPaymentModal();
                }).catch(err => {
                   if (String(err || '').toLowerCase().includes('variant')) {
                       showToast('toast-select-variant', false);
                       highlightMissingVariantUI(required);
                   }
                   console.log("Could not proceed to buy now:", err);
                });
            });
            detailsPage.querySelector('#wishlist-details').addEventListener('click', (e) => toggleWishlistInDb(e.target.closest('.wishlist').dataset.productId));

            // Handle return from mock MFS page to create the order now
            try {
                const params = new URLSearchParams(window.location.search);
                const status = (params.get('status') || '').toLowerCase();
                const method = params.get('method') || '';
                const txn = params.get('txn_id') || '';
                const orderHandledKey = txn ? `mock_order_handled_${txn}` : `mock_order_handled_${Date.now()}`;
                if (status === 'success' && !sessionStorage.getItem(orderHandledKey)) {
                    sessionStorage.setItem(orderHandledKey, '1');
                    const ok = await placeOrderFromReturn(method, txn);
                    if (ok && window.history && window.history.replaceState) {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } else if (status === 'failed') {
                    showToast('Payment failed', false);
                    if (window.history && window.history.replaceState) {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }
            } catch (_) {}
        });

        function initializeSlider() {
            const slides = DOMElements.slidesContainer.children;
            if (slides.length === 0) return;
            const slideCount = slides.length;
            let currentSlide = 0;
            let autoSlideInterval;

            DOMElements.indicatorContainer.innerHTML = '';
            
            for(let i = 0; i < slideCount; i++) {
                const indicator = document.createElement('button');
                indicator.className = 'w-3 h-3 rounded-full bg-gray-400 transition-all';
                indicator.addEventListener('click', () => goToSlide(i));
                DOMElements.indicatorContainer.appendChild(indicator);
            }

            const updateSlider = () => {
                DOMElements.slidesContainer.style.transform = `translateX(-${currentSlide * 100}%)`;
                Array.from(DOMElements.indicatorContainer.children).forEach((ind, i) => {
                    ind.classList.toggle('bg-white', i === currentSlide);
                    ind.classList.toggle('bg-gray-400', i !== currentSlide);
                });
            };

            const goToSlide = (slideIndex) => {
                currentSlide = slideIndex;
                updateSlider();
                resetInterval();
            };

            const resetInterval = () => {
                clearInterval(autoSlideInterval);
                autoSlideInterval = setInterval(() => {
                    currentSlide = (currentSlide + 1) % slideCount;
                    updateSlider();
                }, 4000);
            };

            DOMElements.nextBtn.addEventListener('click', () => goToSlide((currentSlide + 1) % slideCount));
            DOMElements.prevBtn.addEventListener('click', () => goToSlide((currentSlide - 1 + slideCount) % slideCount));

            updateSlider();
            resetInterval();
        }
        
    </script>
        <script>
        // Lightweight integration for the mock MFS payment page (mfs_mock.html)
        (function() {
            function parseAmount(text) {
                if (!text) return 0;
                const num = parseFloat(String(text).replace(/[^0-9.]/g, ''));
                return isNaN(num) ? 0 : num;
            }

            function openMockMFS() {
                try {
                    const totalEl = document.getElementById('cart-total');
                    const amount = parseAmount(totalEl ? totalEl.textContent : '');
                    if (!amount || amount <= 0) {
                        if (window.showToast) window.showToast('Amount must be greater than 0', false);
                        return;
                    }
                    // Simple order id for demo; main site can replace with real order id
                    const orderId = '#ORD' + Math.floor(100000 + Math.random() * 900000);
                    const returnUrl = window.location.origin + window.location.pathname; // absolute URL to this page
                    // Build an absolute URL to the mock gateway relative to the current page
                    const target = new URL('admin..html', window.location.href);
                    target.searchParams.set('amount', amount.toFixed(2));
                    target.searchParams.set('order', orderId);
                    target.searchParams.set('return_url', returnUrl);
                    window.location.href = target.toString();
                } catch (e) {
                    console.warn('Failed to open mock MFS page', e);
                }
            }

                    document.addEventListener('DOMContentLoaded', function() {
                // Inject a mock MFS payment button into the payment modal options if present
                try {
                    const opts = document.getElementById('payment-options');
                    if (opts && !document.getElementById('mock-mfs-btn')) {
                        const btn = document.createElement('button');
                        btn.id = 'mock-mfs-btn';
                        btn.type = 'button';
                        btn.className = 'w-full bg-pink-600 text-white py-3 rounded-md font-bold hover:bg-pink-700 transition-colors shadow';
                        btn.textContent = 'Pay with bKash/Nagad (Mock)';
                        btn.addEventListener('click', openMockMFS);
                        opts.appendChild(btn);
                    }
                } catch (e) { console.warn('Mock MFS inject failed', e); }
            });
        })();
        </script>
</body>
</html>